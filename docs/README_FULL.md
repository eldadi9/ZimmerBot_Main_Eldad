# 🏡 מערכת הזמנות אוטומטית לצימרים
### סוכן AI חכם עם שליטה מלאה - מקצה לקצה

<div align="center">

![Version](https://img.shields.io/badge/version-1.0.0-blue.svg)
![Status](https://img.shields.io/badge/status-in_development-yellow.svg)
![License](https://img.shields.io/badge/license-MIT-green.svg)

**מערכת הזמנות מתקדמת ואינטליגנטית לצימרים שמטפלת בכל התהליך באופן אוטומטי**

[תכונות](#-תכונות-ליבה) • [ארכיטקטורה](#️-ארכיטקטורה-טכנית) • [התחלה מהירה](#-התחלה-מהירה) • [תוכנית בנייה](#-תוכנית-בנייה-שלב-אחר-שלב)

</div>

---

## 📋 תוכן עניינים

- [סקירה כללית](#-סקירה-כללית)
- [ערך מוסף](#-ערך-מוסף)
- [מדדי הצלחה (KPI)](#-מדדי-הצלחה-kpi)
- [יכולות המערכת](#️-יכולות-המערכת)
- [ארכיטקטורה טכנית](#️-ארכיטקטורה-טכנית)
- [סטק טכנולוגי](#-סטק-טכנולוגי)
- [תוכנית בנייה שלב אחר שלב](#-תוכנית-בנייה-שלב-אחר-שלב)
- [אבני דרך והגדרות הצלחה](#-אבני-דרך-והגדרות-הצלחה)
- [התחלה מהירה](#-התחלה-מהירה)
- [תובנות קריטיות](#-תובנות-קריטיות)
- [מצב פרויקט](#-מצב-פרויקט-והצעד-הבא)

---

## 🧠 Model

## 💎 ערך מוסף

### ללקוח (האורח)

| ✅ יתרון | 📊 השפעה |
|---------|----------|
| **תשובה מיידית בכל שעה** | זמינות 24/7 ללא המתנה |
| **תהליך הזמנה פשוט ומהיר** | חווית משתמש משופרת |
| **מידע מלא במקום אחד** | תמונות, תיאורים, תשלום |
| **שקיפות מלאה במחירים** | אין הפתעות לא נעימות |

### לבעל הצימר

| ✅ יתרון | 💰 תועלת עסקית |
|---------|----------------|
| **הפחתת שיחות חוזרות** | חיסכון בזמן ומשאבים |
| **מניעת טעויות בזמינות** | אפס דאבל בוקינג |
| **הגדלת הזמנות ישירות** | הכנסה גבוהה יותר |
| **מכירת תוספות וחבילות** | הגדלת ערך עסקה ממוצע (AOV) |
| **אוטומציה מלאה** | פחות עבודה ידנית, יותר בקרה |

---

## 📈 מדדי הצלחה (KPI)

### 🤖 אוטומציה ויעילות

**שיעור אוטומציה = (פניות שנסגרו אוטומטית / כל הפניות) × 100%**  
🎯 **יעד: > 80%**

| מדד | הגדרה | יעד |
|-----|-------|-----|
| **שיעור אוטומציה** | אחוז הפניות שנסגרו ללא התערבות אנושית | > 80% |
| **ירידה בשיחות חוזרות** | השוואה לפני ואחרי המערכת | -50% לפחות |
| **זמן תגובה ממוצע** | זמן תגובה ממוצע לפנייה | < 30 שניות |

### 💰 הכנסות והמרה

| מדד | הגדרה | יעד |
|-----|-------|-----|
| **הזמנות ישירות** | כמות והכנסה מהזמנות דרך המערכת | +30% לפחות |
| **שיעור המרה** | (הזמנות / חיפושים) × 100% | > 15% |
| **הכנסה מתוספות** | הכנסה נוספת מתוספות וחבילות | +20% מהכנסות |

### 😊 שביעות רצון

**ציון שביעות רצון (NPS) = אחוז ממליצים - אחוז מתנגדים**  
🎯 **יעד: > 50**

| מדד | איסוף | יעד |
|-----|--------|-----|
| **שביעות רצון אורח** | סקר אחרי שהות | ציון > 4.5/5 |
| **Net Promoter Score** | שאלה "האם תמליץ?" | NPS > 50 |

---

## 🎖️ אבני דרך והגדרות הצלחה

| אבן דרך | תיאור | סטטוס |
|---------|--------|-------|
| **🏗️ MVP** | מערכת בסיסית עם צ'אט + יומן + תשלום | 🟡 בביצוע |
| **🚀 Beta** | הוספת טלפון + דשבורד + הודעות | ⚪ ממתין |
| **✅ Production** | מערכת מלאה ויציבה עם כל התכונות | ⚪ ממתין |
| **📈 Scale** | אופטימיזציה וביצועים | ⚪ ממתין |

---

## 💡 תובנות קריטיות

### ✅ עשה

- **התחל פשוט** - MVP קודם, תכונות מתקדמות אחר כך
- **בדוק כל שלב** - אל תמשיך לפני שהשלב הנוכחי עובד
- **תעד הכל** - תיעוד טוב חוסך זמן בהמשך
- **חשוב על סקיילביליות** - תכנן מראש לגדילה
- **אבטחה מהיום הראשון** - אל תדחה לאחר כך

### ❌ אל תעשה

- **אל תדלג על שלבים** - זה יחזור לנגוס בך
- **אל תזלזל בטסטים** - טסטים = ביטחון
- **אל תתחיל עם over-engineering** - YAGNI
- **אל תשכח backups** - נתונים = זהב
- **אל תעבוד בלי version control** - Git הוא חובה

---

## 🖥️ View

## 🎯 סקירה כללית

### מה אנחנו בונים?

מערכת הזמנות מתקדמת ואינטליגנטית לצימרים שמטפלת בכל התהליך מקצה לקצה - מהרגע שהאורח פונה ועד לאחר השהות.

### 🎨 תכונות ליבה

| תכונה | תיאור |
|-------|--------|
| 💬 **צ'אט באתר** | ממשק שיחה אינטראקטיבי באתר האינטרנט |
| 📞 **סוכן קולי טלפוני** | שירות אוטומטי 24/7 לטיפול בשיחות |
| 🔍 **חיפוש וסינון חכם** | בדיקת זמינות מתקדמת עם פילטרים מרובים |
| 📅 **ניהול יומן ושריון** | מניעת דאבל בוקינג באמצעות מערכת Hold |
| 💰 **תמחור דינמי** | תמחור גמיש לפי עונות, סופ"ש וחגים |
| 💳 **תשלומים מאובטחים** | אינטגרציה מלאה עם ספקי סליקה + אימות |
| 📨 **הודעות אוטומטיות** | תזכורות והודעות ממוכנות ללקוחות ולבעלים |
| 🚨 **התראות חכמות** | התראות בזמן אמת על שינויים וחריגות |

### 🔑 עיקרון מפתח - ארכיטקטורת MVC + AI Agent

```
┌─────────────────────────────────────────────────┐
│  VIEW (Loveable/React) = שכבה דקה              │
│  רק UI - אין Logic, רק תצוגה ותקשורת          │
│                                                 │
│  CONTROLLER (FastAPI) = לוגיקה עסקית           │
│  AI Agent + Services + Business Rules          │
│                                                 │
│  MODEL (Database) = שכבת נתונים                │
│  כל הנתונים, כל החוקים, כל ההיסטוריה          │
└─────────────────────────────────────────────────┘
```

**הכל מרוכז בשרת ובמסד הנתונים - הממשקים רק מציגים ומעבירים מידע.**

### 🎯 מה הכלי נועד לעשות?

**ZimmerBot = סוכן AI חכם מלא מקצה לקצה**

הכלי נועד להיות **סוכן AI חכם** שמלווה את הלקוח בכל שלבי המסע:

1. **לפני ההזמנה** - חיפוש, שאלות, השוואות, המלצות
2. **תהליך ההזמנה** - הנחיה צעד אחר צעד, תמחור, תשלום
3. **לפני הגעה** - תזכורות, הוראות, פרטי כניסה
4. **במהלך שהות** - תוספות, שאלות, בעיות, מידע על האזור
5. **אחרי עזיבה** - משוב, תודה, הנחות ללקוחות חוזרים
6. **לקוח חוזר** - זיהוי, הנחות, המלצות מותאמות

**הכלי מודולרי** - ניתן להטמיע בכל פלטפורמה:
- אתר אינטרנט (WordPress, Wix, Shopify)
- Facebook Messenger
- Instagram
- WhatsApp
- טלפון (IVR)

**הכלי חכם** - מזהה כוונות, מנהל הקשר, נותן תגובות מותאמות, ומלווה את הלקוח בכל שלב.

---

## 🛠️ יכולות המערכת

### 1️⃣ ערוצים וממשקים

```
┌──────────────┐
│ צ'אט באתר    │ ← עיקרי
├──────────────┤
│ טלפון קולי   │ ← עיקרי
├──────────────┤
│ WhatsApp     │ ← אופציונלי
├──────────────┤
│ העברה לאדם   │ ← במקרים מורכבים
└──────────────┘
```

**מתי מעבירים לאדם?**
- מקרים מורכבים שדורשים החלטה אנושית
- בעיות טכניות או תלונות
- בקשות מיוחדות שאינן סטנדרטיות
- שעות פעילות סבירות בלבד

### 2️⃣ חיפוש וסינון מתקדם

#### קלט מהאורח

```yaml
פרמטרי חיפוש:
  תאריכים:
    - תאריך התחלה
    - תאריך סיום
    - גמישות בתאריכים (±1-3 ימים)
  
  אנשים:
    - מספר מבוגרים (נדרש)
    - מספר ילדים (אופציונלי)
    - גילאי ילדים (לצרכי תמחור)
  
  מיקום:
    - אזור גיאוגרפי
    - מרחק ממרכז עיר
    - קרבה לאטרקציות
  
  תקציב:
    - מחיר מינימום
    - מחיר מקסימום
    - כולל/לא כולל תוספות
  
  מאפיינים:
    - בריכה (פרטית/משותפת)
    - ג'קוזי
    - ארוחת בוקר
    - חניה
    - נגישות לנכים
    - ידידותי לחיות מחמד
```

#### פלט לאורח

```
┌────────────────────────────────────────┐
│ תוצאה 1: צימר רומנטי בגליל            │
│ ────────────────────────────────────   │
│ 💰 מחיר: ₪800/לילה                    │
│ 📷 3 תמונות                           │
│ ✨ בריכה פרטית, ג'קוזי, נוף          │
│ 📍 מרחק: 2 ק"מ ממרכז העיר            │
│                                        │
│ [הצג פרטים] [הזמן עכשיו]              │
└────────────────────────────────────────┘
```

**תכונות חיפוש:**
- המלצה על 2-3 אופציות מתאימות ביותר
- מחיר ברור וסופי (כולל מסים)
- גלריית תמונות איכותית
- תיאור תמציתי ומדויק
- אפשרות לשאול שאלות על כל אופציה
- השוואה בין אופציות

### 3️⃣ זמינות ושריון

#### מנגנון מניעת דאבל בוקינג

```
תרשים זרימה:
    אורח → בדיקת זמינות → יומן
    יומן → צימרים פנויים → מערכת
    מערכת → הצגת אופציות → אורח
    
    אורח → בחירת צימר → מערכת
    מערכת → יצירת Hold (10-20 דק') → יומן + DB
    מערכת → Hold אקטיבי → אורח
    
    אורח → ביצוע תשלום → מערכת
    מערכת → אימות תשלום → DB
    מערכת → הזמנה סופית → יומן
    מערכת → אישור הזמנה → אורח
```

#### שלבי תהליך ההזמנה

| שלב | פעולה | משך זמן | מצב |
|-----|-------|---------|-----|
| **1** | בדיקת זמינות | רגעי | זמין/תפוס |
| **2** | Hold זמני | 10-20 דקות | שמור זמנית |
| **3** | תשלום | עד 20 דקות | בהמתנה לתשלום |
| **4** | אישור סופי | רגעי | מאושר ונעול |

**תכונות נוספות:**
- ✅ בדיקת זמינות בזמן אמת - חיבור ישיר ליומן
- 🔒 Hold זמני - נעילה של 10-20 דקות למניעת דאבל בוקינג
- ⏱️ ניהול תפוגה - שחרור אוטומטי של Hold שתפג
- 💳 נעילה אחרי תשלום - הזמנה נסגרת רק אחרי אישור תשלום
- 🔄 שינוי תאריכים - אפשרות לשינוי לפי מדיניות
- ❌ ביטולים - טיפול בביטולים לפי מדיניות החזרים

### 4️⃣ תמחור ותוספות

#### מנגנון תמחור דינמי

```python
# דוגמה לחישוב מחיר
def calculate_price(cabin, dates, guests, addons):
    base_price = cabin.base_price
    
    # התאמות לפי תאריך
    if is_weekend(dates):
        base_price *= 1.3  # +30% לסופ"ש
    if is_holiday(dates):
        base_price *= 1.5  # +50% לחג
    if is_high_season(dates):
        base_price *= 1.2  # +20% לעונה גבוהה
    
    # תוספות אופציונליות
    for addon in addons:
        base_price += addon.price
    
    # מספר לילות
    nights = calculate_nights(dates)
    total = base_price * nights
    
    # הנחות
    if nights >= 7:
        total *= 0.9  # -10% לשבוע
    
    return total
```

#### סוגי תמחור

| גורם | השפעה | דוגמה |
|------|-------|--------|
| **יום בשבוע** | ×1.0 - ×1.3 | סופ"ש +30% |
| **עונה** | ×1.0 - ×1.5 | קיץ +20%, חגים +50% |
| **משך שהות** | -0% עד -15% | שבוע -10%, חודש -15% |
| **התראה מוקדמת** | -0% עד -20% | הזמנה מראש -20% |

#### תוספות זמינות

```
📋 תוספות בסיסיות:
├── ארוחת בוקר: ₪50 לאדם
├── צ'ק אין מוקדם: ₪100
├── צ'ק אאוט מאוחר: ₪150
├── חדר נוסף: ₪200 ללילה
└── חניה מאובטחת: ₪50 ללילה

🎁 חבילות מיוחדות:
├── רומנטית: לינה + ארוחה + יין + פרחים (₪500)
├── משפחתית: לינה + כניסה לפארק + ארוחת צהריים (₪800)
└── ספא: לינה + טיפול + בריכה מחוממת (₪700)

🎟️ קופונים והנחות:
├── קוד קופון: הנחה של X%
├── לקוח חוזר: -10%
└── הזמנה מוקדמת: -20%
```

### 5️⃣ מערכת תשלומים

#### זרימת תהליך התשלום

```
אורח בוחר צימר
        ↓
מערכת מייצרת חיוב
        ↓
שליחת קישור תשלום / תשלום בתהליך
        ↓
אורח משלם
        ↓
Webhook מספק הסליקה ← אימות תשלום
        ↓
עדכון סטטוס ב-DB
        ↓
נעילת הזמנה ביומן
        ↓
שליחת קבלה + אישור
```

#### תכונות מערכת התשלומים

| תכונה | תיאור |
|-------|--------|
| 💳 **יצירת חיוב** | חיוב מאובטח עם פרטי ההזמנה |
| 🔗 **קישור תשלום** | שליחת קישור נוח למייל/SMS |
| ✅ **אימות Webhook** | אימות אוטומטי של התשלום |
| 🧾 **קבלות** | הפקת קבלה מס אוטומטית |
| 📊 **סטטוס** | מעקב אחר סטטוס התשלום |
| 💸 **החזרים** | ניהול החזרים לפי מדיניות |
| 🔒 **אבטחה** | תקן PCI DSS |

**ספקי סליקה נתמכים:**
- **בינלאומי:** Stripe, PayPal
- **ישראלי:** Tranzila, Cardcom, Yaad Sarig
- אפשרות להוספת ספקים נוספים

### 6️⃣ הודעות אוטומטיות ותזכורות

#### הודעות לאורח

```
מסע ההודעות ללקוח:
════════════════════════════════════════

📧 אישור הזמנה (מיידי)
   └─ פרטי הזמנה מלאים
   └─ קבלה ומספר הזמנה
   └─ מדיניות ביטול

⏰ תזכורת לפני הגעה (3 ימים)
   └─ תזכורת ידידותית
   └─ פרטי קשר של הצימר
   └─ המלצות לאזור

🗺️ הוראות הגעה (יום ההגעה)
   └─ קישור Waze/Google Maps
   └─ הוראות חניה
   └─ פרטי כניסה ומפתחות

🌟 הודעת תודה (אחרי השהות)
   └─ תודה על הביקור
   └─ בקשה לביקורת
   └─ קופון להזמנה הבאה
```

#### הודעות לבעל הצימר

```
מערכת ניהול התראות:
══════════════════════════════════════

🔔 הזמנה חדשה (מיידי)
   └─ פרטי האורח
   └─ תאריכים וסכום
   └─ בקשות מיוחדות

⚠️ ביטול או שינוי (מיידי)
   └─ עדכון על שינוי
   └─ פרטי הביטול/שינוי
   └─ סטטוס החזר כספי

🏠 תזכורת הכנה (יום לפני)
   └─ תזכורת להכין צימר
   └─ רשימת משימות
   └─ פרטי האורח הבא

📊 דוחות ותובנות (שבועי)
   └─ תפוסה
   └─ הכנסות
   └─ ממוצע ביקורות
   └─ התראות על מגמות
```

#### ערוצי שליחה

- 📧 **אימייל** - הודעות מפורטות
- 📱 **SMS** - עדכונים קצרים וחשובים
- 💬 **WhatsApp** - אופציונלי, לתקשורת אינטראקטיבית
- 🔔 **Push Notifications** - באפליקציה/דשבורד

### 7️⃣ ניהול ובקרה

#### דשבורד ניהול מרכזי

```
╔═══════════════════════════════════════════╗
║          דשבורד בעל הצימר                ║
╠═══════════════════════════════════════════╣
║                                           ║
║  📊 סטטיסטיקות היום                      ║
║  ├─ הזמנות חדשות: 3                      ║
║  ├─ הכנסות: ₪2,400                       ║
║  └─ תפוסה: 85%                           ║
║                                           ║
║  📅 הזמנות קרובות                        ║
║  ├─ הגעה היום: 2 צימרים                  ║
║  ├─ יציאה היום: 1 צימר                   ║
║  └─ Hold פעיל: 0                         ║
║                                           ║
║  🎯 KPI חודשי                             ║
║  ├─ תפוסה: 78% (↑5%)                     ║
║  ├─ הכנסות: ₪68,000 (↑12%)               ║
║  ├─ ביקורות: 4.8/5 (↑0.2)                ║
║  └─ שיעור ביטול: 3% (↓2%)                ║
║                                           ║
╚═══════════════════════════════════════════╝
```

#### תכונות ניהול

| תכונה | תיאור |
|-------|--------|
| 📋 **ניהול הזמנות** | צפייה, עריכה וביטול הזמנות |
| 📅 **תצוגת לוח שנה** | ויזואליזציה של תפוסה |
| 💰 **דוחות כספיים** | דוחות הכנסות והוצאות |
| 📊 **ניתוח KPI** | מעקב אחר מדדי ביצועים |
| 🔍 **לוג פעולות** | מי עשה מה ומתי |
| 👥 **ניהול משתמשים** | הרשאות ותפקידים |
| 📈 **תחזיות** | תחזית תפוסה והכנסות |

#### הרשאות משתמשים

```yaml
תפקידים במערכת:
  
  בעלים (Owner):
    - גישה מלאה לכל המערכת
    - ניהול משתמשים והרשאות
    - עריכת הגדרות ותמחור
    - צפייה בכל הדוחות
  
  מנהל (Manager):
    - ניהול הזמנות
    - עדכון זמינות
    - תקשורת עם לקוחות
    - צפייה ברוב הדוחות
  
  נציג (Agent):
    - צפייה בהזמנות
    - תקשורת בסיסית
    - עדכון סטטוסים
    - דוחות מוגבלים
  
  מנקה (Cleaner):
    - רשימת משימות ניקיון
    - עדכון סטטוס נקי/לא נקי
    - הודעות על בעיות
```

---

## 🎛️ Controller

## 🏗️ ארכיטקטורה טכנית - MVC + AI Agent חכם

### 📐 סקירת הארכיטקטורה הנוכחית

**מבנה נוכחי (לפני הפרדת MVC מלאה):**

```
ZimmerBot_Main_Eldad/
├── src/
│   ├── api_server.py      # FastAPI - Controller + Routes (מעורב)
│   ├── main.py            # Calendar/Sheets Logic
│   ├── db.py              # Database - Model Layer (חלקי)
│   ├── pricing.py         # Pricing Logic
│   ├── hold.py           # Hold Manager
│   ├── payment.py        # Payment Manager
│   └── email_service.py  # Email Service
├── tools/
│   └── features_picker.html  # Frontend (VIEW) - לא מופרד, מעורב עם Logic
├── database/
│   └── schema.sql        # Database Schema
└── docs/
```

**בעיות במבנה הנוכחי:**
- ❌ אין הפרדה ברורה בין Model, View, Controller
- ❌ ה-View (HTML) מעורב עם Business Logic
- ❌ אין שכבת AI Agent נפרדת
- ❌ לא מודולרי - קשה להטמיע באתרים אחרים
- ❌ קשה לתחזק ולהרחיב

---

### 🎯 מבנה MVC מומלץ - ארכיטקטורה עתידית

**מבנה מוצע (לאחר הפרדת MVC):**

```
ZimmerBot/
├── backend/                    # Backend API (FastAPI)
│   ├── models/                # MODEL - Data Layer
│   │   ├── cabin.py           # Cabin Model (Pydantic/SQLAlchemy)
│   │   ├── booking.py         # Booking Model
│   │   ├── customer.py        # Customer Model
│   │   ├── transaction.py     # Transaction Model
│   │   └── pricing_rule.py    # Pricing Rule Model
│   │
│   ├── controllers/           # CONTROLLER - Business Logic
│   │   ├── booking_controller.py      # לוגיקה של הזמנות
│   │   ├── availability_controller.py # לוגיקה של זמינות
│   │   ├── pricing_controller.py      # לוגיקה של תמחור
│   │   ├── payment_controller.py      # לוגיקה של תשלומים
│   │   ├── hold_controller.py         # לוגיקה של Holds
│   │   └── chat_controller.py          # לוגיקה של צ'אט (AI)
│   │
│   ├── services/             # Services Layer (Business Services)
│   │   ├── calendar_service.py        # שירות יומן
│   │   ├── email_service.py           # שירות אימייל
│   │   ├── payment_service.py         # שירות תשלומים
│   │   └── notification_service.py    # שירות התראות
│   │
│   ├── ai_agent/              # 🧠 AI Agent Layer (חדש!)
│   │   ├── agent_core.py              # Core AI Agent - הלב של הסוכן
│   │   ├── intent_classifier.py       # זיהוי כוונות - מה הלקוח רוצה?
│   │   ├── context_manager.py         # ניהול הקשר - זיכרון השיחה
│   │   ├── response_generator.py      # יצירת תגובות - תשובות חכמות
│   │   ├── knowledge_base.py          # בסיס ידע - מידע על צימרים, אזורים
│   │   └── conversation_flow.py       # זרימת שיחה - State Machine
│   │
│   ├── api/                   # API Routes (FastAPI Endpoints)
│   │   ├── routes/
│   │   │   ├── booking_routes.py      # /book, /bookings
│   │   │   ├── availability_routes.py  # /availability
│   │   │   ├── pricing_routes.py       # /quote
│   │   │   ├── chat_routes.py          # /chat (AI Chat API)
│   │   │   └── admin_routes.py        # /admin/*
│   │   └── main.py            # FastAPI App (Entry Point)
│   │
│   └── database/              # Database Layer
│       ├── connection.py      # חיבור ל-DB
│       ├── repositories/      # Repository Pattern
│       │   ├── cabin_repository.py     # CRUD לצימרים
│       │   ├── booking_repository.py  # CRUD להזמנות
│       │   └── customer_repository.py  # CRUD ללקוחות
│       └── migrations/        # Database Migrations
│
├── frontend/                  # VIEW - Loveable/React/Vue
│   ├── web/                   # Web Widget (Loveable)
│   │   ├── components/
│   │   │   ├── ChatWidget.tsx         # ווידג'ט צ'אט
│   │   │   ├── BookingForm.tsx        # טופס הזמנה
│   │   │   ├── AvailabilityCalendar.tsx # לוח שנה זמינות
│   │   │   └── PaymentModal.tsx        # מודל תשלום
│   │   ├── hooks/
│   │   │   ├── useChat.ts             # Hook לצ'אט
│   │   │   ├── useBooking.ts          # Hook להזמנות
│   │   │   └── useAvailability.ts     # Hook לזמינות
│   │   └── index.ts           # Entry point
│   │
│   ├── facebook/             # Facebook Messenger Bot
│   │   └── messenger_bot.ts
│   │
│   ├── instagram/            # Instagram Bot
│   │   └── instagram_bot.ts
│   │
│   └── whatsapp/             # WhatsApp Business API
│       └── whatsapp_bot.ts
│
├── shared/                    # Shared Code
│   ├── types/                 # TypeScript Types
│   ├── constants/            # Constants
│   └── utils/                # Utilities
│
└── plugins/                   # 🎯 Addon/Plugin System
    ├── wordpress/
    │   └── zimmerbot-plugin.php
    ├── shopify/
    │   └── zimmerbot-app/
    └── wix/
        └── zimmerbot-widget/
```

---

### 🎨 שילוב עם Loveable (VIEW Layer)

**Loveable = VIEW Layer בלבד - רק UI, אין Logic**

```
┌─────────────────────────────────────────────────┐
│              VIEW (Loveable)                     │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐      │
│  │  Web     │  │ Facebook │  │ Instagram│      │
│  │  Widget  │  │ Messenger│  │   Bot    │      │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘      │
└───────┼─────────────┼─────────────┼────────────┘
        │             │             │
        └─────────────┴─────────────┘
                      │
        ┌─────────────▼─────────────┐
        │   API Gateway (FastAPI)   │
        │      CONTROLLER Layer      │
        │  ┌──────────────────────┐ │
        │  │  AI Agent Core       │ │
        │  │  Business Logic      │ │
        │  │  Services            │ │
        │  └──────────────────────┘ │
        └─────────────┬─────────────┘
                      │
        ┌─────────────▼─────────────┐
        │   Database (PostgreSQL)   │
        │      MODEL Layer           │
        │  ┌──────────────────────┐ │
        │  │  Repositories        │ │
        │  │  Data Models         │ │
        │  └──────────────────────┘ │
        └───────────────────────────┘
```

**זרימת נתונים:**

1. **VIEW (Loveable)** - משתמש כותב הודעה
2. **API Gateway** - `POST /api/chat` עם ההודעה
3. **CONTROLLER** - `ChatController.handle_message()`
4. **AI Agent** - עיבוד ההודעה, זיהוי כוונה, יצירת תגובה
5. **Services** - קריאה לשירותים (Availability, Pricing, etc.)
6. **MODEL** - קריאה ל-Repositories
7. **Database** - שאילתות SQL
8. **Response Chain** - חזרה דרך כל השכבות ל-VIEW

**דוגמת קוד - VIEW (Loveable):**

```typescript
// VIEW (Loveable) - רק UI, אין Logic
// frontend/web/components/ChatWidget.tsx

import { useChat } from '../hooks/useChat';

export function ChatWidget() {
  const { messages, sendMessage, isLoading } = useChat();
  
  return (
    <div className="chat-widget">
      {messages.map(msg => (
        <Message key={msg.id} message={msg} />
      ))}
      <Input 
        onSend={sendMessage} 
        disabled={isLoading}
      />
    </div>
  );
}

// Hook - תקשורת עם API
// frontend/web/hooks/useChat.ts

export function useChat() {
  const [messages, setMessages] = useState([]);
  
  const sendMessage = async (text: string) => {
    const response = await fetch('/api/chat', {
      method: 'POST',
      body: JSON.stringify({ message: text })
    });
    const data = await response.json();
    setMessages(prev => [...prev, data]);
  };
  
  return { messages, sendMessage, isLoading };
}
```

**דוגמת קוד - CONTROLLER (FastAPI):**

```python
# CONTROLLER (FastAPI) - Business Logic
# backend/api/routes/chat_routes.py

from backend.ai_agent.agent_core import AIAgent

@app.post("/api/chat")
async def chat(request: ChatRequest):
    # AI Agent מטפל בהודעה
    agent = AIAgent()
    response = await agent.process_message(
        message=request.message,
        session_id=request.session_id,
        context=request.context
    )
    
    return ChatResponse(
        message=response.text,
        intent=response.intent,
        actions=response.actions
    )
```

---

### 🧠 סוכן AI חכם - ארכיטקטורה מפורטת

**הסוכן החכם מטפל בכל השלבים:**

#### 1. לפני ההזמנה
- חיפוש צימרים לפי תאריכים, תכונות, תקציב
- שאלות על צימרים ספציפיים
- השוואה בין צימרים
- המלצות מותאמות אישית
- תמחור מפורט

#### 2. תהליך ההזמנה
- הנחיה צעד אחר צעד
- איסוף פרטים (שם, טלפון, אימייל)
- בחירת תוספות
- תמחור סופי
- הנחיה בתשלום

#### 3. לפני הגעה
- תזכורות (יומיים לפני)
- הוראות הגעה
- פרטי כניסה
- קישורי Waze/Google Maps
- מידע על האזור

#### 4. במהלך שהות
- הזמנת תוספות (ארוחת בוקר, עיסוי, etc.)
- שאלות על הצימר
- דיווח על בעיות
- מידע על אטרקציות באזור
- בקשות שירות

#### 5. אחרי עזיבה
- הודעת תודה
- בקשה לביקורת
- קופון להזמנה הבאה
- המלצות על צימרים אחרים

#### 6. לקוח חוזר
- זיהוי אוטומטי
- הנחות מיוחדות
- המלצות מותאמות
- היסטוריית הזמנות

**מבנה הסוכן החכם:**

```python
# backend/ai_agent/agent_core.py

class AIAgent:
    """
    סוכן AI חכם שמטפל בכל השלבים
    """
    
    def __init__(self):
        self.intent_classifier = IntentClassifier()      # זיהוי כוונות
        self.context_manager = ContextManager()          # ניהול הקשר
        self.response_generator = ResponseGenerator()    # יצירת תגובות
        self.knowledge_base = KnowledgeBase()            # בסיס ידע
        self.conversation_flow = ConversationFlow()      # זרימת שיחה
    
    async def process_message(
        self, 
        message: str, 
        session_id: str,
        context: Optional[Dict] = None
    ) -> AgentResponse:
        """
        עיבוד הודעה - זיהוי כוונה, הקשר, ותגובה
        """
        # 1. זיהוי כוונה
        intent = await self.intent_classifier.classify(message)
        
        # 2. ניהול הקשר
        context = await self.context_manager.update(
            session_id=session_id,
            intent=intent,
            message=message,
            previous_context=context
        )
        
        # 3. קבלת מידע מבסיס הידע
        knowledge = await self.knowledge_base.get_relevant_info(
            intent=intent,
            context=context
        )
        
        # 4. יצירת תגובה
        response = await self.response_generator.generate(
            intent=intent,
            context=context,
            knowledge=knowledge,
            message=message
        )
        
        # 5. זרימת שיחה (state machine)
        next_actions = await self.conversation_flow.get_next_actions(
            current_state=context.state,
            intent=intent
        )
        
        return AgentResponse(
            text=response.text,
            intent=intent,
            actions=next_actions,
            context=context,
            metadata=response.metadata
        )
```

**זרימת שיחה - State Machine:**

```python
# backend/ai_agent/conversation_flow.py

STATES = {
    'GREETING': 'ברכה ראשונית',
    'SEARCHING': 'חיפוש צימר',
    'VIEWING_OPTIONS': 'צפייה באופציות',
    'BOOKING': 'תהליך הזמנה',
    'PAYMENT': 'תשלום',
    'CONFIRMED': 'הזמנה מאושרת',
    'PRE_ARRIVAL': 'לפני הגעה',
    'DURING_STAY': 'במהלך שהות',
    'POST_STAY': 'אחרי עזיבה',
    'RETURNING_CUSTOMER': 'לקוח חוזר'
}

TRANSITIONS = {
    'GREETING': ['SEARCHING', 'VIEWING_OPTIONS'],
    'SEARCHING': ['VIEWING_OPTIONS', 'BOOKING'],
    'VIEWING_OPTIONS': ['BOOKING', 'SEARCHING'],
    'BOOKING': ['PAYMENT', 'CONFIRMED'],
    'PAYMENT': ['CONFIRMED'],
    'CONFIRMED': ['PRE_ARRIVAL'],
    'PRE_ARRIVAL': ['DURING_STAY'],
    'DURING_STAY': ['POST_STAY'],
    'POST_STAY': ['RETURNING_CUSTOMER'],
    'RETURNING_CUSTOMER': ['SEARCHING', 'BOOKING']
}
```

**זיהוי כוונות (Intent Classification):**

```python
# backend/ai_agent/intent_classifier.py

class IntentClassifier:
    """
    זיהוי כוונות - מה הלקוח רוצה?
    """
    
    INTENTS = {
        # לפני הזמנה
        'SEARCH_AVAILABILITY': 'חיפוש זמינות',
        'ASK_ABOUT_CABIN': 'שאלה על צימר',
        'COMPARE_CABINS': 'השוואה בין צימרים',
        'GET_PRICING': 'בקשת מחיר',
        'ASK_FEATURES': 'שאלה על תכונות',
        
        # תהליך הזמנה
        'START_BOOKING': 'התחלת הזמנה',
        'PROVIDE_DETAILS': 'מסירת פרטים',
        'ASK_BOOKING_STATUS': 'בדיקת סטטוס הזמנה',
        
        # במהלך שהות
        'REQUEST_SERVICE': 'בקשת שירות',
        'REPORT_ISSUE': 'דיווח על בעיה',
        'ASK_LOCAL_INFO': 'שאלה על האזור',
        'ORDER_ADDON': 'הזמנת תוספת',
        
        # אחרי עזיבה
        'LEAVE_REVIEW': 'השארת ביקורת',
        'ASK_RECOMMENDATION': 'בקשת המלצה',
        
        # כללי
        'GREETING': 'ברכה',
        'GOODBYE': 'פרידה',
        'THANK_YOU': 'תודה',
        'HELP': 'בקשת עזרה'
    }
    
    async def classify(self, message: str) -> str:
        """
        זיהוי כוונה מהודעה
        """
        # שימוש ב-LLM (OpenAI/Anthropic) או ML Model
        # או rule-based + embeddings
        ...
```

---

### 🎯 מודולריות - Addon לכל פלטפורמה

**הכלי מודולרי - ניתן להטמיע בכל פלטפורמה:**

#### 1. Web Widget (Loveable)
```html
<div id="zimmerbot-widget"></div>
<script src="https://cdn.zimmerbot.com/widget.js"></script>
<script>
  ZimmerBot.init({
    containerId: 'zimmerbot-widget',
    apiUrl: 'https://api.zimmerbot.com'
  });
</script>
```

#### 2. WordPress Plugin
```php
// WordPress Plugin - פשוט להטמעה
[zimmerbot_chat]
```

#### 3. Facebook Messenger
```typescript
// Facebook Messenger Bot
// Webhook handler אוטומטי
```

#### 4. Instagram Bot
```typescript
// Instagram Bot
// Webhook handler אוטומטי
```

#### 5. WhatsApp Business
```typescript
// WhatsApp Business API
// Webhook handler אוטומטי
```

**ארכיטקטורת Plugin:**

```typescript
// shared/types/plugin.ts

export interface ZimmerBotPlugin {
  platform: 'web' | 'facebook' | 'instagram' | 'whatsapp' | 'wordpress' | 'shopify';
  init(config: PluginConfig): Promise<void>;
  handleMessage(message: IncomingMessage): Promise<OutgoingMessage>;
  getUIComponents?(): React.ComponentType[];
  handleWebhook?(payload: any): Promise<any>;
}
```

---

### 📊 תכנית יישום - שלבים מפורטים

#### שלב 1: הפרדת MVC (2-3 ימים) ⏳ **בתהליך**

**מה נעשה עד כה:**
- ✅ יש Backend API (FastAPI)
- ✅ יש Database Layer (db.py)
- ✅ יש Services (email_service, payment, etc.)
- ⏳ אין הפרדה ברורה ל-Models/Controllers
- ⏳ ה-View מעורב עם Logic

**מה צריך לעשות:**
1. יצירת מבנה תיקיות חדש:
   ```
   backend/
   ├── models/
   ├── controllers/
   ├── services/
   └── api/
   ```

2. העברת קוד קיים:
   - `src/db.py` → `backend/models/` + `backend/database/repositories/`
   - `src/api_server.py` → `backend/controllers/` + `backend/api/routes/`
   - `src/pricing.py` → `backend/controllers/pricing_controller.py`
   - `src/hold.py` → `backend/controllers/hold_controller.py`
   - `src/payment.py` → `backend/services/payment_service.py`
   - `src/email_service.py` → `backend/services/email_service.py`

3. הפרדת View:
   - `tools/features_picker.html` → `frontend/web/components/` (React)

4. יצירת API Gateway:
   - `backend/api/main.py` - FastAPI App מרכזי

**Definition of Done:**
- [ ] כל הקוד מאורגן ב-Models, Controllers, Views
- [ ] אין Logic ב-View
- [ ] API Gateway עובד
- [ ] בדיקות עוברות

---

#### שלב 2: AI Agent Core (5-7 ימים) ❌ **לא התחיל**

**מה צריך לעשות:**
1. יצירת `AIAgent` class:
   - `backend/ai_agent/agent_core.py`

2. יצירת `IntentClassifier`:
   - `backend/ai_agent/intent_classifier.py`
   - זיהוי כוונות: SEARCH_AVAILABILITY, ASK_ABOUT_CABIN, START_BOOKING, etc.

3. יצירת `ContextManager`:
   - `backend/ai_agent/context_manager.py`
   - ניהול הקשר השיחה, State Machine

4. יצירת `ResponseGenerator`:
   - `backend/ai_agent/response_generator.py`
   - יצירת תגובות חכמות לפי Intent ו-Context

5. יצירת `KnowledgeBase`:
   - `backend/ai_agent/knowledge_base.py`
   - בסיס ידע על צימרים, אזורים, תכונות

6. יצירת `ConversationFlow`:
   - `backend/ai_agent/conversation_flow.py`
   - State Machine לזרימת שיחה

7. יצירת Chat API:
   - `backend/api/routes/chat_routes.py`
   - `POST /api/chat` endpoint

**Definition of Done:**
- [ ] AI Agent מזהה כוונות
- [ ] ניהול הקשר עובד
- [ ] תגובות חכמות
- [ ] זרימת שיחה עובדת
- [ ] Chat API עובד

---

#### שלב 3: View Layer (Loveable) (3-5 ימים) ❌ **לא התחיל**

**מה צריך לעשות:**
1. יצירת React Components ב-Loveable:
   - `frontend/web/components/ChatWidget.tsx`
   - `frontend/web/components/BookingForm.tsx`
   - `frontend/web/components/AvailabilityCalendar.tsx`
   - `frontend/web/components/PaymentModal.tsx`

2. יצירת Hooks:
   - `frontend/web/hooks/useChat.ts`
   - `frontend/web/hooks/useBooking.ts`
   - `frontend/web/hooks/useAvailability.ts`

3. אינטגרציה עם Backend API:
   - חיבור ל-`/api/chat`
   - חיבור ל-`/api/availability`
   - חיבור ל-`/api/book`

4. UI/UX מעולה:
   - עיצוב מודרני
   - RTL support
   - Responsive

**Definition of Done:**
- [ ] React Components ב-Loveable
- [ ] Chat Widget עובד
- [ ] אינטגרציה עם Backend
- [ ] UI/UX מעולה

---

#### שלב 4: Plugin System (4-6 ימים) ❌ **לא התחיל**

**מה צריך לעשות:**
1. יצירת Plugin Interface:
   - `shared/types/plugin.ts`

2. יצירת Web Plugin:
   - `plugins/web/index.ts`

3. יצירת Facebook Plugin:
   - `plugins/facebook/messenger_bot.ts`

4. יצירת WordPress Plugin:
   - `plugins/wordpress/zimmerbot-plugin.php`

5. יצירת Shopify App:
   - `plugins/shopify/zimmerbot-app/`

**Definition of Done:**
- [ ] Web Plugin עובד
- [ ] Facebook Plugin עובד
- [ ] WordPress Plugin עובד
- [ ] תיעוד מלא

---

### 🔄 זרימת עבודה מלאה - דוגמה

**לקוח מחפש צימר:**

```
1. VIEW (Loveable)
   └─> משתמש כותב: "אני מחפש צימר לסופ"ש"
   
2. API Gateway (FastAPI)
   └─> POST /api/chat
       {
         "message": "אני מחפש צימר לסופ"ש",
         "session_id": "abc123"
       }
   
3. CONTROLLER
   └─> ChatController.handle_message()
   
4. AI Agent
   ├─> IntentClassifier: "SEARCH_AVAILABILITY"
   ├─> ContextManager: State = "SEARCHING"
   ├─> KnowledgeBase: קבלת צימרים זמינים
   └─> ResponseGenerator: "מצאתי 3 צימרים זמינים..."
   
5. Services
   └─> AvailabilityService.check_availability()
   
6. Models
   └─> CabinRepository.get_available_cabins()
   
7. Database
   └─> SELECT * FROM cabins WHERE ...
   
8. Response Chain (הפוך)
   └─> VIEW מציג: "מצאתי 3 צימרים זמינים..."
```

---

### סקירת שכבות המערכת

```
┌─────────────────────────────────────────────────┐
│              CHANNELS (ערוצים)                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐      │
│  │   צ'אט   │  │  טלפון   │  │ WhatsApp │      │
│  │  באתר    │  │   קולי   │  │(optional)│      │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘      │
└───────┼─────────────┼─────────────┼────────────┘
        │             │             │
        └─────────────┴─────────────┘
                      │
┌─────────────────────▼─────────────────────────┐
│            BACKEND (שרת יישומים)              │
│  ┌────────────────────────────────────────┐   │
│  │  ▸ לוגיקה עסקית                       │   │
│  │  ▸ ניהול הזמנות                       │   │
│  │  ▸ בדיקת זמינות                       │   │
│  │  ▸ חישוב מחירים                       │   │
│  │  ▸ ניהול תשלומים                      │   │
│  └────────────────────────────────────────┘   │
└───────┬───────┬───────┬───────┬──────┬────────┘
        │       │       │       │      │
   ┌────▼──┐ ┌──▼──┐ ┌──▼──┐ ┌──▼──┐ ┌▼─────┐
   │  DB   │ │ CAL │ │REDIS│ │ PAY │ │NOTIFY│
   │       │ │     │ │     │ │     │ │      │
   │Postgres│ │G.Cal│ │Cache│ │Stripe│ │Email│
   └───────┘ └─────┘ └─────┘ └─────┘ └──────┘
```

### רכיבי המערכת

#### 1. Channels (ערוצים)
- **צ'אט באתר** - ממשק Web בזמן אמת
- **טלפון** - סוכן קולי IVR
- **WhatsApp** - אופציונלי, API עסקי

#### 2. Backend (שרת יישומים)
- **API Server** - REST/GraphQL endpoints
- **Business Logic** - כללי עסק ותהליכים
- **Integration Layer** - חיבור לשירותים חיצוניים

#### 3. Database (מסד נתונים)
- **Cabins** - מידע על צימרים
- **Bookings** - הזמנות ושריונים
- **Customers** - פרטי לקוחות
- **Prices** - תמחור ומבצעים
- **Transactions** - תשלומים

#### 4. Calendar (יומן)
- **Google Calendar** - יומן נפרד לכל צימר
- **Availability** - מקור אמת לזמינות
- **Events** - הזמנות בפועל

#### 5. Redis (Cache & Locks)
- **Hold Management** - נעילות זמניות
- **Session Storage** - סשנים פעילים
- **Rate Limiting** - הגבלת קצב

#### 6. Payments (תשלומים)
- **Payment Gateway** - Stripe/Tranzila
- **Webhooks** - אימות תשלומים
- **Refunds** - החזרים

#### 7. Notifications (התראות)
- **Email** - SendGrid/AWS SES
- **SMS** - Twilio/Infobip
- **Queue** - תור הודעות אסינכרוני

### זרימת עבודה בסיסית

```
אורח נכנס לצ'אט/טלפון
          │
          ▼
    Backend מקבל בקשה
          │
          ▼
    בדיקת זמינות ביומן + DB
          │
          ▼
    חישוב מחירים (Pricing Engine)
          │
          ▼
    החזרת 2-3 אופציות לאורח
          │
          ▼
    אורח בוחר צימר
          │
          ▼
    Hold זמני ב-Redis + Calendar
          │
          ▼
    אורח מבצע תשלום
          │
          ▼
    Webhook מאשר תשלום
          │
          ▼
    נעילה סופית ב-DB + Calendar
          │
          ▼
    שליחת הודעות אישור
```

---

## 💻 סטק טכנולוגי

### Backend Framework

#### אופציה 1: FastAPI (Python) ⭐ מומלץ

```python
✅ יתרונות:
  - מהיר ואסינכרוני
  - TypeHinting מובנה
  - תיעוד API אוטומטי
  - קל ללמידה
  - אקוסיסטם עשיר

📦 Stack מומלץ:
  - FastAPI + Pydantic
  - SQLAlchemy (ORM)
  - Celery (Tasks)
  - Redis (Cache)
```

#### אופציה 2: Node.js + NestJS

```javascript
✅ יתרונות:
  - אקוסיסטם ענק (npm)
  - ביצועים מצוינים
  - קהילה גדולה
  - TypeScript support

📦 Stack מומלץ:
  - NestJS + TypeORM
  - BullMQ (Tasks)
  - Redis (Cache)
```

### מסד נתונים

#### PostgreSQL 15+ ⭐ מומלץ

```sql
✅ למה PostgreSQL?
  ✓ יציב ומהימן
  ✓ תמיכה ב-JSONB
  ✓ Transactions חזקים
  ✓ Full-text search
  ✓ קהילה ותמיכה מצוינת
  ✓ חינמי לחלוטין

טבלאות עיקריות:
  - cabins          -- צימרים
  - bookings        -- הזמנות
  - customers       -- לקוחות
  - pricing_rules   -- כללי תמחור
  - transactions    -- תשלומים
  - notifications   -- הודעות
  - audit_log       -- לוג פעולות
```

### Cache & Locks

#### Redis 7+

```
🎯 שימושים:
  ├─ Hold management (נעילות זמניות)
  ├─ Session storage (סשנים)
  ├─ Rate limiting (הגבלת קצב)
  ├─ Cache (מטמון)
  └─ Queue (תור משימות)

⚙️ הגדרות מומלצות:
  - Persistence: RDB + AOF
  - Max memory policy: allkeys-lru
  - Timeout: בהתאם לצורך
```

### Tasks & Automation

```yaml
# אופציה 1: Celery (Python) ⭐ מומלץ
תזמון משימות:
  - תזכורות
  - דוחות תקופתיים
  - ניקוי Hold שתפגו
  - שליחת הודעות
  - עדכון סטטיסטיקות

# אופציה 2: BullMQ (Node.js)
תזמון משימות:
  - כנ"ל
  - ממשק ניהול מובנה
  - Retry logic
  - Priority queues
```

### Calendar Integration

#### Google Calendar API v3

```javascript
🗓️ ארכיטקטורה:
  - יומן נפרד לכל צימר
  - שם ברור: "Cabin 1 - Romantic"
  - צבע שונה לכל סטטוס
  - סנכרון דו-כיווני

📋 סטטוסים:
  ├─ HOLD (צהוב) - שריון זמני
  ├─ CONFIRMED (ירוק) - אושר ושולם
  ├─ CANCELLED (אדום) - בוטל
  └─ MAINTENANCE (אפור) - תחזוקה

🔐 הרשאות:
  - Service Account עם גישה מלאה
  - OAuth2 לחיבור משתמשים
```

### Payment Processing

```
אופציות סליקה:
════════════════

🌍 בינלאומי:
┌─────────────────────────────┐
│ Stripe ⭐ מומלץ              │
│ ✓ API מצוינת                │
│ ✓ Webhooks אמינים           │
│ ✓ תיעוד מעולה               │
│ ✓ Dashboard נוח              │
└─────────────────────────────┘

🇮🇱 ישראלי:
┌─────────────────────────────┐
│ Tranzila / Cardcom / Yaad   │
│ ✓ תמיכה בעברית              │
│ ✓ שקלים                     │
│ ✓ אישורים ישראלים           │
└─────────────────────────────┘

🔔 Webhooks חובה:
  - payment.succeeded
  - payment.failed
  - refund.created
```

### Telephony

#### Twilio Voice

```
📞 יכולות:
  ├─ IVR מתקדם
  ├─ Speech-to-Text
  ├─ Text-to-Speech בעברית
  ├─ הקלטת שיחות
  └─ ניתוב חכם

🎤 זרימת שיחה:
  1. ברוכים הבאים
  2. זיהוי כוונה (NLU)
  3. איסוף פרטים
  4. בדיקת זמינות
  5. אישור הזמנה
  6. העברה לאדם במידת הצורך
```

### Workflow Automation

#### n8n / Make (Integromat)

```
🔄 אוטומציות:
  ├─ שליחת הודעות
  ├─ עדכון CRM
  ├─ סנכרון נתונים
  ├─ דוחות אוטומטיים
  └─ אינטגרציות צד ג'

💡 יתרונות:
  ✓ Low-code / No-code
  ✓ ויזואלי וקל לתחזוקה
  ✓ מאות אינטגרציות
  ✓ Self-hosted אופציה
```

---

## 🚀 תוכנית בנייה שלב אחר שלב

> **עקרון זהב:** לא מדלגים על שלבים. כל שלב חייב להיבדק ולעבוד לפני המעבר הבא.

### 📘 שלב 1: מודל נתונים (Database Schema)

**⏱️ זמן משוער:** 2-3 ימים  
**🎯 מטרה:** יצירת מסד נתונים מוצק ומדויק

#### משימות

```sql
-- טבלה: cabins (צימרים)
CREATE TABLE cabins (
    id UUID PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    area VARCHAR(50),
    max_adults INT,
    max_kids INT,
    features JSONB,
    base_price_night DECIMAL(10,2),
    weekend_price DECIMAL(10,2),
    images_urls TEXT[],
    calendar_id VARCHAR(255) UNIQUE,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

-- טבלה: bookings (הזמנות)
CREATE TABLE bookings (
    id UUID PRIMARY KEY,
    cabin_id UUID REFERENCES cabins(id),
    customer_id UUID REFERENCES customers(id),
    check_in DATE NOT NULL,
    check_out DATE NOT NULL,
    adults INT,
    kids INT,
    status VARCHAR(20), -- hold, confirmed, cancelled
    total_price DECIMAL(10,2),
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

-- טבלה: customers (לקוחות)
CREATE TABLE customers (
    id UUID PRIMARY KEY,
    name VARCHAR(100),
    email VARCHAR(100) UNIQUE,
    phone VARCHAR(20),
    created_at TIMESTAMP
);

-- טבלאות נוספות: pricing_rules, transactions, notifications, audit_log
```

#### Definition of Done

- [ ] כל הטבלאות נוצרו
- [ ] קשרים (Relations) מוגדרים
- [ ] Indexes על שדות חיפוש
- [ ] Constraints מוגדרים
- [ ] נתוני דמה הוכנסו והוצאו בהצלחה

#### איך לבדוק את שלב 1?

**1. התקן חבילות נדרשות:**
```bash
pip install psycopg2-binary python-dotenv
```

**2. הגדר משתני סביבה (צור קובץ `.env`):**
```env
DB_HOST=localhost
DB_PORT=5432
DB_NAME=zimmerbot_db
DB_USER=postgres
DB_PASSWORD=postgres
```

**3. צור את מסד הנתונים:**
```bash
psql -U postgres
CREATE DATABASE zimmerbot_db;
\q
```

**4. הרץ את סקריפט ה-SQL:**
```bash
psql -U postgres -d zimmerbot_db -f database/schema.sql
```

**5. הרץ את סקריפט הבדיקה:**
```bash
# Windows
database\run_check.bat

# Linux/Mac
chmod +x database/run_check.sh
./database/run_check.sh

# או ישירות:
python database/check_stage1.py
```

📖 **לפרטים נוספים:** ראה `database/README.md`

---

### 📅 שלב 2: חיבור ליומן וזמינות

**⏱️ זמן משוער:** 3-4 ימים  
**🎯 מטרה:** קריאה וכתיבה ליומן Google Calendar

#### משימות

**1. יצירת Service Account ב-Google Cloud**

```bash
1. יצירת פרויקט ב-Google Cloud Console
2. הפעלת Google Calendar API
3. יצירת Service Account
4. הורדת credentials.json
```

**2. יצירת יומנים**

```javascript
// צור יומן לכל צימר
for (let cabin of cabins) {
    const calendar = await createCalendar({
        summary: `Cabin ${cabin.id} - ${cabin.name}`,
        timeZone: 'Asia/Jerusalem'
    });
    
    // שמור calendar_id ב-DB
    await updateCabin(cabin.id, { 
        calendar_id: calendar.id 
    });
}
```

**3. בדיקת זמינות**

```javascript
async function checkAvailability(cabinId, checkIn, checkOut) {
    const calendar = await getCalendarForCabin(cabinId);
    
    const events = await calendar.events.list({
        calendarId: calendar.id,
        timeMin: checkIn,
        timeMax: checkOut,
        singleEvents: true
    });
    
    // אם יש אירועים = תפוס
    return events.data.items.length === 0;
}
```

#### Definition of Done

- [ ] יומן נוצר לכל צימר
- [ ] חיבור API עובד
- [ ] שאילתת זמינות מחזירה תוצאות נכונות
- [ ] הוספת אירוע בדיקה עובדת
- [ ] מחיקת אירוע עובדת

---

### 💰 שלב 3: מנוע תמחור

**⏱️ זמן משוער:** 4-5 ימים  
**🎯 מטרה:** חישוב מחירים דינמי לפי כללים

#### משימות

```javascript
class PricingEngine {
    async calculatePrice(cabin, checkIn, checkOut, guests, addons) {
        let basePrice = cabin.base_price_night;
        let nights = this.calculateNights(checkIn, checkOut);
        
        // תמחור לפי יום בשבוע
        for (let date of this.dateRange(checkIn, checkOut)) {
            if (this.isWeekend(date)) {
                basePrice += cabin.weekend_surcharge;
            }
            if (this.isHoliday(date)) {
                basePrice += cabin.holiday_surcharge;
            }
        }
        
        // תוספות
        let addonsTotal = 0;
        for (let addon of addons) {
            addonsTotal += addon.price;
        }
        
        // הנחות
        let discount = 0;
        if (nights >= 7) {
            discount = basePrice * nights * 0.1; // 10% הנחה
        }
        
        let subtotal = (basePrice * nights) + addonsTotal;
        let total = subtotal - discount;
        
        return {
            base_price: basePrice,
            nights: nights,
            addons: addonsTotal,
            discount: discount,
            subtotal: subtotal,
            total: total
        };
    }
}
```

#### Definition of Done

- [ ] חישוב מחיר בסיסי עובד
- [ ] תמחור סופ"ש עובד
- [ ] תמחור חגים עובד
- [ ] תוספות מחושבות נכון
- [ ] הנחות מיושמות
- [ ] טסטים עוברים

---

### 🔒 שלב 4: Hold למניעת דאבל בוקינג

**⏱️ זמן משוער:** 3-4 ימים  
**🎯 מטרה:** מנגנון נעילה זמני של צימרים

#### משימות

```javascript
// שימוש ב-Redis לניהול Holds
class HoldManager {
    constructor(redis) {
        this.redis = redis;
        this.HOLD_DURATION = 15 * 60; // 15 דקות
    }
    
    async createHold(cabinId, checkIn, checkOut, customerId) {
        const holdKey = `hold:${cabinId}:${checkIn}:${checkOut}`;
        
        // בדוק אם יש Hold קיים
        const existing = await this.redis.get(holdKey);
        if (existing) {
            throw new Error('Cabin is already on hold');
        }
        
        // צור Hold חדש
        const holdData = {
            cabin_id: cabinId,
            customer_id: customerId,
            check_in: checkIn,
            check_out: checkOut,
            created_at: new Date().toISOString()
        };
        
        await this.redis.setex(
            holdKey,
            this.HOLD_DURATION,
            JSON.stringify(holdData)
        );
        
        // צור אירוע "HOLD" ביומן
        await this.createCalendarHold(cabinId, checkIn, checkOut);
        
        return holdData;
    }
    
    async releaseHold(cabinId, checkIn, checkOut) {
        const holdKey = `hold:${cabinId}:${checkIn}:${checkOut}`;
        await this.redis.del(holdKey);
        await this.removeCalendarHold(cabinId, checkIn, checkOut);
    }
    
    async convertHoldToBooking(holdData, paymentId) {
        // המר Hold להזמנה אמיתית
        await this.releaseHold(
            holdData.cabin_id,
            holdData.check_in,
            holdData.check_out
        );
        
        // צור הזמנה ב-DB
        const booking = await this.createBooking({
            ...holdData,
            payment_id: paymentId,
            status: 'confirmed'
        });
        
        // עדכן יומן לסטטוס CONFIRMED
        await this.updateCalendarEvent(
            holdData.cabin_id,
            holdData.check_in,
            holdData.check_out,
            'CONFIRMED'
        );
        
        return booking;
    }
}
```

#### Definition of Done

- [x] Hold נוצר ב-Redis
- [x] Hold נוצר ביומן
- [x] Hold מתפוגג אוטומטית אחרי 15 דקות
- [x] Hold ניתן לשחרור ידני
- [x] המרה ל-booking עובדת
- [x] לא ניתן ליצור Hold כפול

---

### 💳 שלב 5: תשלום + אימות Webhooks - **100% הושלם**

**⏱️ זמן משוער:** 5-6 ימים  
**🎯 מטרה:** אינטגרציה מלאה עם ספק סליקה

#### מה הושלם:

- ✅ `PaymentManager` class - ניהול תשלומים עם Stripe
- ✅ `create_payment_intent` - יצירת Payment Intent
- ✅ `/book` endpoint - תמיכה ב-`create_payment: true`
- ✅ `POST /webhooks/stripe` - Webhook handler מלא
- ✅ אימות Webhook signature
- ✅ טיפול ב-`payment_intent.succeeded`
- ✅ טיפול ב-`payment_intent.payment_failed`
- ✅ עדכון Transaction status ב-DB
- ✅ שליחת Payment Receipt email אוטומטית
- ✅ בדיקות אוטומטיות (`database/test_stage5_payments.py`)
- ✅ UI מלא ב-`features_picker.html` - Payment Modal עם Mock mode

**קבצים:**
- `src/payment.py` - PaymentManager class
- `src/api_server.py` - `/book` endpoint עם payment intent, `/webhooks/stripe`
- `tools/features_picker.html` - Payment Modal עם Mock/Real Stripe
- `database/test_stage5_payments.py` - בדיקות אוטומטיות

**Endpoints:**
- `POST /book` - יצירת הזמנה עם `create_payment: true` (יוצר Payment Intent)
- `POST /webhooks/stripe` - Webhook handler ל-Stripe events

**תכונות:**
- 💳 יצירת Payment Intent עם metadata מלא
- 🔐 אימות Webhook signature
- ✅ עדכון Transaction status אוטומטי
- 📧 שליחת Payment Receipt email אוטומטית
- 🧪 Mock Payment Modal לבדיקות (ללא Stripe)

**איך לבדוק:**
```bash
database\run_test_stage5.bat
```

**Definition of Done:**
- [x] יצירת חיוב עובדת
- [x] קישור תשלום נשלח ללקוח (Payment Modal)
- [x] Webhook מקבל אירועים
- [x] תשלום מאומת מעדכן DB
- [x] Transaction status מתעדכן אוטומטית
- [x] Payment Receipt email נשלח אוטומטית
- [ ] החזר כספי (refund) - עדיין לא מומש (שלב עתידי)

---

### 📨 שלב 6: הודעות ותזכורות - **80% הושלם**

**⏱️ זמן משוער:** 4-5 ימים  
**🎯 מטרה:** שליחת הודעות אוטומטיות בזמנים נכונים

#### מה הושלם:

- ✅ `EmailService` class - שירות אימייל מלא
- ✅ `send_booking_confirmation` - אישור הזמנה מיידי (נשלח ב-`/book`)
- ✅ `send_payment_receipt` - קבלת תשלום (נשלח ב-`/webhooks/stripe`)
- ✅ `send_reminder_email` - תזכורת יומיים לפני הגעה
- ✅ `send_reminders.py` - סקריפט לריצה יומית
- ✅ תמיכה בכתובת וקואורדינטות (Waze/Google Maps)
- ✅ HTML emails מעוצבים
- ✅ RTL support בעברית
- ⏳ תזמון אוטומטי (Celery/BullMQ) - עדיין לא מומש

**קבצים:**
- `src/email_service.py` - EmailService class מלא
- `src/api_server.py` - אינטגרציה ב-`/book` ו-`/webhooks/stripe`
- `database/send_reminders.py` - סקריפט לריצה יומית

**תכונות:**
- 📧 אישור הזמנה מיידי עם פרטים מלאים
- 💰 קבלת תשלום עם פרטי תשלום
- ⏰ תזכורת יומיים לפני הגעה
- 📍 קישורי Waze/Google Maps
- 🎨 HTML emails מעוצבים

**איך להריץ תזכורות:**
```bash
# ריצה ידנית
python database/send_reminders.py

# או הגדר Scheduled Task (Windows) / Cron (Linux) לריצה יומית
```

**מה חסר:**
- ❌ תזמון אוטומטי (Celery/BullMQ) - כרגע צריך להריץ ידנית
- ❌ הודעת תודה אחרי יציאה
- ❌ הוראות הגעה ביום ההגעה
- ❌ SMS Integration (אופציונלי)
- ❌ התראות לבעל הצימר

#### Definition of Done

- [x] אישור הזמנה נשלח מיידית ✅
- [x] קבלת תשלום נשלחת אוטומטית ✅
- [x] תזכורת נשלחת יומיים לפני (סקריפט מוכן, צריך תזמון) ⏳
- [ ] הוראות הגעה נשלחות ביום ההגעה ❌
- [ ] הודעת תודה נשלחת אחרי יציאה ❌
- [ ] התראות לבעל הצימר עובדות ❌
- [ ] לוג של כל ההודעות (חלקי - רק ב-console) ⏳

---

### 💬 שלב 7: חיבור צ'אט באתר

**⏱️ זמן משוער:** 5-7 ימים  
**🎯 מטרה:** ממשק צ'אט מלא עם AI

#### משימות

**1. Frontend - Widget צ'אט**

```html
<div id="chat-widget">
    <div id="chat-messages"></div>
    <input id="chat-input" placeholder="שאל אותי משהו..." />
    <button id="chat-send">שלח</button>
</div>
```

**2. Backend - Chatbot Logic**

```javascript
class ChatbotHandler {
    async handleMessage(message, sessionId) {
        const intent = await this.detectIntent(message);
        
        switch (intent) {
            case 'search_availability':
                return await this.handleSearchIntent(message, sessionId);
            
            case 'get_pricing':
                return await this.handlePricingIntent(message, sessionId);
            
            case 'make_booking':
                return await this.handleBookingIntent(message, sessionId);
            
            case 'ask_question':
                return await this.handleQuestionIntent(message, sessionId);
            
            default:
                return this.handleFallback(message);
        }
    }
    
    async handleSearchIntent(message, sessionId) {
        // חלץ תאריכים ופרטים מההודעה
        const params = await this.extractParameters(message);
        
        if (!params.checkIn || !params.checkOut) {
            return {
                type: 'question',
                text: 'אשמח לעזור! מתי תרצה להגיע?',
                quick_replies: ['סופ"ש הקרוב', 'השבוע הבא']
            };
        }
        
        // חפש צימרים פנויים
        const available = await this.searchAvailability(params);
        
        return {
            type: 'cabin_results',
            cabins: available,
            text: `מצאתי ${available.length} צימרים פנויים!`
        };
    }
}
```

#### Definition of Done

- [ ] Widget צ'אט מוטמע באתר
- [ ] זיהוי כוונות (NLU) עובד
- [ ] שיחה מלאה עד הזמנה עובדת
- [ ] הצגת תמונות ופרטים
- [ ] העברה לאדם עובדת
- [ ] סשנים נשמרים

---

### 📞 שלב 8: חיבור סוכן קולי

**⏱️ זמן משוער:** 7-10 ימים  
**🎯 מטרה:** סוכן קולי טלפוני מלא

#### משימות

```javascript
// Twilio Voice Handler
app.post('/voice/incoming', (req, res) => {
    const twiml = new twilio.twiml.VoiceResponse();
    
    // הודעת פתיחה
    twiml.say({
        voice: 'Polly.Tatyana',
        language: 'he-IL'
    }, 'שלום וברוכים הבאים לצימרים שלנו. איך אוכל לעזור?');
    
    // הקלטת תשובה
    twiml.gather({
        input: 'speech',
        language: 'he-IL',
        speechTimeout: 'auto',
        action: '/voice/process'
    });
    
    res.type('text/xml');
    res.send(twiml.toString());
});

app.post('/voice/process', async (req, res) => {
    const speech = req.body.SpeechResult;
    const callSid = req.body.CallSid;
    
    // עבד את הדיבור
    const response = await chatbot.handleMessage(speech, callSid);
    
    const twiml = new twilio.twiml.VoiceResponse();
    
    if (response.transfer_to_human) {
        twiml.say('מעביר אותך לנציג...');
        twiml.dial(process.env.AGENT_PHONE);
    } else {
        twiml.say({
            voice: 'Polly.Tatyana',
            language: 'he-IL'
        }, response.text);
        
        // המשך שיחה
        twiml.gather({
            input: 'speech',
            language: 'he-IL',
            action: '/voice/process'
        });
    }
    
    res.type('text/xml');
    res.send(twiml.toString());
});
```

#### Definition of Done

- [ ] שיחה נכנסת מטופלת
- [ ] Speech-to-Text עובד בעברית
- [ ] Text-to-Speech עובד בעברית
- [ ] זרימת שיחה מלאה עובדת
- [ ] העברה לאדם עובדת
- [ ] הקלטת שיחות

---

### 📊 שלב 9: דשבורד ניהול

**⏱️ זמן משוער:** 7-10 ימים  
**🎯 מטרה:** ממשק ניהול מלא לבעל הצימר

#### תכונות

```
┌─────────────────────────────────────────┐
│  🏠 Dashboard                            │
├─────────────────────────────────────────┤
│                                         │
│  📊 היום                                │
│  ├─ הזמנות חדשות: 3                     │
│  ├─ check-in: 2                         │
│  ├─ check-out: 1                        │
│  └─ הכנסות: ₪2,400                      │
│                                         │
│  📅 לוח שנה                             │
│  [תצוגה חודשית עם תפוסה]                │
│                                         │
│  💰 הכנסות                              │
│  [גרף הכנסות לפי חודש]                  │
│                                         │
│  📋 הזמנות אחרונות                      │
│  [טבלה עם הזמנות + סטטוס]              │
│                                         │
│  ⚙️ הגדרות                              │
│  ├─ ניהול צימרים                        │
│  ├─ כללי תמחור                          │
│  ├─ תוספות וחבילות                     │
│  └─ משתמשים והרשאות                     │
│                                         │
└─────────────────────────────────────────┘
```

#### Definition of Done

- [ ] לוח בקרה עם נתונים חיים
- [ ] תצוגת לוח שנה
- [ ] ניהול הזמנות (עריכה, ביטול)
- [ ] דוחות KPI
- [ ] ניהול תמחור
- [ ] ניהול משתמשים
- [ ] לוג פעולות

---

### ⚡ שלב 10: שדרוגים חכמים ואופטימיזציה

**⏱️ זמן משוער:** 5-7 ימים  
**🎯 מטרה:** שיפור ביצועים וחוויית משתמש

#### שיפורים

**ביצועים:**
- Cache תוצאות חיפוש נפוצות
- אופטימיזציה של שאילתות DB
- CDN לתמונות
- Lazy loading

**חוויית משתמש:**
- חיפוש מתקדם עם פילטרים
- המלצות מותאמות אישית
- השוואה בין צימרים
- ביקורות ודירוגים

**אנליטיקס:**
- Google Analytics
- מעקב אחר המרות
- Heatmaps
- A/B Testing

---

## 🏁 התחלה מהירה

### דרישות מקדימות

```bash
# Backend
- Python 3.10+ / Node.js 18+
- PostgreSQL 15+
- Redis 7+

# Cloud Services
- Google Cloud Platform (Calendar API)
- Stripe / Tranzila (תשלומים)
- Twilio (טלפוניה)
- SendGrid / AWS SES (אימייל)
```

### התקנה מהירה

```bash
# Clone repository
git clone https://github.com/yourusername/cabin-booking-ai.git
cd cabin-booking-ai

# Install dependencies
pip install -r requirements.txt  # Python
# OR
npm install  # Node.js

# Setup environment
cp .env.example .env
# Edit .env with your credentials

# Run migrations
python manage.py migrate  # Python
# OR
npm run migrate  # Node.js

# Start development server
python manage.py runserver  # Python
# OR
npm run dev  # Node.js
```

---

## 📊 מצב פרויקט והצעד הבא

**תאריך עדכון אחרון:** 2026-01-03

### 📈 התקדמות כללית

```
שלב 1: מודל נתונים        [██████████] 100% ✅ הושלם
שלב 2: חיבור ליומן         [██████████] 100% ✅ הושלם
שלב 3: מנוע תמחור          [██████████] 100% ✅ הושלם
שלב 4: מנגנון Hold          [██████████] 100% ✅ הושלם
שלב 5: תשלומים             [██████████] 100% ✅ הושלם
שלב 6: הודעות               [████████░░]  80% ⏳ חלקי
שלב 7: צ'אט באתר            [░░░░░░░░░░]   0%
שלב 8: סוכן קולי            [░░░░░░░░░░]   0%
שלב 9: דשבורד               [░░░░░░░░░░]   0%
שלב 10: אופטימיזציה         [░░░░░░░░░░]   0%

סה"כ: 58% הושלם (5.8 מתוך 10 שלבים)
```

### ✅ שלבים שהושלמו

#### 📘 שלב 1: מודל נתונים - **100% הושלם**

**מה הושלם:**
- ✅ כל הטבלאות נוצרו (`cabins`, `bookings`, `customers`, `pricing_rules`, `transactions`, `notifications`, `audit_log`)
- ✅ קשרים (Foreign Keys) מוגדרים
- ✅ Indexes על שדות חיפוש
- ✅ Constraints מוגדרים
- ✅ Triggers ל-`updated_at`
- ✅ בדיקות אוטומטיות (`database/check_stage1.py`)

**קבצים:**
- `database/schema.sql` - Schema מלא
- `database/check_stage1.py` - בדיקות אוטומטיות
- `database/run_check_stage1.bat` - הרצה מהירה

**איך לבדוק:**
```bash
database\run_check_stage1.bat
```

---

#### 📅 שלב 2: חיבור ליומן וזמינות - **100% הושלם**

**מה הושלם:**
- ✅ חיבור ל-Google Calendar API
- ✅ קריאת צימרים מ-Google Sheets
- ✅ בדיקת זמינות (`/availability` endpoint)
- ✅ יצירת אירועים (`/book` endpoint)
- ✅ מחיקת אירועים (לבדיקות)
- ✅ OAuth2 authentication
- ✅ בדיקות אוטומטיות (`database/check_stage2.py`)

**קבצים:**
- `src/main.py` - לוגיקה של Calendar API
- `src/api_server.py` - FastAPI endpoints
- `database/check_stage2.py` - בדיקות אוטומטיות

**Endpoints:**
- `POST /availability` - בדיקת זמינות
- `POST /book` - יצירת הזמנה

**איך לבדוק:**
```bash
database\run_check_stage2.bat
```

---

#### 💰 שלב 3: מנוע תמחור - **100% הושלם**

**מה הושלם:**
- ✅ `PricingEngine` class - מנוע תמחור מתקדם
- ✅ תמיכה בסופ"ש (+30% או מחיר נפרד)
- ✅ תמיכה בחגים (+50%)
- ✅ תמיכה בעונה גבוהה (+20%)
- ✅ תמיכה בעונת חגים (+30%)
- ✅ הנחות לפי משך שהות (4 לילות = 5%, שבוע = 10%, חודש = 15%)
- ✅ תמיכה בתוספות (addons)
- ✅ `/quote` endpoint - הצעת מחיר מפורטת
- ✅ Breakdown מפורט לכל יום
- ✅ בדיקות אוטומטיות (`database/check_stage3.py`)
- ✅ `features_picker.html` - זרימה מלאה עם טבלת מחירים

**קבצים:**
- `src/pricing.py` - PricingEngine class
- `src/api_server.py` - `/quote` endpoint
- `tools/features_picker.html` - UI מלא עם:
  - בדיקת זמינות
  - בחירת צימר
  - הצעת מחיר מפורטת
  - בחירת addons
  - יצירת הזמנה
- `database/check_stage3.py` - בדיקות אוטומטיות

**Endpoints:**
- `POST /quote` - הצעת מחיר מפורטת עם breakdown

**איך לבדוק:**
```bash
database\run_check_stage3.bat
```

**מה עובד:**
- ✅ חישוב מחיר בסיסי
- ✅ תמחור סופ"ש
- ✅ תמחור חגים
- ✅ תמחור עונה גבוהה
- ✅ הנחות לפי משך שהות
- ✅ תוספות (addons)
- ✅ Breakdown מפורט

---

### ✅ שלב 4: מנגנון Hold - **100% הושלם**

**מה הושלם:**
- ✅ Redis Integration - חיבור ל-Redis לניהול Holds
- ✅ HoldManager class - יצירה, שחרור, המרה
- ✅ API Endpoints - `/hold`, `/hold/{id}`, `DELETE /hold/{id}`
- ✅ Calendar Integration - אירועי HOLD ביומן
- ✅ Database Integration - שמירת לקוחות והזמנות ב-DB
- ✅ `/book` endpoint - תמיכה ב-Hold conversion
- ✅ Fallback behavior - עובד גם בלי Redis (עם אזהרה)
- ✅ Admin Panel - תצוגת Holds, Bookings, Audit Logs
- ✅ Booking Details Modal - פתיחת פרטי הזמנה בלחיצה
- ✅ Cancel Booking - ביטול הזמנה עם מחיקת Calendar event
- ✅ בדיקות אוטומטיות (`database/check_stage4.py`)

**קבצים:**
- `src/hold.py` - HoldManager class
- `src/db.py` - Database connection and utilities
- `src/main.py` - Calendar functions (כולל `delete_calendar_event`)
- `src/api_server.py` - API endpoints כולל Admin endpoints
- `tools/features_picker.html` - UI מלא עם Admin Panel
- `database/import_cabins_to_db.py` - Import cabins from Sheets to DB
- `database/check_stage4.py` - בדיקות אוטומטיות

**Endpoints:**
- `POST /hold` - יצירת Hold
- `GET /hold/{hold_id}` - בדיקת סטטוס Hold
- `DELETE /hold/{hold_id}` - שחרור Hold
- `POST /book` - יצירת הזמנה (עם תמיכה ב-Hold)
- `GET /admin/bookings` - רשימת כל ההזמנות
- `GET /admin/bookings/{id}` - פרטי הזמנה ספציפית
- `POST /admin/bookings/{id}/cancel` - ביטול הזמנה
- `GET /admin/holds` - רשימת כל ה-Holds הפעילים
- `GET /admin/audit` - Audit Logs

**תכונות Admin Panel:**
- 📊 Statistics - סטטיסטיקות כולל Total Revenue, On Hold, Confirmed
- 📋 Bookings - רשימת הזמנות עם Filter לפי Status
- 📝 Audit Log - יומן פעילות מלא
- 🔍 Booking Details - לחיצה על הזמנה לפתיחת modal עם פרטים מלאים
- ❌ Cancel Booking - ביטול הזמנה עם מחיקת Calendar event

**איך לבדוק:**
```bash
database\run_check_stage4.bat
```

**איך לייבא צימרים ל-DB:**
```bash
database\run_import_cabins.bat
```

📋 **לפרטים מלאים:** ראה `docs/STAGE4_HOLD_GUIDE.md`

---

---

### 💳 שלב 5: תשלום + אימות Webhooks - **100% הושלם**

**מה הושלם:**
- ✅ `PaymentManager` class - ניהול תשלומים עם Stripe
- ✅ `create_payment_intent` - יצירת Payment Intent
- ✅ `/book` endpoint - תמיכה ב-`create_payment: true`
- ✅ `POST /webhooks/stripe` - Webhook handler מלא
- ✅ אימות Webhook signature
- ✅ טיפול ב-`payment_intent.succeeded`
- ✅ טיפול ב-`payment_intent.payment_failed`
- ✅ עדכון Transaction status ב-DB
- ✅ שליחת Payment Receipt email אוטומטית
- ✅ בדיקות אוטומטיות (`database/test_stage5_payments.py`)
- ✅ UI מלא ב-`features_picker.html` - Payment Modal עם Mock mode

**קבצים:**
- `src/payment.py` - PaymentManager class
- `src/api_server.py` - `/book` endpoint עם payment intent, `/webhooks/stripe`
- `tools/features_picker.html` - Payment Modal עם Mock/Real Stripe
- `database/test_stage5_payments.py` - בדיקות אוטומטיות

**Endpoints:**
- `POST /book` - יצירת הזמנה עם `create_payment: true` (יוצר Payment Intent)
- `POST /webhooks/stripe` - Webhook handler ל-Stripe events

**תכונות:**
- 💳 יצירת Payment Intent עם metadata מלא
- 🔐 אימות Webhook signature
- ✅ עדכון Transaction status אוטומטי
- 📧 שליחת Payment Receipt email אוטומטית
- 🧪 Mock Payment Modal לבדיקות (ללא Stripe)

**איך לבדוק:**
```bash
database\run_test_stage5.bat
```

**Definition of Done:**
- [x] יצירת חיוב עובדת ✅
- [x] קישור תשלום נשלח ללקוח (Payment Modal) ✅
- [x] Webhook מקבל אירועים ✅
- [x] תשלום מאומת מעדכן DB ✅
- [x] Transaction status מתעדכן אוטומטית ✅
- [x] Payment Receipt email נשלח אוטומטית ✅
- [ ] החזר כספי (refund) - עדיין לא מומש (שלב עתידי) ⏳

---

### 📨 שלב 6: הודעות ותזכורות - **80% הושלם**

**מה הושלם:**
- ✅ `EmailService` class - שירות אימייל מלא
- ✅ `send_booking_confirmation` - אישור הזמנה מיידי (נשלח ב-`/book`)
- ✅ `send_payment_receipt` - קבלת תשלום (נשלח ב-`/webhooks/stripe`)
- ✅ `send_reminder_email` - תזכורת יומיים לפני הגעה
- ✅ `send_reminders.py` - סקריפט לריצה יומית
- ✅ תמיכה בכתובת וקואורדינטות (Waze/Google Maps)
- ✅ HTML emails מעוצבים
- ✅ RTL support בעברית
- ⏳ תזמון אוטומטי (Celery/BullMQ) - עדיין לא מומש

**קבצים:**
- `src/email_service.py` - EmailService class מלא
- `src/api_server.py` - אינטגרציה ב-`/book` ו-`/webhooks/stripe`
- `database/send_reminders.py` - סקריפט לריצה יומית

**תכונות:**
- 📧 אישור הזמנה מיידי עם פרטים מלאים
- 💰 קבלת תשלום עם פרטי תשלום
- ⏰ תזכורת יומיים לפני הגעה
- 📍 קישורי Waze/Google Maps
- 🎨 HTML emails מעוצבים

**איך להריץ תזכורות:**
```bash
# ריצה ידנית
python database/send_reminders.py

# או הגדר Scheduled Task (Windows) / Cron (Linux) לריצה יומית
```

**מה חסר:**
- ❌ תזמון אוטומטי (Celery/BullMQ) - כרגע צריך להריץ ידנית
- ❌ הודעת תודה אחרי יציאה
- ❌ הוראות הגעה ביום ההגעה
- ❌ SMS Integration (אופציונלי)
- ❌ התראות לבעל הצימר

**Definition of Done:**
- [x] אישור הזמנה נשלח מיידית ✅
- [x] קבלת תשלום נשלחת אוטומטית ✅
- [x] תזכורת נשלחת יומיים לפני (סקריפט מוכן, צריך תזמון) ⏳
- [ ] הוראות הגעה נשלחות ביום ההגעה ❌
- [ ] הודעת תודה נשלחת אחרי יציאה ❌
- [ ] התראות לבעל הצימר עובדות ❌
- [ ] לוג של כל ההודעות (חלקי - רק ב-console) ⏳

---

### 💾 מה נשמר ב-DB כרגע?

**✅ חלקית!** - המערכת שומרת חלק מהנתונים ב-DB:

**מה נשמר:**
- ✅ `customers` - שמירת לקוחות חדשים (אוטומטי ב-`/book`)
- ✅ `bookings` - שמירת כל הזמנה אחרי `/book` (אוטומטי)
- ✅ `transactions` - שמירת תשלומים (אוטומטי ב-`/book` + Webhook)
- ⏳ `cabins` - ניתן לייבא מ-Google Sheets ל-DB (סקריפט מוכן)
- ❌ `pricing_rules` - עדיין hardcoded (שלב עתידי)

**איך לייבא צימרים ל-DB:**
```bash
database\run_import_cabins.bat
```

📋 **לפרטים מלאים:** ראה `docs/PROJECT_STATUS.md`, `docs/INTEGRATION_GUIDE.md`, ו-`docs/STAGE4_HOLD_GUIDE.md`

---

### ⏳ השלב הבא: השלמת שלב 6 - תזמון אוטומטי להודעות

**⏱️ זמן משוער:** 2-3 ימים  
**🎯 מטרה:** הוספת תזמון אוטומטי להודעות ותזכורות  
**🛠️ כלי:** Cursor (Python + Celery או Scheduled Tasks)

#### מה צריך לבנות:

**1. תזמון אוטומטי:**
- [ ] הגדרת Celery או Scheduled Tasks
- [ ] תזמון תזכורות יומיות (2 ימים לפני הגעה)
- [ ] תזמון הודעת תודה (אחרי יציאה)
- [ ] תזמון הוראות הגעה (ביום ההגעה)

**2. הודעות נוספות:**
- [ ] הודעת תודה אחרי יציאה
- [ ] הוראות הגעה ביום ההגעה
- [ ] התראות לבעל הצימר (הזמנה חדשה, ביטול)

**3. לוגים:**
- [ ] שמירת לוג של כל ההודעות ב-DB
- [ ] טבלת `notifications` עם סטטוס

#### Definition of Done:
- [x] אישור הזמנה נשלח מיידית ✅
- [x] קבלת תשלום נשלחת אוטומטית ✅
- [ ] תזכורת נשלחת אוטומטית יומיים לפני (צריך תזמון) ⏳
- [ ] הוראות הגעה נשלחות ביום ההגעה ❌
- [ ] הודעת תודה נשלחת אחרי יציאה ❌
- [ ] התראות לבעל הצימר עובדות ❌
- [ ] לוג של כל ההודעות ב-DB ❌

---

### 🎉 הישגים עד כה

✅ **5.8 שלבים הושלמו בהצלחה!**
- מודל נתונים מוצק
- חיבור ליומן עובד
- מנוע תמחור מתקדם
- מנגנון Hold למניעת דאבל בוקינג
- אינטגרציה מלאה עם Stripe לתשלומים
- מערכת אימייל (80% - חסר תזמון אוטומטי)

✅ **UI מלא:**
- `features_picker.html` עם זרימה מלאה
- טבלת מחירים מפורטת
- בחירת addons
- יצירת הזמנות
- Admin Panel מלא (Statistics, Bookings, Audit Log)
- Payment Modal (Mock + Real Stripe)

✅ **API עובד:**
- `/health` - בדיקת בריאות
- `/cabins` - רשימת צימרים
- `/availability` - בדיקת זמינות
- `/quote` - הצעת מחיר
- `/book` - יצירת הזמנה
- `/hold` - ניהול Holds
- `/webhooks/stripe` - Webhook handler
- `/admin/bookings` - ניהול הזמנות
- `/admin/audit` - Audit Logs

---

## 📞 צור קשר ותמיכה

**מפתח הפרויקט:** [אלדד גונשרוביץ]  
**אימייל:** eldadi9@gmail.com  
**GitHub:** [@eldadi9](https://github.com/eldadi9)

---

## 📄 רישיון

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

---

<div align="center">

**נבנה באהבה ❤️ עם הרבה קפה ☕**

[⬆ חזרה למעלה](#-מערכת-הזמנות-אוטומטית-לצימרים)

</div>
