<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ZimmerBot - ×”×–×× ×ª ××§×•×</title>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin: 16px; 
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .card { 
      border: 1px solid #ddd; 
      border-radius: 12px; 
      padding: 16px; 
      min-width: 280px; 
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: box-shadow 0.3s;
    }
    .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    h1 { 
      color: #2c3e50; 
      margin-bottom: 20px; 
      text-align: center;
      font-size: 28px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    h2 { margin: 0 0 12px 0; font-size: 18px; color: #34495e; }
    label { 
      display: block; 
      margin: 8px 0 4px 0; 
      font-weight: 500;
      color: #555;
    }
    input[type="text"], 
    input[type="number"], 
    input[type="datetime-local"],
    select,
    textarea { 
      width: 100%; 
      padding: 10px; 
      box-sizing: border-box; 
      font-family: inherit;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    input[type="text"]:focus,
    input[type="number"]:focus,
    input[type="datetime-local"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #2196F3;
      box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
    }
    select {
      cursor: pointer;
      background: white;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: left 10px center;
      padding-right: 10px;
      padding-left: 35px;
    }
    button { 
      padding: 10px 16px; 
      cursor: pointer; 
      margin: 4px; 
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
      border: none;
    }
    pre { 
      background: #1e1e1e; 
      color: #d4d4d4; 
      padding: 12px; 
      border-radius: 8px; 
      overflow: auto;
      font-size: 13px;
      line-height: 1.5;
    }
    .small { font-size: 12px; color: #666; }
    .ok { color: #0a7; }
    .err { color: #c00; }
    
    /* Modal styles */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
    .modal-content { 
      background-color: #fefefe; 
      margin: 5% auto; 
      padding: 24px; 
      border: 1px solid #888; 
      border-radius: 12px; 
      width: 80%; 
      max-width: 600px; 
      max-height: 80vh; 
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      animation: modalFadeIn 0.3s;
    }
    @keyframes modalFadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    .close { color: #aaa; float: left; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close:hover { color: black; }
    
    /* Available cabins list */
    .cabin-item { 
      border: 2px solid #ddd; 
      border-radius: 8px; 
      padding: 16px; 
      margin: 12px 0; 
      cursor: pointer; 
      transition: all 0.3s;
      background: white;
    }
    .cabin-item:hover { 
      background: #f8f9fa; 
      border-color: #2196F3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .cabin-item.selected { 
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); 
      border-color: #2196F3;
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
    }
    .cabin-name { 
      font-weight: bold; 
      font-size: 18px; 
      margin-bottom: 8px; 
      color: #2c3e50;
    }
    .cabin-details { 
      font-size: 14px; 
      color: #666; 
      margin-bottom: 8px;
    }
    .cabin-price { 
      font-size: 20px; 
      color: #0a7; 
      font-weight: bold; 
      margin-top: 12px;
      padding: 8px;
      background: #e8f5e9;
      border-radius: 6px;
      display: inline-block;
    }
    
    /* Cabin images */
    .cabin-images {
      display: flex;
      gap: 8px;
      margin: 12px 0;
      flex-wrap: wrap;
    }
    .cabin-image {
      width: 120px;
      height: 90px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #ddd;
      cursor: pointer;
      transition: all 0.3s;
    }
    .cabin-image:hover {
      transform: scale(1.05);
      border-color: #2196F3;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .cabin-image-main {
      width: 100%;
      max-width: 400px;
      height: 250px;
      object-fit: cover;
      border-radius: 12px;
      border: 3px solid #2196F3;
      margin: 12px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .cabin-image-placeholder {
      width: 120px;
      height: 90px;
      background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      font-size: 12px;
      border: 2px dashed #999;
    }
    
    /* Date Range Picker Styles */
    .date-range-picker-container {
      position: relative;
      min-width: 300px;
    }
    .date-range-display {
      width: 100%;
      padding: 10px;
      box-sizing: border-box;
      font-family: inherit;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      background: white;
      text-align: right;
    }
    .date-range-display:hover {
      border-color: #2196F3;
    }
    .date-range-picker-modal {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      background: white;
      border: 2px solid #2196F3;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      padding: 16px;
      z-index: 1000;
      min-width: 350px;
    }
    .date-range-picker-modal.visible {
      display: block;
    }
    .calendar-grid-range {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-top: 8px;
    }
    .calendar-day-range {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      position: relative;
    }
    .calendar-day-range:hover {
      border-color: #2196F3;
      background: #e3f2fd;
    }
    .calendar-day-range.other-month {
      color: #ccc;
      background: #f5f5f5;
    }
    .calendar-day-range.range-start {
      background: #2196F3;
      border-color: #1976D2;
      color: white;
      font-weight: bold;
    }
    .calendar-day-range.range-end {
      background: #2196F3;
      border-color: #1976D2;
      color: white;
      font-weight: bold;
    }
    .calendar-day-range.in-range {
      background: #bbdefb;
      border-color: #90caf9;
      color: #1565C0;
    }
    .calendar-day-range.today {
      border-color: #4CAF50;
      font-weight: bold;
    }
    
    /* Cabin Availability Table */
    .cabin-availability-table {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      border: 3px solid #2196F3;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      padding: 20px;
      z-index: 2000;
      max-width: 90%;
      max-height: 80vh;
      overflow: auto;
      display: none;
    }
    .cabin-availability-table.visible {
      display: block;
    }
    .availability-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    .availability-table th,
    .availability-table td {
      padding: 8px;
      text-align: center;
      border: 1px solid #ddd;
    }
    .availability-table th {
      background: #2196F3;
      color: white;
      font-weight: bold;
    }
    .availability-table td.booked {
      background: #ffcdd2;
      color: #c62828;
      font-weight: bold;
    }
    .availability-table td.available {
      background: #c8e6c9;
      color: #2e7d32;
    }
    .availability-table td.today {
      border: 2px solid #4CAF50;
      font-weight: bold;
    }
    
    .btn-primary { 
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); 
      color: white; 
      border: none;
      box-shadow: 0 2px 6px rgba(33, 150, 243, 0.3);
    }
    .btn-primary:hover { 
      background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
      transform: translateY(-1px);
    }
    .btn-success { 
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); 
      color: white; 
      border: none;
      box-shadow: 0 2px 6px rgba(76, 175, 80, 0.3);
    }
    .btn-success:hover { 
      background: linear-gradient(135deg, #45a049 0%, #388e3c 100%);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
      transform: translateY(-1px);
    }
    .btn-danger { 
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); 
      color: white; 
      border: none;
      box-shadow: 0 2px 6px rgba(244, 67, 54, 0.3);
    }
    .btn-danger:hover { 
      background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%);
      box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
      transform: translateY(-1px);
    }
    
     /* Features dropdowns - ×©×•×¨×” ××—×ª */
     .features-container {
       margin-top: 8px;
       display: flex;
       flex-wrap: wrap;
       gap: 8px;
       align-items: flex-start;
     }
     .feature-dropdown {
       position: relative;
       display: inline-block;
     }
     .feature-dropdown-btn {
       display: inline-flex;
       align-items: center;
       padding: 8px 16px;
       background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
       color: white;
       border: 2px solid #1976D2;
       border-radius: 20px;
       cursor: pointer;
       transition: all 0.2s;
       font-size: 13px;
       font-weight: 500;
       white-space: nowrap;
       user-select: none;
       box-shadow: 0 2px 6px rgba(33, 150, 243, 0.3);
     }
     .feature-dropdown-btn:hover {
       background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
       box-shadow: 0 3px 8px rgba(33, 150, 243, 0.4);
       transform: translateY(-1px);
     }
     .feature-dropdown-btn::after {
       content: "â–¼";
       margin-right: 6px;
       font-size: 10px;
       transition: transform 0.2s;
     }
     .feature-dropdown-btn.active::after {
       transform: rotate(180deg);
     }
     .feature-dropdown-content {
       display: none;
       position: absolute;
       top: 100%;
       right: 0;
       margin-top: 4px;
       background: white;
       border: 2px solid #2196F3;
       border-radius: 8px;
       box-shadow: 0 4px 12px rgba(0,0,0,0.15);
       min-width: 200px;
       max-width: 300px;
       max-height: 400px;
       overflow-y: auto;
       z-index: 1000;
       padding: 8px;
     }
     .feature-dropdown-content.active {
       display: block;
     }
     .feature-dropdown-content label {
       display: flex;
       align-items: center;
       padding: 8px 12px;
       margin: 2px 0;
       border-radius: 4px;
       cursor: pointer;
       transition: background 0.2s;
       font-size: 13px;
     }
     .feature-dropdown-content label:hover {
       background: #f5f5f5;
     }
     .feature-dropdown-content input[type="checkbox"] {
       width: auto;
       margin-left: 8px;
       cursor: pointer;
       transform: scale(1.2);
     }
    
    /* Layout for availability + pricing table */
    .availability-container {
      display: flex;
      gap: 20px;
      margin-top: 24px;
      align-items: flex-start;
    }
    .availability-card {
      flex: 1;
      min-width: 400px;
    }
    .pricing-card {
      width: 380px;
      position: sticky;
      top: 20px;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
    }
    .pricing-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    .pricing-table td {
      padding: 8px 12px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }
    .pricing-table tr:last-child td {
      border-bottom: none;
    }
    .pricing-table .label {
      color: #666;
      text-align: right;
    }
    .pricing-table .value {
      color: #2c3e50;
      font-weight: 500;
      text-align: left;
    }
    .pricing-table .total-row {
      background: #e8f5e9;
      font-weight: bold;
      font-size: 16px;
    }
    .pricing-table .total-row .label {
      color: #2c3e50;
    }
    .pricing-table .total-row .value {
      color: #0a7;
      font-size: 18px;
    }
    .pricing-table .discount-row {
      color: #4CAF50;
    }
    .pricing-table .surcharge-row {
      color: #ff9800;
    }
    .addons-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid #eee;
    }
    .addon-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      margin: 8px 0;
      border: 2px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .addon-item:hover {
      border-color: #2196F3;
      background: #f5f5f5;
    }
    .addon-item.selected {
      border-color: #2196F3;
      background: #e3f2fd;
    }
    .addon-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-left: 12px;
      cursor: pointer;
    }
    .addon-item label {
      flex: 1;
      cursor: pointer;
      margin: 0;
      font-weight: 500;
    }
    .addon-price {
      color: #0a7;
      font-weight: bold;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h1 style="margin: 0;">ğŸ¡ ZimmerBot - ×”×–×× ×ª ××§×•×</h1>
      <div style="display: flex; gap: 10px;">
        <button id="agentChatBtn" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; padding: 12px 24px; font-size: 16px; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);">
          ğŸ¤– Agent Chat
        </button>
        <button id="adminBtn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 24px; font-size: 16px; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);">
          ğŸ”§ Admin Panel
        </button>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div class="date-range-picker-container" style="min-width:300px">
          <label>ğŸ“… ×‘×—×¨ ×ª××¨×™×›×™× (×’×¨×•×¨ ××ª××¨×™×š ×¢×“ ×ª××¨×™×š)</label>
          <div class="date-range-display" id="date_range_display" onclick="toggleDateRangePicker()">
            ×‘×—×¨ ×ª××¨×™×›×™×...
          </div>
          <input type="hidden" id="check_in" value="2026-02-01T15:00" />
          <input type="hidden" id="check_out" value="2026-02-02T11:00" />
          <div class="date-range-picker-modal" id="date_range_picker">
            <div class="calendar-header">
              <button class="calendar-month-nav" onclick="prevMonthRange()">â—€</button>
              <h3 style="margin: 0;" id="calendar_month_display">×¤×‘×¨×•××¨ 2026</h3>
              <button class="calendar-month-nav" onclick="nextMonthRange()">â–¶</button>
            </div>
            <div class="calendar-grid-range" id="calendar_grid_range"></div>
            <div style="margin-top: 12px; padding-top: 12px; border-top: 2px solid #e0e0e0;">
              <button class="btn-primary" onclick="confirmDateRange()" style="width: 100%;">××™×©×•×¨</button>
              <button class="btn-danger" onclick="clearDateRange()" style="width: 100%; margin-top: 8px;">× ×§×”</button>
            </div>
          </div>
        </div>
        <div style="min-width:160px">
          <label>ğŸ‘¥ ××‘×•×’×¨×™× (Adults)</label>
          <select id="adults">
            <option value="">×œ× × ×‘×—×¨</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
            <option value="13">13</option>
            <option value="14">14</option>
            <option value="15">15</option>
            <option value="16">16</option>
            <option value="17">17</option>
            <option value="18">18</option>
            <option value="19">19</option>
            <option value="20">20</option>
          </select>
        </div>
        <div style="min-width:160px">
          <label>ğŸ‘¶ ×™×œ×“×™× (Kids)</label>
          <select id="kids">
            <option value="">×œ× × ×‘×—×¨</option>
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
            <option value="13">13</option>
            <option value="14">14</option>
            <option value="15">15</option>
            <option value="16">16</option>
            <option value="17">17</option>
            <option value="18">18</option>
            <option value="19">19</option>
            <option value="20">20</option>
          </select>
        </div>
        <div style="min-width:220px">
          <label>ğŸ“ ××–×•×¨ (Area)</label>
          <input id="area" type="text" value="" placeholder="×”×–×Ÿ ××–×•×¨ (××•×¤×¦×™×•× ×œ×™)" />
        </div>
      </div>

      <div style="margin-top:16px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
        <button id="btn_copy" style="background: #6c757d; color: white;">ğŸ“‹ ×”×¢×ª×§ Features</button>
        <button id="btn_check_availability" class="btn-primary">ğŸ” ×‘×“×•×§ ×–××™× ×•×ª</button>
        <button id="btn_post" style="display:none;">×©×œ×— POST ×œ /availability</button>
        <span id="msg" class="small" style="flex: 1;"></span>
      </div>
    </div>

     <!-- Features ×‘×—×™×¨×” - ×©×•×¨×” ××—×ª -->
     <div class="card" style="margin-top:12px">
       <h2 style="margin-bottom: 8px;">âœ¨ ×‘×—×¨ Features (×ª×›×•× ×•×ª ×¨×¦×•×™×•×ª)</h2>
       <div id="features_container" class="features-container"></div>
     </div>

    <div class="row" style="margin-top:12px">
      <div class="card" style="flex:1">
        <h2>Features ×©× ×‘×—×¨×•</h2>
        <input id="features_out" type="text" readonly />
        <div class="small">×–×” ×”×¢×¨×š ×©××ª×” ××“×‘×™×§ ×œ Swagger ×‘×©×“×” features</div>
      </div>

      <div class="card" style="flex:1">
        <h2>Request JSON</h2>
        <pre id="req_preview">{}</pre>
      </div>
    </div>

    <!-- ×ª×•×¦××•×ª ×–××™× ×•×ª + ×˜×‘×œ×ª ××—×™×¨×™× -->
    <div class="availability-container">
      <div class="card availability-card">
        <h2 style="text-align: center;">×ª×•×¦××•×ª ×–××™× ×•×ª</h2>
        <div id="availability_results"></div>
        <pre id="resp_preview" style="display:none;"></pre>
      </div>
      
      <!-- ×˜×‘×œ×ª ××—×™×¨×™× (××•×¦×’×ª ×›×©×¦×™××¨ × ×‘×—×¨) -->
      <div id="pricing_card" class="card pricing-card" style="display: none;">
        <h2>ğŸ’° ×”×¦×¢×ª ××—×™×¨ ××¤×•×¨×˜×ª</h2>
        <div id="pricing_table_container"></div>
        
        <!-- ×‘×—×™×¨×ª Addons -->
        <div class="addons-section">
          <h3 style="margin-top: 0; margin-bottom: 12px;">âœ¨ ×ª×•×¡×¤×•×ª (Addons)</h3>
          <div id="addons_container"></div>
        </div>
        
        <!-- Hold Status Display -->
        <div id="hold_status_container" style="margin-top: 20px; display: none;">
          <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong>ğŸ”’ Hold ×¤×¢×™×œ</strong><br/>
                <span id="hold_countdown" style="font-size: 14px; color: #856404;"></span>
              </div>
              <button id="btn_cancel_hold" class="btn-danger" style="padding: 6px 12px; font-size: 12px;">
                âœ• ×‘×™×˜×•×œ Hold
              </button>
            </div>
          </div>
        </div>
        
        <div style="margin-top: 20px;">
          <button id="btn_create_hold" class="btn-primary" style="width: 100%; padding: 14px; font-size: 16px; display: none; margin-bottom: 8px;">
            ğŸ”’ ×¦×•×¨ Hold (15 ×“×§×•×ª)
          </button>
          <button id="btn_book_final" class="btn-success" style="width: 100%; padding: 14px; font-size: 16px; display: none;">
            ğŸ“… ×¦×•×¨ ×”×–×× ×”
          </button>
        </div>
      </div>
    </div>

    <!-- Modal ×œ×”×–×× ×” -->
    <div id="bookingModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>×™×¦×™×¨×ª ×”×–×× ×”</h2>
        
        <!-- ×ª××•× ×” ×’×“×•×œ×” ×©×œ ×”×¦×™××¨ -->
        <div id="booking_cabin_image" style="margin: 12px 0; text-align: center; display: none;">
          <img id="booking_cabin_image_src" src="" alt="×¦×™××¨" class="cabin-image-main" 
               style="max-width: 100%; max-height: 300px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);" 
               onerror="this.style.display='none'" />
        </div>
        
        <div style="margin-bottom: 16px; padding: 12px; background: #f5f5f5; border-radius: 4px;">
          <strong>JSON Request:</strong>
          <pre id="modal_json_preview" style="background: #111; color: #eee; padding: 10px; border-radius: 4px; margin-top: 8px; font-size: 12px; overflow-x: auto;"></pre>
        </div>
        
        <form id="bookingForm">
          <label>×¦×™××¨ (Cabin ID):</label>
          <input type="text" id="modal_cabin_id" required readonly />
          
          <label>×©× ×”×œ×§×•×—:</label>
          <input type="text" id="modal_customer" required placeholder="×™×©×¨××œ ×™×©×¨××œ×™" />
          
          <label>×˜×œ×¤×•×Ÿ:</label>
          <input type="text" id="modal_phone" placeholder="050-1234567" />
          
          <label>××™××™×™×œ:</label>
          <input type="email" id="modal_email" placeholder="customer@example.com" />
          
          <label>×”×¢×¨×•×ª:</label>
          <textarea id="modal_notes" rows="3" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª..."></textarea>
          
          <div style="margin-top: 16px;">
            <button type="submit" class="btn-success">âœ… ×¦×•×¨ ×”×–×× ×”</button>
            <button type="button" class="btn-danger" onclick="closeBookingModal()">×‘×™×˜×•×œ</button>
          </div>
        </form>
        <div id="booking_result" style="margin-top: 16px;"></div>
      </div>
    </div>

    <!-- Modal ×œ×ª×©×œ×•× -->
    <div id="paymentModal" class="modal">
      <div class="modal-content" style="max-width: 700px;">
        <span class="close" onclick="closePaymentModal()">&times;</span>
        <h2 style="text-align: center; color: #4caf50;">ğŸ’³ ×ª×©×œ×•×</h2>
        
        <div id="payment_content" style="padding: 20px;">
          <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 48px; margin-bottom: 10px;">â³</div>
            <p style="color: #666;">×˜×•×¢×Ÿ ×¤×¨×˜×™ ×ª×©×œ×•×...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const CATALOG_URL = "/data/features_catalog.json";
    const API_BASE = "http://127.0.0.1:8000";
    // Make API_BASE available globally for Admin Panel
    window.API_BASE = API_BASE;
    const AVAILABILITY_URL = `${API_BASE}/availability`;
    const QUOTE_URL = `${API_BASE}/quote`;
    const BOOKING_URL = `${API_BASE}/book`;
    const HOLD_URL = `${API_BASE}/hold`;
    
    // Available addons
    const AVAILABLE_ADDONS = [
      { key: "massage", name: "××¡××’' ×œ×—×“×¨", price: 200 },
      { key: "chef_meal", name: "××¨×•×—×ª ×©×£", price: 300 },
      { key: "morning_tour", name: "×˜×™×•×œ ×‘×‘×•×§×¨", price: 150 }
    ];

    const el = (id) => document.getElementById(id);
    
    let availableCabins = [];
    let selectedCabinId = null;
    let currentQuote = null;
    let selectedAddons = [];
    let currentHoldId = null;
    let holdExpiresAt = null;
    let holdCountdownInterval = null;

    function toNullOrNumber(v) {
      const s = (v ?? "").toString().trim();
      if (!s) return null;
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    function toNullOrString(v) {
      const s = (v ?? "").toString().trim();
      return s ? s : null;
    }

    function buildSelectedFeatures() {
      const checked = Array.from(document.querySelectorAll('input[type="checkbox"][data-key]:checked'));
      const keys = checked.map(x => x.getAttribute("data-key"));
      // unique + preserve order
      const out = [];
      const seen = new Set();
      for (const k of keys) {
        if (!seen.has(k)) {
          out.push(k);
          seen.add(k);
        }
      }
      return out.join(",");
    }

    function formatDateTimeForAPI(datetimeLocal) {
      // Convert from "YYYY-MM-DDTHH:MM" to "YYYY-MM-DD HH:MM"
      if (!datetimeLocal) return "";
      return datetimeLocal.replace("T", " ");
    }

    function buildRequestBody() {
      const features = el("features_out").value.trim() || null;
      const checkInValue = el("check_in").value;
      const checkOutValue = el("check_out").value;
      
      return {
        check_in: formatDateTimeForAPI(checkInValue),
        check_out: formatDateTimeForAPI(checkOutValue),
        adults: toNullOrNumber(el("adults").value),
        kids: toNullOrNumber(el("kids").value),
        area: toNullOrString(el("area").value),
        features: features
      };
    }

    function refreshOutputs() {
      const featuresStr = buildSelectedFeatures();
      el("features_out").value = featuresStr;
      const body = buildRequestBody();
      el("req_preview").textContent = JSON.stringify(body, null, 2);
    }

    async function loadCatalog() {
      const r = await fetch(CATALOG_URL, { cache: "no-store" });
      if (!r.ok) throw new Error("Failed to load catalog: " + r.status);
      return await r.json();
    }

    function renderCatalog(catalog) {
      const cont = el("features_container");
      cont.innerHTML = "";

      // ×™×¦×™×¨×ª dropdown ×œ×›×œ ×§×˜×’×•×¨×™×” - ×”×›×œ ×‘×©×•×¨×” ××—×ª
      for (const cat of (catalog.categories || [])) {
        const dropdown = document.createElement("div");
        dropdown.className = "feature-dropdown";
        
        // ×›×¤×ª×•×¨ ×”×›×•×ª×¨×ª
        const btn = document.createElement("button");
        btn.className = "feature-dropdown-btn";
        btn.type = "button";
        btn.textContent = cat.label_he || cat.id || "×§×˜×’×•×¨×™×”";
        
        // ×ª×•×›×Ÿ ×”-dropdown
        const content = document.createElement("div");
        content.className = "feature-dropdown-content";
        
        // ×™×¦×™×¨×ª checkboxes ×œ×›×œ ×ª×›×•× ×” ×‘×§×˜×’×•×¨×™×”
        for (const item of (cat.items || [])) {
          const lbl = document.createElement("label");
          
          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.setAttribute("data-key", item.key);
          cb.id = `feature_${item.key}`;
          cb.addEventListener("change", refreshOutputs);
          
          const text = document.createTextNode(item.label_he || item.key);
          
          lbl.appendChild(cb);
          lbl.appendChild(text);
          content.appendChild(lbl);
        }
        
        // ×˜×™×¤×•×œ ×‘×œ×—×™×¦×” ×¢×œ ×”×›×¤×ª×•×¨ - ×¤×ª×™×—×”/×¡×’×™×¨×”
        btn.addEventListener("click", function(e) {
          e.stopPropagation();
          
          const isActive = content.classList.contains("active");
          const allContents = document.querySelectorAll(".feature-dropdown-content");
          const allButtons = document.querySelectorAll(".feature-dropdown-btn");
          
          // ×¡×’×•×¨ ××ª ×›×œ ×”-dropdowns ×”××—×¨×™×
          allContents.forEach(c => c.classList.remove("active"));
          allButtons.forEach(b => b.classList.remove("active"));
          
          // ×¤×ª×—/×¡×’×•×¨ ××ª ×”× ×•×›×—×™
          if (!isActive) {
            content.classList.add("active");
            btn.classList.add("active");
          }
        });
        
        // ×¡×’×•×¨ dropdown ×‘×œ×—×™×¦×” ××—×•×¥ ×œ×•
        document.addEventListener("click", function(e) {
          if (!dropdown.contains(e.target)) {
            content.classList.remove("active");
            btn.classList.remove("active");
          }
        });
        
        dropdown.appendChild(btn);
        dropdown.appendChild(content);
        cont.appendChild(dropdown);
      }

      refreshOutputs();
    }

    async function copyFeatures() {
      const txt = el("features_out").value.trim();
      try {
        await navigator.clipboard.writeText(txt);
        el("msg").textContent = "×”×•×¢×ª×§ ×œ×œ×•×—";
        el("msg").className = "small ok";
      } catch {
        el("msg").textContent = "×œ× ×”×¦×œ×—×ª×™ ×œ×”×¢×ª×™×§. ×ª×¡××Ÿ ×™×“× ×™×ª ×•×ª×¢×ª×™×§";
        el("msg").className = "small err";
      }
      setTimeout(() => { el("msg").textContent = ""; }, 2000);
    }

    async function checkAvailability() {
      const body = buildRequestBody();
      const resultsDiv = el("availability_results");
      resultsDiv.innerHTML = "<div style='padding: 20px; text-align: center;'>ğŸ” ×‘×•×“×§ ×–××™× ×•×ª...</div>";
      
      // ×’× ×¢×“×›×Ÿ ××ª ×”-preview
      el("resp_preview").textContent = "×©×•×œ×—...";
      
      try {
        const r = await fetch(AVAILABILITY_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        const text = await r.text();
        let parsed;
        try { parsed = JSON.parse(text); } catch { parsed = text; }

        // ×¢×“×›×Ÿ ××ª ×”-preview (JSON ×’×•×œ××™)
        el("resp_preview").textContent = typeof parsed === "string" ? parsed : JSON.stringify(parsed, null, 2);
        
        // ×©××•×¨ ××ª ×”×ª×•×¦××•×ª
        availableCabins = Array.isArray(parsed) ? parsed : [];
        
        // ×”×¦×’ ×ª×•×¦××•×ª ×™×¤×•×ª
        displayAvailabilityResults(availableCabins);
        
        // ×’×œ×•×œ ××•×˜×•××˜×™×ª ×œ×ª×•×¦××•×ª
        setTimeout(() => {
          const availabilityCard = document.querySelector('.availability-card');
          if (availabilityCard) {
            availabilityCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        }, 100);
        
        // ×¢×“×›×Ÿ ×”×•×“×¢×”
        el("msg").textContent = `× ××¦××• ${availableCabins.length} ×¦×™××¨×™× ×–××™× ×™×`;
        el("msg").className = "small ok";
        setTimeout(() => { el("msg").textContent = ""; }, 3000);
        
      } catch (e) {
        resultsDiv.innerHTML = `<div style='color: #c00; padding: 20px;'>âŒ ×©×’×™××”: ${e?.message || e}</div>`;
        el("resp_preview").textContent = "×©×’×™××”: " + (e?.message || e);
        el("msg").textContent = "×©×’×™××” ×‘×‘×“×™×§×ª ×–××™× ×•×ª";
        el("msg").className = "small err";
      }
    }
    
    function displayAvailabilityResults(cabins) {
      const resultsDiv = el("availability_results");
      
      if (!cabins || cabins.length === 0) {
        resultsDiv.innerHTML = "<div style='padding: 20px; text-align: center; color: #c00;'>âŒ ×œ× × ××¦××• ×¦×™××¨×™× ×–××™× ×™× ×‘×ª××¨×™×›×™× ×”××‘×•×§×©×™×</div>";
        return;
      }
      
      let html = `<div style='margin-bottom: 12px;'><strong>× ××¦××• ${cabins.length} ×¦×™××¨×™× ×–××™× ×™×:</strong></div>`;
      
      cabins.forEach((cabin, index) => {
        // Get images from cabin data or fetch from API
        const images = cabin.images_urls || [];
        const cabinId = cabin.cabin_id || '';
        
        // Try to find cabin_id_string (ZB01, ZB02, etc.) from cabin name
        let searchId = cabinId;
        if (cabinId && cabinId.includes('-')) {
          // It's a UUID, try to find by name
          const cabinName = cabin.name || '';
          if (cabinName.includes('×™×•×œ×™')) {
            searchId = 'ZB01';
          } else if (cabinName.includes('×××™')) {
            searchId = 'ZB02';
          } else if (cabinName.includes('××•×¨×Ÿ') || cabinName.includes('××•×¨× ×™')) {
            searchId = 'ZB03';
          }
        }
        
        // Build image HTML
        let imagesHtml = '';
        if (images && images.length > 0) {
          imagesHtml = '<div class="cabin-images">';
          images.forEach((img, imgIndex) => {
            // Handle both local paths and full URLs
            let imgSrc = img;
            if (img.startsWith('/zimmers_pic/')) {
              // Local path - use as is
              imgSrc = img;
            } else if (img.startsWith('http://') || img.startsWith('https://')) {
              // Full URL - use as is
              imgSrc = img;
            } else if (searchId && !searchId.includes('-')) {
              // Assume it's a filename in zimmers_pic folder (only if searchId is not UUID)
              imgSrc = `/zimmers_pic/${searchId}/${img}`;
            }
            
            imagesHtml += `<img src="${imgSrc}" alt="${cabin.name || cabinId}" class="cabin-image" onerror="this.style.display='none'" />`;
          });
          imagesHtml += '</div>';
        } else {
          // Try to load default image if exists (only if searchId is not UUID)
          if (searchId && !searchId.includes('-')) {
            imagesHtml = `<div class="cabin-images">
              <img src="/zimmers_pic/${searchId}/hero-cabin.jpg" alt="${cabin.name || cabinId}" class="cabin-image" 
                   onerror="if(this.parentElement) this.parentElement.innerHTML='<div class=&quot;cabin-image-placeholder&quot;>××™×Ÿ ×ª××•× ×”</div>'" />
            </div>`;
          } else {
            imagesHtml = '<div class="cabin-image-placeholder">××™×Ÿ ×ª××•× ×”</div>';
          }
        }
        
        html += `
          <div class="cabin-item" data-cabin-id="${cabin.cabin_id}" 
               onmouseenter="showCabinAvailability('${cabin.cabin_id}')" 
               onmouseleave="hideCabinAvailability()"
               onclick="selectCabin('${cabin.cabin_id}')">
            ${imagesHtml}
            <div class="cabin-name">${cabin.name || cabin.cabin_id}</div>
            <div class="cabin-details">
              ${cabin.area ? `ğŸ“ ${cabin.area} | ` : ''}
              ${cabin.nights ? `${cabin.nights} ×œ×™×œ×•×ª | ` : ''}
              ${cabin.regular_nights ? `×¨×’×™×œ: ${cabin.regular_nights} | ` : ''}
              ${cabin.weekend_nights ? `×¡×•×¤"×©: ${cabin.weekend_nights}` : ''}
            </div>
            <div class="cabin-price">ğŸ’° â‚ª${cabin.total_price?.toFixed(2) || '0.00'}</div>
            <button class="btn-primary" style="margin-top: 12px; width: 100%;" onclick="event.stopPropagation(); selectCabin('${cabin.cabin_id}')">
              ğŸ“Š ×”×¦×’ ××—×™×¨ ××¤×•×¨×˜
            </button>
          </div>
        `;
      });
      
      resultsDiv.innerHTML = html;
      
      // Add availability table to body if doesn't exist
      if (!el("cabin_availability_table")) {
        const table = document.createElement('div');
        table.id = 'cabin_availability_table';
        table.className = 'cabin-availability-table';
        document.body.appendChild(table);
      }
    }
    
    async function selectCabin(cabinId) {
      // ×”×¡×¨ ×‘×—×™×¨×” ×§×•×“××ª
      document.querySelectorAll('.cabin-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // ×¡××Ÿ ××ª ×”× ×‘×—×¨
      const selected = document.querySelector(`[data-cabin-id="${cabinId}"]`);
      if (selected) {
        selected.classList.add('selected');
      }
      
      selectedCabinId = cabinId;
      
      // ×”×¦×’ ×˜×‘×œ×ª ××—×™×¨×™×
      el("pricing_card").style.display = "block";
      
      // ×”×¦×’ addons
      renderAddons();
      
      // ×˜×¢×Ÿ quote (×œ×œ× scroll)
      await loadQuote(cabinId);
    }
    
    async function loadQuote(cabinId, showLoading = true) {
      const checkIn = formatDateTimeForAPI(el("check_in").value);
      const checkOut = formatDateTimeForAPI(el("check_out").value);
      const adults = toNullOrNumber(el("adults").value);
      const kids = toNullOrNumber(el("kids").value);
      
      if (!checkIn || !checkOut) {
        el("pricing_table_container").innerHTML = "<div style='color: #c00; padding: 12px;'>×™×© ×œ××œ× ×ª××¨×™×›×™ ×›× ×™×¡×” ×•×™×¦×™××”</div>";
        return;
      }
      
      if (showLoading) {
        el("pricing_table_container").innerHTML = "<div style='padding: 20px; text-align: center;'>â³ ×˜×•×¢×Ÿ ×”×¦×¢×ª ××—×™×¨...</div>";
      }
      
      try {
        const quoteRequest = {
          cabin_id: cabinId,
          check_in: checkIn,
          check_out: checkOut,
          adults: adults,
          kids: kids,
          addons: selectedAddons.length > 0 ? selectedAddons : null
        };
        
        const r = await fetch(QUOTE_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(quoteRequest)
        });
        
        if (!r.ok) {
          const errorText = await r.text();
          let errorDetail = "Failed to get quote";
          try {
            const errorJson = JSON.parse(errorText);
            errorDetail = errorJson.detail || errorJson.message || errorText;
          } catch {
            errorDetail = errorText || `HTTP ${r.status}`;
          }
          throw new Error(errorDetail);
        }
        
        const quote = await r.json();
        
        currentQuote = quote;
        displayPricingTable(quote);
        renderAddons(); // Re-render to update checkboxes
        
      } catch (e) {
        el("pricing_table_container").innerHTML = `<div style='color: #c00; padding: 12px;'>âŒ ×©×’×™××”: ${e?.message || e}</div>`;
      }
    }
    
    function displayPricingTable(quote) {
      // Helper function to safely format numbers
      const fmt = (val) => {
        if (val == null || val === undefined) return '0.00';
        const num = typeof val === 'number' ? val : parseFloat(val);
        return isNaN(num) ? '0.00' : num.toFixed(2);
      };
      
      const safeGet = (obj, key, def = 0) => {
        const val = obj && obj[key];
        return val != null ? val : def;
      };
      
      const nights = safeGet(quote, 'nights', 0);
      const regularNights = safeGet(quote, 'regular_nights', 0);
      const weekendNights = safeGet(quote, 'weekend_nights', 0);
      const holidayNights = safeGet(quote, 'holiday_nights', 0);
      const highSeasonNights = safeGet(quote, 'high_season_nights', 0);
      const baseTotal = safeGet(quote, 'base_total', 0);
      const weekendSurcharge = safeGet(quote, 'weekend_surcharge', 0);
      const holidaySurcharge = safeGet(quote, 'holiday_surcharge', 0);
      const highSeasonSurcharge = safeGet(quote, 'high_season_surcharge', 0);
      const addonsTotal = safeGet(quote, 'addons_total', 0);
      const subtotal = safeGet(quote, 'subtotal', 0);
      const discount = quote && quote.discount ? quote.discount : null;
      const discountAmount = discount ? safeGet(discount, 'amount', 0) : 0;
      const discountPercent = discount ? safeGet(discount, 'percent', 0) : 0;
      const total = safeGet(quote, 'total', safeGet(quote, 'total_price', 0)); // Support both 'total' and 'total_price'
      
      // Get cabin images if available
      const cabinId = quote.cabin_id || '';
      // Try to find cabin_id_string (ZB01, ZB02, etc.) from cabin name
      let searchId = cabinId;
      if (cabinId && cabinId.includes('-')) {
        // It's a UUID, try to find by name
        const cabinName = quote.cabin_name || '';
        if (cabinName.includes('×™×•×œ×™')) {
          searchId = 'ZB01';
        } else if (cabinName.includes('×××™')) {
          searchId = 'ZB02';
        } else if (cabinName.includes('××•×¨×Ÿ') || cabinName.includes('××•×¨× ×™')) {
          searchId = 'ZB03';
        }
      }
      
      let imagesHtml = '';
      if (searchId && !searchId.includes('-')) {
        // Try to load default image (only if searchId is not UUID)
        imagesHtml = `<div style="margin: 12px 0; text-align: center;">
          <img src="/zimmers_pic/${searchId}/hero-cabin.jpg" alt="${quote.cabin_name || cabinId}" class="cabin-image-main" 
               onerror="this.style.display='none'" />
        </div>`;
      }
      
      let html = `
        <div style="margin-bottom: 12px; padding: 8px; background: #f5f5f5; border-radius: 6px;">
          <strong>${quote.cabin_name || quote.cabin_id || 'N/A'}</strong><br/>
          <small>${quote.check_in || ''} â†’ ${quote.check_out || ''}</small>
        </div>
        ${imagesHtml}
        <table class="pricing-table">
          <tr>
            <td class="label">××¡×¤×¨ ×œ×™×œ×•×ª:</td>
            <td class="value">${nights}</td>
          </tr>
          <tr>
            <td class="label">×œ×™×œ×•×ª ×¨×’×™×œ×™×:</td>
            <td class="value">${regularNights}</td>
          </tr>
          ${weekendNights > 0 ? `
          <tr class="surcharge-row">
            <td class="label">×œ×™×œ×•×ª ×¡×•×¤"×©:</td>
            <td class="value">${weekendNights}</td>
          </tr>
          ` : ''}
          ${holidayNights > 0 ? `
          <tr class="surcharge-row">
            <td class="label">×œ×™×œ×•×ª ×—×’:</td>
            <td class="value">${holidayNights}</td>
          </tr>
          ` : ''}
          ${highSeasonNights > 0 ? `
          <tr class="surcharge-row">
            <td class="label">×œ×™×œ×•×ª ×¢×•× ×” ×’×‘×•×”×”:</td>
            <td class="value">${highSeasonNights}</td>
          </tr>
          ` : ''}
          <tr style="border-top: 2px solid #ddd;">
            <td class="label">××—×™×¨ ×‘×¡×™×¡:</td>
            <td class="value">â‚ª${fmt(baseTotal)}</td>
          </tr>
          ${weekendSurcharge > 0 ? `
          <tr class="surcharge-row">
            <td class="label">×ª×•×¡×¤×ª ×¡×•×¤"×©:</td>
            <td class="value">+â‚ª${fmt(weekendSurcharge)}</td>
          </tr>
          ` : ''}
          ${holidaySurcharge > 0 ? `
          <tr class="surcharge-row">
            <td class="label">×ª×•×¡×¤×ª ×—×’×™×:</td>
            <td class="value">+â‚ª${fmt(holidaySurcharge)}</td>
          </tr>
          ` : ''}
          ${highSeasonSurcharge > 0 ? `
          <tr class="surcharge-row">
            <td class="label">×ª×•×¡×¤×ª ×¢×•× ×” ×’×‘×•×”×”:</td>
            <td class="value">+â‚ª${fmt(highSeasonSurcharge)}</td>
          </tr>
          ` : ''}
          ${addonsTotal > 0 ? `
          <tr>
            <td class="label">×ª×•×¡×¤×•×ª:</td>
            <td class="value">+â‚ª${fmt(addonsTotal)}</td>
          </tr>
          ` : ''}
          <tr style="border-top: 2px solid #ddd;">
            <td class="label">×¡×”"×› ×‘×™× ×™×™×:</td>
            <td class="value">â‚ª${fmt(subtotal)}</td>
          </tr>
          ${discountAmount > 0 ? `
          <tr class="discount-row">
            <td class="label">×”× ×—×” (${fmt(discountPercent)}%):</td>
            <td class="value">-â‚ª${fmt(discountAmount)}</td>
          </tr>
          ${discount && discount.reason ? `
          <tr class="discount-row">
            <td class="label">×¡×™×‘×ª ×”× ×—×”:</td>
            <td class="value">${discount.reason}</td>
          </tr>
          ` : ''}
          ` : ''}
          <tr class="total-row">
            <td class="label">×¡×”"×› ×¡×•×¤×™:</td>
            <td class="value">â‚ª${fmt(total)}</td>
          </tr>
        </table>
      `;
      
      el("pricing_table_container").innerHTML = html;
      el("btn_book_final").style.display = "block";
      el("btn_create_hold").style.display = "block";
      
      // ×× ×™×© Hold ×¤×¢×™×œ, ×”×¦×’ ××•×ª×•
      if (currentHoldId) {
        updateHoldStatus();
      }
    }
    
    function renderAddons() {
      const container = el("addons_container");
      container.innerHTML = "";
      
      AVAILABLE_ADDONS.forEach(addon => {
        const isSelected = selectedAddons.some(a => a.name === addon.name);
        const div = document.createElement("div");
        div.className = `addon-item ${isSelected ? 'selected' : ''}`;
        div.innerHTML = `
          <input type="checkbox" id="addon_${addon.key}" ${isSelected ? 'checked' : ''} />
          <label for="addon_${addon.key}">${addon.name}</label>
          <span class="addon-price">â‚ª${addon.price}</span>
        `;
        
        // Add event listener properly
        const checkbox = div.querySelector(`#addon_${addon.key}`);
        if (checkbox) {
          checkbox.addEventListener('change', function(e) {
            e.preventDefault();
            e.stopPropagation();
            toggleAddon(addon.key, addon.price, addon.name, e);
          });
          
          // Also prevent click propagation on the label
          const label = div.querySelector(`label[for="addon_${addon.key}"]`);
          if (label) {
            label.addEventListener('click', function(e) {
              e.stopPropagation();
            });
          }
        }
        container.appendChild(div);
      });
    }
    
    function toggleAddon(key, price, name, event) {
      // Prevent default behavior and stop propagation if event is provided
      if (event) {
        event.preventDefault();
        event.stopPropagation();
      }
      
      const checkbox = el(`addon_${key}`);
      if (!checkbox) {
        console.error(`Checkbox not found: addon_${key}`);
        return;
      }
      
      const addonItem = { name: name, price: price };
      
      if (checkbox.checked) {
        if (!selectedAddons.some(a => a.name === name)) {
          selectedAddons.push(addonItem);
        }
      } else {
        selectedAddons = selectedAddons.filter(a => a.name !== name);
      }
      
      // ×¢×“×›×Ÿ ××ª ×”-visual ××™×“
      const item = checkbox.closest('.addon-item');
      if (item) {
        if (checkbox.checked) {
          item.classList.add('selected');
        } else {
          item.classList.remove('selected');
        }
      }
      
      // ×¢×“×›×Ÿ ××ª ×”-quote ×¢× ×”-addons ×”×—×“×©×™× (×œ×œ× scroll, ×œ×œ× loading message)
      if (selectedCabinId) {
        loadQuote(selectedCabinId, false).catch(err => {
          console.error('Error loading quote:', err);
        });
      }
      
      return false; // Prevent any default behavior
    }
    
    function openBookingModal(cabinId) {
      // ×× ×™×© quote, ×”×©×ª××© ×‘×•
      if (cabinId && !currentQuote) {
        selectCabin(cabinId).then(() => {
          setTimeout(() => openBookingModal(cabinId), 500);
        });
        return;
      }
      
      el("modal_cabin_id").value = cabinId;
      el("modal_customer").value = "";
      el("modal_phone").value = "";
      el("modal_email").value = "";
      el("modal_notes").value = "";
      el("booking_result").innerHTML = "";
      
      // ×”×¦×’ ×ª××•× ×” ×©×œ ×”×¦×™××¨ ×× ×™×© quote ××• cabin info
      const imageContainer = el("booking_cabin_image");
      const imageSrc = el("booking_cabin_image_src");
      if (currentQuote && currentQuote.cabin_name) {
        // × ×¡×” ×œ××¦×•× ××ª cabin_id_string ×œ×¤×™ ×©×
        let searchId = cabinId;
        if (cabinId && cabinId.includes('-')) {
          const cabinName = currentQuote.cabin_name || '';
          if (cabinName.includes('×™×•×œ×™')) {
            searchId = 'ZB01';
          } else if (cabinName.includes('×××™')) {
            searchId = 'ZB02';
          } else if (cabinName.includes('××•×¨×Ÿ') || cabinName.includes('××•×¨× ×™')) {
            searchId = 'ZB03';
          }
        }
        if (searchId && !searchId.includes('-')) {
          imageSrc.src = `/zimmers_pic/${searchId}/hero-cabin.jpg`;
          imageContainer.style.display = 'block';
        } else {
          imageContainer.style.display = 'none';
        }
      } else {
        // × ×¡×” ×œ××¦×•× ×œ×¤×™ cabinId
        let searchId = cabinId;
        if (cabinId && cabinId.includes('-')) {
          // ×–×” UUID, × ×¡×” ×œ××¦×•× ×œ×¤×™ cabin_id_string
          const cabin = availableCabins.find(c => c.cabin_id === cabinId);
          if (cabin && cabin.name) {
            const cabinName = cabin.name;
            if (cabinName.includes('×™×•×œ×™')) {
              searchId = 'ZB01';
            } else if (cabinName.includes('×××™')) {
              searchId = 'ZB02';
            } else if (cabinName.includes('××•×¨×Ÿ') || cabinName.includes('××•×¨× ×™')) {
              searchId = 'ZB03';
            }
          }
        }
        if (searchId && !searchId.includes('-')) {
          imageSrc.src = `/zimmers_pic/${searchId}/hero-cabin.jpg`;
          imageContainer.style.display = 'block';
        } else {
          imageContainer.style.display = 'none';
        }
      }
      
      // ×¢×“×›×Ÿ ××ª ×”-JSON preview
      updateBookingJson();
      
      el("bookingModal").style.display = "block";
    }
    
    function updateBookingJson() {
      // Get total price from current quote if available
      const totalPrice = currentQuote ? (currentQuote.total || currentQuote.total_price || null) : null;
      
      const bookingJson = {
        cabin_id: el("modal_cabin_id").value,
        customer: el("modal_customer").value || null,
        phone: el("modal_phone").value.trim() || null,
        email: el("modal_email").value.trim() || null,
        notes: el("modal_notes").value.trim() || null,
        check_in: formatDateTimeForAPI(el("check_in").value),
        check_out: formatDateTimeForAPI(el("check_out").value),
        total_price: totalPrice
      };
      
      // ×”×•×¡×£ addons ×× ×™×©
      if (selectedAddons.length > 0) {
        bookingJson.addons = selectedAddons;
      }
      
      el("modal_json_preview").textContent = JSON.stringify(bookingJson, null, 2);
    }
    
    function closeBookingModal() {
      el("bookingModal").style.display = "none";
    }
    
    // Hold Management Functions
    async function createHold() {
      // Use selectedCabinId or get from modal
      const cabinId = selectedCabinId || el("modal_cabin_id")?.value;
      
      if (!cabinId) {
        alert("×× × ×‘×—×¨ ×¦×™××¨ ×§×•×“× - ×œ×—×¥ ×¢×œ ×¦×™××¨ ××”×¨×©×™××”");
        return;
      }
      
      const checkIn = formatDateTimeForAPI(el("check_in").value);
      const checkOut = formatDateTimeForAPI(el("check_out").value);
      
      if (!checkIn || !checkOut) {
        alert("×× × ×‘×—×¨ ×ª××¨×™×›×™ ×›× ×™×¡×” ×•×™×¦×™××”");
        return;
      }
      
      const customer = el("modal_customer")?.value || "×œ×§×•×—";
      
      el("btn_create_hold").disabled = true;
      el("btn_create_hold").textContent = "â³ ×™×•×¦×¨ Hold...";
      
      try {
        const holdData = {
          cabin_id: cabinId,
          check_in: checkIn,
          check_out: checkOut,
          customer_name: customer
        };
        
        const r = await fetch(HOLD_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(holdData)
        });
        
        const result = await r.json();
        
        if (r.ok && result.hold_id) {
          currentHoldId = result.hold_id;
          holdExpiresAt = new Date(result.expires_at);
          
          el("hold_status_container").style.display = "block";
          el("btn_create_hold").style.display = "none";
          el("btn_book_final").style.display = "block";
          
          updateHoldStatus();
          startHoldCountdown();
          
          alert(`âœ… Hold × ×•×¦×¨ ×‘×”×¦×œ×—×”!\n×ª×¤×•×’×”: ${result.expires_at}\n×™×© ×œ×š 15 ×“×§×•×ª ×œ×”×©×œ×™× ××ª ×”×”×–×× ×”.`);
        } else {
          alert(`âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª Hold: ${result.detail || result.message || JSON.stringify(result)}`);
          el("btn_create_hold").disabled = false;
          el("btn_create_hold").textContent = "ğŸ”’ ×¦×•×¨ Hold (15 ×“×§×•×ª)";
        }
      } catch (e) {
        alert(`âŒ ×©×’×™××”: ${e?.message || e}`);
        el("btn_create_hold").disabled = false;
        el("btn_create_hold").textContent = "ğŸ”’ ×¦×•×¨ Hold (15 ×“×§×•×ª)";
      }
    }
    
    async function cancelHold() {
      if (!currentHoldId) return;
      
      if (!confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×‘×˜×œ ××ª ×”-Hold?")) {
        return;
      }
      
      try {
        const r = await fetch(`${HOLD_URL}/${currentHoldId}`, {
          method: "DELETE"
        });
        
        if (r.ok) {
          currentHoldId = null;
          holdExpiresAt = null;
          el("hold_status_container").style.display = "none";
          el("btn_create_hold").style.display = "block";
          
          if (holdCountdownInterval) {
            clearInterval(holdCountdownInterval);
            holdCountdownInterval = null;
          }
          
          alert("âœ… Hold ×‘×•×˜×œ ×‘×”×¦×œ×—×”");
        } else {
          const result = await r.json();
          alert(`âŒ ×©×’×™××” ×‘×‘×™×˜×•×œ Hold: ${result.detail || result.message}`);
        }
      } catch (e) {
        alert(`âŒ ×©×’×™××”: ${e?.message || e}`);
      }
    }
    
    function updateHoldStatus() {
      if (!holdExpiresAt) return;
      
      const now = new Date();
      const diff = holdExpiresAt - now;
      
      if (diff <= 0) {
        // Hold ×¤×’ ×ª×•×§×£
        currentHoldId = null;
        holdExpiresAt = null;
        el("hold_status_container").style.display = "none";
        el("btn_create_hold").style.display = "block";
        
        if (holdCountdownInterval) {
          clearInterval(holdCountdownInterval);
          holdCountdownInterval = null;
        }
        
        alert("â° Hold ×¤×’ ×ª×•×§×£. ×× × ×¦×•×¨ Hold ×—×“×©.");
        return;
      }
      
      const minutes = Math.floor(diff / 60000);
      const seconds = Math.floor((diff % 60000) / 1000);
      
      el("hold_countdown").textContent = `× ×©××¨×•: ${minutes}:${seconds.toString().padStart(2, '0')} ×“×§×•×ª`;
    }
    
    function startHoldCountdown() {
      if (holdCountdownInterval) {
        clearInterval(holdCountdownInterval);
      }
      
      updateHoldStatus();
      holdCountdownInterval = setInterval(updateHoldStatus, 1000);
    }
    
    async function createBooking(event) {
      event.preventDefault();
      
      const cabinId = el("modal_cabin_id").value;
      const customer = el("modal_customer").value;
      const phone = el("modal_phone").value;
      const email = el("modal_email").value;
      const notes = el("modal_notes").value;
      const checkIn = formatDateTimeForAPI(el("check_in").value);
      const checkOut = formatDateTimeForAPI(el("check_out").value);
      
      if (!cabinId || !customer || !checkIn || !checkOut) {
        el("booking_result").innerHTML = "<div style='color: #c00; padding: 10px; background: #ffebee; border-radius: 4px;'>âŒ ×™×© ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”× ×“×¨×©×™×</div>";
        return;
      }
      
      // Get total price from current quote if available
      const totalPrice = currentQuote ? (currentQuote.total || currentQuote.total_price || null) : null;
      
      const bookingData = {
        cabin_id: cabinId,
        customer: customer,
        phone: phone || null,
        email: email || null,
        notes: notes || null,
        check_in: checkIn,
        check_out: checkOut,
        adults: parseInt(el("adults").value) || null,
        kids: parseInt(el("kids").value) || null,
        total_price: totalPrice
      };
      
      // ×”×•×¡×£ hold_id ×× ×§×™×™×
      if (currentHoldId) {
        bookingData.hold_id = currentHoldId;
      }
      
      // ×”×•×¡×£ addons ×× ×™×©
      if (selectedAddons.length > 0) {
        bookingData.addons = selectedAddons;
      }
      
      // ×”×•×¡×£ ×ª××™×›×” ×‘×ª×©×œ×•× (×©×œ×‘ 5)
      // ×‘×“×•×§ ×× ×™×© checkbox ××• ××¤×©×¨×•×ª ××—×¨×ª ×œ×™×¦×™×¨×ª ×ª×©×œ×•×
      // ×‘×™× ×ª×™×™×, × ×©×ª××© ×‘-create_payment: true ×× ×™×© ××—×™×¨
      if (totalPrice && totalPrice > 0) {
        bookingData.create_payment = true;
      }
      
      el("booking_result").innerHTML = "<div style='padding: 10px;'>â³ ×™×•×¦×¨ ×”×–×× ×”...</div>";
      
      try {
        const r = await fetch(BOOKING_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(bookingData)
        });
        
        const text = await r.text();
        let result;
        try { result = JSON.parse(text); } catch { result = { error: text }; }
        
        if (r.ok && result.success) {
          // × ×§×” Hold ××—×¨×™ ×”×–×× ×” ××•×¦×œ×—×ª
          if (currentHoldId) {
            currentHoldId = null;
            holdExpiresAt = null;
            el("hold_status_container").style.display = "none";
            el("btn_create_hold").style.display = "block";
            
            if (holdCountdownInterval) {
              clearInterval(holdCountdownInterval);
              holdCountdownInterval = null;
            }
          }
          
          // ×‘×“×•×§ ×× ×™×© Payment Intent
          const hasPayment = result.payment_intent_id && result.client_secret;
          
          // ×©××•×¨ ××ª ×¤×¨×˜×™ ×”×ª×©×œ×•× ×œ××©×ª× ×” ×’×œ×•×‘×œ×™
          if (hasPayment) {
            window.currentPaymentIntent = {
              payment_intent_id: result.payment_intent_id,
              client_secret: result.client_secret,
              booking_id: result.booking_id,
              amount: totalPrice || 0
            };
          }
          
          el("booking_result").innerHTML = `
            <div style='color: #0a7; padding: 15px; background: #e8f5e9; border-radius: 8px; border: 2px solid #4caf50;'>
              <div style='text-align: center; margin-bottom: 15px;'>
                <div style='font-size: 48px; margin-bottom: 10px;'>âœ…</div>
                <h2 style='margin: 0; color: #2e7d32;'>×”×–×× ×” × ×•×¦×¨×” ×‘×”×¦×œ×—×”!</h2>
              </div>
              <div style='background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px;'>
                ${result.booking_id ? `<p><strong>××¡×¤×¨ ×”×–×× ×”:</strong> ${result.booking_id.substring(0, 8)}...</p>` : ''}
                <p><strong>Event ID:</strong> ${result.event_id || 'N/A'}</p>
                ${result.event_link ? `<p><a href="${result.event_link}" target="_blank" style='color: #2196F3; text-decoration: none;'>ğŸ”— ×¤×ª×— ×‘×™×•××Ÿ Google</a></p>` : ''}
                ${totalPrice ? `<p><strong>×¡×›×•× ×œ×ª×©×œ×•×:</strong> ${totalPrice} ILS</p>` : ''}
              </div>
              ${hasPayment || (totalPrice && totalPrice > 0) ? `
                <div style='text-align: center; margin-top: 20px;'>
                  <button onclick="openPaymentModal()" 
                          style='padding: 15px 30px; background: #4caf50; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.2);'>
                    ğŸ’³ ${hasPayment ? '×”××©×š ×œ×ª×©×œ×•×' : '×”××©×š ×œ×ª×©×œ×•× (×‘×“×™×§×”)'}
                  </button>
                </div>
              ` : `
                <div style='padding: 10px; background: #fff3cd; border-radius: 6px; margin-top: 15px; text-align: center;'>
                  <p style='margin: 0; color: #856404;'>â„¹ï¸ ×ª×©×œ×•× ×œ× ××•×’×“×¨ - ×”×–×× ×” × ×•×¦×¨×” ×œ×œ× ×ª×©×œ×•×</p>
                </div>
                <div style='text-align: center; margin-top: 15px;'>
                  <button onclick="closeBookingModal(); checkAvailability();" 
                          style='padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer;'>
                    ×¡×’×•×¨
                  </button>
                </div>
              `}
            </div>
          `;
          
          // ×× ×™×© ×ª×©×œ×•×, ×¤×ª×— ××ª modal ×”×ª×©×œ×•× ××•×˜×•××˜×™×ª ××—×¨×™ 2 ×©× ×™×•×ª
          // ×’× ×× ××™×Ÿ Payment Intent, ×¤×ª×— modal ×œ×‘×“×™×§×”
          if (hasPayment) {
            setTimeout(() => {
              openPaymentModal();
            }, 2000);
          } else if (totalPrice && totalPrice > 0) {
            // ×’× ×‘×œ×™ Payment Intent, ×¤×ª×— modal ×ª×©×œ×•× ×œ×‘×“×™×§×”
            window.currentPaymentIntent = {
              payment_intent_id: null,
              client_secret: null,
              booking_id: result.booking_id,
              amount: totalPrice || 0,
              is_mock: true // ×¡×™××•×Ÿ ×©×–×” mock ×œ×‘×“×™×§×”
            };
            setTimeout(() => {
              openPaymentModal();
            }, 2000);
          }
        } else {
          el("booking_result").innerHTML = `
            <div style='color: #c00; padding: 10px; background: #ffebee; border-radius: 4px;'>
              âŒ <strong>×©×’×™××” ×‘×™×¦×™×¨×ª ×”×–×× ×”:</strong><br/>
              ${result.detail || result.message || JSON.stringify(result)}
            </div>
          `;
        }
      } catch (e) {
        el("booking_result").innerHTML = `
          <div style='color: #c00; padding: 10px; background: #ffebee; border-radius: 4px;'>
            âŒ <strong>×©×’×™××”:</strong> ${e?.message || e}
          </div>
        `;
      }
    }
    
    // Payment Modal Functions
    function openPaymentModal() {
      const paymentIntent = window.currentPaymentIntent;
      if (!paymentIntent) {
        alert('××™×Ÿ ×¤×¨×˜×™ ×ª×©×œ×•× ×–××™× ×™×');
        return;
      }
      
      const isMock = paymentIntent.is_mock || !paymentIntent.client_secret;
      const content = el("payment_content");
      
      if (isMock) {
        // Mock payment modal for testing
        content.innerHTML = `
          <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="margin-top: 0; color: #333;">×¤×¨×˜×™ ×”×ª×©×œ×•× (××¦×‘ ×‘×“×™×§×”)</h3>
            <p><strong>××¡×¤×¨ ×”×–×× ×”:</strong> ${paymentIntent.booking_id ? paymentIntent.booking_id.substring(0, 8) + '...' : 'N/A'}</p>
            <p><strong>×¡×›×•× ×œ×ª×©×œ×•×:</strong> <span style="font-size: 24px; color: #4caf50; font-weight: bold;">${paymentIntent.amount} ILS</span></p>
            <div style="background: #fff3cd; padding: 10px; border-radius: 6px; margin-top: 10px;">
              <p style="margin: 0; color: #856404;">âš ï¸ ×–×”×• ××¦×‘ ×‘×“×™×§×” - Stripe ×œ× ××•×’×“×¨</p>
            </div>
          </div>
          
          <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h4 style="margin-top: 0; color: #1976d2;">ğŸ’³ ×©×™×˜×•×ª ×ª×©×œ×•× ×–××™× ×•×ª (×œ××—×¨ ×”×’×“×¨×ª Stripe):</h4>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px;">
              <div style="padding: 15px; background: white; border-radius: 6px; text-align: center; border: 2px solid #ddd;">
                <div style="font-size: 32px; margin-bottom: 5px;">ğŸ’³</div>
                <strong>×›×¨×˜×™×¡ ××©×¨××™</strong>
              </div>
              <div style="padding: 15px; background: white; border-radius: 6px; text-align: center; border: 2px solid #ddd;">
                <div style="font-size: 32px; margin-bottom: 5px;">ğŸ“±</div>
                <strong>×‘×™×˜</strong>
              </div>
              <div style="padding: 15px; background: white; border-radius: 6px; text-align: center; border: 2px solid #ddd;">
                <div style="font-size: 32px; margin-bottom: 5px;">ğŸ”µ</div>
                <strong>×¤×™×™×‘×•×§×¡</strong>
              </div>
              <div style="padding: 15px; background: white; border-radius: 6px; text-align: center; border: 2px solid #ddd;">
                <div style="font-size: 32px; margin-bottom: 5px;">ğŸ’µ</div>
                <strong>××–×•××Ÿ ×‘××§×•×</strong>
              </div>
            </div>
          </div>
          
          <div style="text-align: center; margin-top: 30px;">
            <button onclick="closePaymentModal(); closeBookingModal(); checkAvailability();" 
                    style="padding: 12px 24px; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin: 5px;">
              ×¡×’×•×¨
            </button>
          </div>
        `;
      } else {
        // Real Stripe payment modal
        content.innerHTML = `
          <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="margin-top: 0; color: #333;">×¤×¨×˜×™ ×”×ª×©×œ×•×</h3>
            <p><strong>××¡×¤×¨ ×”×–×× ×”:</strong> ${paymentIntent.booking_id ? paymentIntent.booking_id.substring(0, 8) + '...' : 'N/A'}</p>
            <p><strong>×¡×›×•× ×œ×ª×©×œ×•×:</strong> <span style="font-size: 24px; color: #4caf50; font-weight: bold;">${paymentIntent.amount} ILS</span></p>
            <p><strong>Payment Intent ID:</strong> <small style="font-family: monospace;">${paymentIntent.payment_intent_id}</small></p>
          </div>
          
          <!-- Stripe Checkout Form -->
          <div id="stripe_checkout_container" style="margin-bottom: 20px;">
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
              <h4 style="margin-top: 0; color: #1976d2;">ğŸ’³ ×‘×—×¨ ×©×™×˜×ª ×ª×©×œ×•×:</h4>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
                <label style="padding: 12px; background: white; border-radius: 6px; cursor: pointer; border: 2px solid #ddd; text-align: center;">
                  <input type="radio" name="payment_method" value="card" checked style="margin-left: 5px;">
                  ğŸ’³ ×›×¨×˜×™×¡ ××©×¨××™
                </label>
                <label style="padding: 12px; background: white; border-radius: 6px; cursor: pointer; border: 2px solid #ddd; text-align: center;">
                  <input type="radio" name="payment_method" value="bit" style="margin-left: 5px;">
                  ğŸ“± ×‘×™×˜
                </label>
                <label style="padding: 12px; background: white; border-radius: 6px; cursor: pointer; border: 2px solid #ddd; text-align: center;">
                  <input type="radio" name="payment_method" value="paybox" style="margin-left: 5px;">
                  ğŸ”µ ×¤×™×™×‘×•×§×¡
                </label>
                <label style="padding: 12px; background: white; border-radius: 6px; cursor: pointer; border: 2px solid #ddd; text-align: center;">
                  <input type="radio" name="payment_method" value="cash" style="margin-left: 5px;">
                  ğŸ’µ ××–×•××Ÿ ×‘××§×•×
                </label>
              </div>
            </div>
            
            <!-- Stripe Elements will be mounted here -->
            <div id="stripe_card_element" style="padding: 15px; background: white; border-radius: 8px; border: 2px solid #ddd; margin-bottom: 15px;">
              <p style="margin: 0; color: #666;">×˜×•×¢×Ÿ ×˜×•×¤×¡ ×ª×©×œ×•×...</p>
            </div>
            
            <div id="stripe_error" style="color: #c00; margin-bottom: 15px; display: none;"></div>
            
            <button id="stripe_submit_btn" onclick="processStripePayment()" 
                    style="width: 100%; padding: 15px; background: #4caf50; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold;">
              ğŸ’³ ×©×œ× ${paymentIntent.amount} ILS
            </button>
          </div>
          
          <div style="text-align: center; margin-top: 20px;">
            <button onclick="window.open('https://dashboard.stripe.com/test/payments', '_blank')" 
                    style="padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; margin: 5px;">
              ğŸ”— ×¤×ª×— Stripe Dashboard
            </button>
            <button onclick="closePaymentModal(); closeBookingModal(); checkAvailability();" 
                    style="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; margin: 5px;">
              ×‘×™×˜×•×œ
            </button>
          </div>
        `;
        
        // Initialize Stripe Elements
        if (paymentIntent.client_secret) {
          initializeStripeCheckout(paymentIntent.client_secret);
        }
      }
      
      el("paymentModal").style.display = "block";
    }
    
    // Initialize Stripe Checkout
    let stripe = null;
    let cardElement = null;
    let elements = null;
    
    function initializeStripeCheckout(clientSecret) {
      // Load Stripe.js
      if (!window.Stripe) {
        const script = document.createElement('script');
        script.src = 'https://js.stripe.com/v3/';
        script.onload = () => {
          stripe = Stripe('pk_test_51Q...'); // Replace with your publishable key
          elements = stripe.elements();
          cardElement = elements.create('card', {
            style: {
              base: {
                fontSize: '16px',
                color: '#424770',
                '::placeholder': {
                  color: '#aab7c4',
                },
              },
            },
          });
          cardElement.mount('#stripe_card_element');
        };
        document.head.appendChild(script);
      } else {
        stripe = Stripe('pk_test_51Q...'); // Replace with your publishable key
        elements = stripe.elements();
        cardElement = elements.create('card');
        cardElement.mount('#stripe_card_element');
      }
    }
    
    async function processStripePayment() {
      const paymentIntent = window.currentPaymentIntent;
      if (!paymentIntent || !paymentIntent.client_secret) {
        alert('××™×Ÿ ×¤×¨×˜×™ ×ª×©×œ×•× ×–××™× ×™×');
        return;
      }
      
      const selectedMethod = document.querySelector('input[name="payment_method"]:checked').value;
      
      if (selectedMethod === 'cash') {
        // Cash payment - mark as completed manually
        alert('×ª×©×œ×•× ×‘××–×•××Ÿ - ×”×”×–×× ×” ×ª××•×©×¨ ×œ××—×¨ ×”×ª×©×œ×•× ×‘××§×•×');
        closePaymentModal();
        closeBookingModal();
        checkAvailability();
        return;
      }
      
      if (!stripe || !cardElement) {
        alert('Stripe ×œ× × ×˜×¢×Ÿ. ×× × ×¨×¢× ×Ÿ ××ª ×”×“×£.');
        return;
      }
      
      const submitBtn = el("stripe_submit_btn");
      const errorDiv = el("stripe_error");
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'â³ ××¢×‘×“ ×ª×©×œ×•×...';
      errorDiv.style.display = 'none';
      
      try {
        const {error, paymentIntent: confirmedPayment} = await stripe.confirmCardPayment(
          paymentIntent.client_secret,
          {
            payment_method: {
              card: cardElement,
            }
          }
        );
        
        if (error) {
          errorDiv.textContent = error.message;
          errorDiv.style.display = 'block';
          submitBtn.disabled = false;
          submitBtn.textContent = `ğŸ’³ ×©×œ× ${paymentIntent.amount} ILS`;
        } else if (confirmedPayment && confirmedPayment.status === 'succeeded') {
          el("payment_content").innerHTML = `
            <div style="text-align: center; padding: 40px;">
              <div style="font-size: 64px; margin-bottom: 20px;">âœ…</div>
              <h2 style="color: #4caf50; margin-bottom: 20px;">×ª×©×œ×•× ×”×•×©×œ× ×‘×”×¦×œ×—×”!</h2>
              <p style="color: #666; margin-bottom: 30px;">×”×”×–×× ×” ×©×œ×š ××•×©×¨×” ×•×ª×ª×§×‘×œ ×”×•×“×¢×” ×‘××™×™×œ</p>
              <button onclick="closePaymentModal(); closeBookingModal(); checkAvailability();" 
                      style="padding: 15px 30px; background: #4caf50; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                ×¡×’×•×¨
              </button>
            </div>
          `;
        }
      } catch (err) {
        errorDiv.textContent = '×©×’×™××” ×‘×¢×™×‘×•×“ ×”×ª×©×œ×•×: ' + err.message;
        errorDiv.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = `ğŸ’³ ×©×œ× ${paymentIntent.amount} ILS`;
      }
    }
    
    function closePaymentModal() {
      el("paymentModal").style.display = "none";
    }
    
    function copyClientSecret() {
      const paymentIntent = window.currentPaymentIntent;
      if (!paymentIntent || !paymentIntent.client_secret) {
        alert('××™×Ÿ Client Secret ×œ×”×¢×ª×§×”');
        return;
      }
      
      navigator.clipboard.writeText(paymentIntent.client_secret).then(() => {
        alert('âœ… Client Secret ×”×•×¢×ª×§ ×œ×œ×•×—!');
      }).catch(err => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = paymentIntent.client_secret;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('âœ… Client Secret ×”×•×¢×ª×§ ×œ×œ×•×—!');
      });
    }
    
    // ×¡×’×™×¨×ª modal ×‘×œ×—×™×¦×” ×¢×œ X ××• ××—×•×¥ ×œ×—×œ×•×Ÿ
    window.onclick = function(event) {
      const bookingModal = el("bookingModal");
      const paymentModal = el("paymentModal");
      if (event.target == bookingModal) {
        closeBookingModal();
      }
      if (event.target == paymentModal) {
        closePaymentModal();
      }
    }
    
    document.querySelector('.close').onclick = closeBookingModal;

    // Date Range Picker Variables
    let dateRangeStart = null;
    let dateRangeEnd = null;
    let currentCalendarMonth = new Date().getMonth();
    let currentCalendarYear = new Date().getFullYear();
    
    // Date Range Picker Functions
    function toggleDateRangePicker() {
      const picker = el("date_range_picker");
      picker.classList.toggle("visible");
      if (picker.classList.contains("visible")) {
        renderDateRangeCalendar();
      }
    }
    
    function renderDateRangeCalendar() {
      const grid = el("calendar_grid_range");
      const monthNames = ['×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™', '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'];
      const dayNames = ['×', '×‘', '×’', '×“', '×”', '×•', '×©'];
      
      el("calendar_month_display").textContent = `${monthNames[currentCalendarMonth]} ${currentCalendarYear}`;
      
      const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1);
      const lastDay = new Date(currentCalendarYear, currentCalendarMonth + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay();
      
      let html = '';
      
      // Day headers
      dayNames.forEach(day => {
        html += `<div class="calendar-day-header">${day}</div>`;
      });
      
      // Days from previous month
      for (let i = 0; i < startingDayOfWeek; i++) {
        const date = new Date(currentCalendarYear, currentCalendarMonth, -i);
        html += `<div class="calendar-day-range other-month">${date.getDate()}</div>`;
      }
      
      // Days of current month
      const today = new Date();
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(currentCalendarYear, currentCalendarMonth, day);
        const dateStr = date.toISOString().split('T')[0];
        const isToday = date.toDateString() === today.toDateString();
        
        let classes = 'calendar-day-range';
        if (isToday) classes += ' today';
        
        // Check if in range
        if (dateRangeStart && dateRangeEnd) {
          if (dateStr === dateRangeStart) {
            classes += ' range-start';
          } else if (dateStr === dateRangeEnd) {
            classes += ' range-end';
          } else if (dateStr > dateRangeStart && dateStr < dateRangeEnd) {
            classes += ' in-range';
          }
        } else if (dateRangeStart && dateStr === dateRangeStart) {
          classes += ' range-start';
        }
        
        html += `<div class="${classes}" data-date="${dateStr}" onclick="selectDateRange('${dateStr}')">${day}</div>`;
      }
      
      // Days from next month
      const totalCells = startingDayOfWeek + daysInMonth;
      const remainingCells = 7 - (totalCells % 7);
      if (remainingCells < 7) {
        for (let day = 1; day <= remainingCells; day++) {
          const date = new Date(currentCalendarYear, currentCalendarMonth + 1, day);
          html += `<div class="calendar-day-range other-month">${date.getDate()}</div>`;
        }
      }
      
      grid.innerHTML = html;
    }
    
    function selectDateRange(dateStr) {
      if (!dateRangeStart || (dateRangeStart && dateRangeEnd)) {
        // Start new range
        dateRangeStart = dateStr;
        dateRangeEnd = null;
      } else {
        // Complete range
        if (dateStr < dateRangeStart) {
          // Swap if end is before start
          dateRangeEnd = dateRangeStart;
          dateRangeStart = dateStr;
        } else {
          dateRangeEnd = dateStr;
        }
      }
      
      renderDateRangeCalendar();
      updateDateRangeDisplay();
    }
    
    function updateDateRangeDisplay() {
      const display = el("date_range_display");
      if (dateRangeStart && dateRangeEnd) {
        const startDate = new Date(dateRangeStart + 'T15:00');
        const endDate = new Date(dateRangeEnd + 'T11:00');
        display.textContent = `${startDate.toLocaleDateString('he-IL')} - ${endDate.toLocaleDateString('he-IL')}`;
        
        // Update hidden inputs
        el("check_in").value = startDate.toISOString().slice(0, 16);
        el("check_out").value = endDate.toISOString().slice(0, 16);
        
        refreshOutputs();
      } else if (dateRangeStart) {
        const startDate = new Date(dateRangeStart + 'T15:00');
        display.textContent = `×-${startDate.toLocaleDateString('he-IL')} - ×‘×—×¨ ×ª××¨×™×š ×¡×™×•×`;
      } else {
        display.textContent = '×‘×—×¨ ×ª××¨×™×›×™×...';
      }
    }
    
    function confirmDateRange() {
      if (dateRangeStart && dateRangeEnd) {
        el("date_range_picker").classList.remove("visible");
        checkAvailability();
      } else {
        alert('×× × ×‘×—×¨ ×ª××¨×™×š ×”×ª×—×œ×” ×•×ª××¨×™×š ×¡×™×•×');
      }
    }
    
    function clearDateRange() {
      dateRangeStart = null;
      dateRangeEnd = null;
      el("check_in").value = '';
      el("check_out").value = '';
      updateDateRangeDisplay();
      renderDateRangeCalendar();
    }
    
    function prevMonthRange() {
      currentCalendarMonth--;
      if (currentCalendarMonth < 0) {
        currentCalendarMonth = 11;
        currentCalendarYear--;
      }
      renderDateRangeCalendar();
    }
    
    function nextMonthRange() {
      currentCalendarMonth++;
      if (currentCalendarMonth > 11) {
        currentCalendarMonth = 0;
        currentCalendarYear++;
      }
      renderDateRangeCalendar();
    }
    
    // Cabin Availability Table Functions
    let availabilityTableTimer = null;
    let currentCabinAvailability = null;
    
    async function showCabinAvailability(cabinId) {
      if (availabilityTableTimer) {
        clearTimeout(availabilityTableTimer);
      }
      
      availabilityTableTimer = setTimeout(async () => {
        try {
          const today = new Date();
          const endDate = new Date(today);
          endDate.setDate(endDate.getDate() + 60);
          
          const response = await fetch(`${API_BASE}/availability?check_in=${today.toISOString().split('T')[0]} 15:00&check_out=${endDate.toISOString().split('T')[0]} 11:00&cabin_id=${encodeURIComponent(cabinId)}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" }
          });
          
          if (!response.ok) return;
          
          const availableCabins = await response.json();
          const cabin = availableCabins.find(c => (c.cabin_id === cabinId || c.cabin_id === cabinId.replace(/-/g, '')));
          
          if (!cabin) {
            // Cabin not available - get calendar to show booked dates
            await loadCabinAvailabilityTable(cabinId, today, endDate);
          } else {
            // Cabin is available - show availability table
            await loadCabinAvailabilityTable(cabinId, today, endDate);
          }
        } catch (error) {
          console.error('Error loading availability:', error);
        }
      }, 300);
    }
    
    async function loadCabinAvailabilityTable(cabinId, startDate, endDate) {
      try {
        // Get calendar events for this cabin
        const response = await fetch(`${API_BASE}/cabin/calendar/${encodeURIComponent(cabinId)}?start_date=${startDate.toISOString().split('T')[0]}&end_date=${endDate.toISOString().split('T')[0]}`);
        
        if (!response.ok) {
          // If endpoint doesn't exist, create simple table from availability check
          renderSimpleAvailabilityTable(cabinId);
          return;
        }
        
        const data = await response.json();
        const bookedDates = new Set(data.booked_dates || []);
        
        // Create table
        const table = el("cabin_availability_table");
        if (!table) {
          // Create table if doesn't exist
          const newTable = document.createElement('div');
          newTable.id = 'cabin_availability_table';
          newTable.className = 'cabin-availability-table';
          document.body.appendChild(newTable);
        }
        
        // Find cabin name
        const cabin = availableCabins.find(c => (c.cabin_id === cabinId || c.cabin_id === cabinId.replace(/-/g, '')));
        const cabinName = cabin ? cabin.name : cabinId;
        
        let html = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h3 style="margin: 0; color: #2196F3;">ğŸ“… ×–××™× ×•×ª: ${cabinName}</h3>
            <button class="btn-danger" onclick="hideCabinAvailability()" style="padding: 6px 12px;">âœ•</button>
          </div>
          <table class="availability-table">
            <thead>
              <tr>
                <th>×ª××¨×™×š</th>
                <th>×™×•×</th>
                <th>×¡×˜×˜×•×¡</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        const today = new Date();
        let current = new Date(startDate);
        
        while (current <= endDate) {
          const dateStr = current.toISOString().split('T')[0];
          const isBooked = bookedDates.has(dateStr);
          const isToday = current.toDateString() === today.toDateString();
          const dayName = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'][current.getDay()];
          
          html += `
            <tr>
              <td class="${isToday ? 'today' : ''}">${current.toLocaleDateString('he-IL')}</td>
              <td class="${isToday ? 'today' : ''}">${dayName}</td>
              <td class="${isBooked ? 'booked' : 'available'}">${isBooked ? 'âŒ ×ª×¤×•×¡' : 'âœ… ×–××™×Ÿ'}</td>
            </tr>
          `;
          
          current.setDate(current.getDate() + 1);
        }
        
        html += `
            </tbody>
          </table>
        `;
        
        el("cabin_availability_table").innerHTML = html;
        el("cabin_availability_table").classList.add("visible");
        currentCabinAvailability = cabinId;
      } catch (error) {
        console.error('Error loading availability table:', error);
        renderSimpleAvailabilityTable(cabinId);
      }
    }
    
    function renderSimpleAvailabilityTable(cabinId) {
      const table = el("cabin_availability_table");
      if (!table) {
        const newTable = document.createElement('div');
        newTable.id = 'cabin_availability_table';
        newTable.className = 'cabin-availability-table';
        document.body.appendChild(newTable);
      }
      
      const cabin = availableCabins.find(c => (c.cabin_id === cabinId || c.cabin_id === cabinId.replace(/-/g, '')));
      const cabinName = cabin ? cabin.name : cabinId;
      
      el("cabin_availability_table").innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <h3 style="margin: 0; color: #2196F3;">ğŸ“… ×–××™× ×•×ª: ${cabinName}</h3>
          <button class="btn-danger" onclick="hideCabinAvailability()" style="padding: 6px 12px;">âœ•</button>
        </div>
        <p>×˜×•×¢×Ÿ × ×ª×•× ×™ ×–××™× ×•×ª...</p>
      `;
      el("cabin_availability_table").classList.add("visible");
    }
    
    function hideCabinAvailability() {
      if (availabilityTableTimer) {
        clearTimeout(availabilityTableTimer);
      }
      
      setTimeout(() => {
        const table = el("cabin_availability_table");
        if (table) {
          table.classList.remove("visible");
        }
        currentCabinAvailability = null;
      }, 200);
    }
    
    function wireInputs() {
      // Date range picker doesn't need event listeners - handled by onclick
      ["adults","kids","area"].forEach(id => {
        const element = el(id);
        // Use 'change' for select, 'input' for text inputs
        const eventType = element.tagName === "SELECT" ? "change" : "input";
        element.addEventListener(eventType, refreshOutputs);
      });
      el("btn_copy").addEventListener("click", copyFeatures);
      el("btn_check_availability").addEventListener("click", checkAvailability);
      el("btn_post").addEventListener("click", checkAvailability); // ×œ×©××™×¨×ª ×ª××™××•×ª
      el("bookingForm").addEventListener("submit", createBooking);
      el("btn_create_hold").addEventListener("click", createHold);
      el("btn_cancel_hold").addEventListener("click", cancelHold);
      el("btn_book_final").addEventListener("click", () => {
        if (selectedCabinId) {
          openBookingModal(selectedCabinId);
        }
      });
      
      // ×¢×“×›×Ÿ quote ×›×©×”×ª××¨×™×›×™× ××©×ª× ×™×
      ["check_in", "check_out", "adults", "kids"].forEach(id => {
        const element = el(id);
        element.addEventListener("change", () => {
          if (selectedCabinId) {
            loadQuote(selectedCabinId);
          }
        });
      });
      
      // ×¢×“×›×Ÿ ××ª ×”-JSON preview ×›×©×”×©×“×•×ª ××©×ª× ×™×
      ["modal_customer", "modal_phone", "modal_email", "modal_notes"].forEach(id => {
        el(id).addEventListener("input", updateBookingJson);
      });
    }

    (async () => {
      wireInputs();
      try {
        const catalog = await loadCatalog();
        renderCatalog(catalog);
      } catch (e) {
        el("resp_preview").textContent = "×œ× × ×˜×¢×Ÿ ×§×˜×œ×•×’: " + (e?.message || e) + "\n\n×”×¢×¨×”: ×¦×¨×™×š ×œ×¤×ª×•×— ××ª ×”×“×£ ×“×¨×š ×©×¨×ª ×©××’×™×© ××ª /data/features_catalog.json";
      }
    })();
  </script>

  <!-- Admin Panel Script -->
  <script>
    // Admin Panel Functions - use API_BASE from main script scope
    const ADMIN_API_BASE = window.API_BASE || 'http://127.0.0.1:8000';
    
    async function showBookingDetails(bookingId) {
      try {
        const apiBase = typeof API_BASE !== 'undefined' ? API_BASE : ADMIN_API_BASE;
        const response = await fetch(`${apiBase}/admin/bookings/${bookingId}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const booking = await response.json();
        
        // Format dates
        const checkIn = booking.check_in ? new Date(booking.check_in).toLocaleDateString('he-IL') : 'N/A';
        const checkOut = booking.check_out ? new Date(booking.check_out).toLocaleDateString('he-IL') : 'N/A';
        const created = booking.created_at ? new Date(booking.created_at).toLocaleString('he-IL') : 'N/A';
        const updated = booking.updated_at ? new Date(booking.updated_at).toLocaleString('he-IL') : 'N/A';
        
        const statusClass = `status-${booking.status || 'pending'}`;
        const canCancel = booking.status !== 'cancelled';
        
        const modal = document.getElementById('bookingDetailModal');
        const content = document.getElementById('bookingDetailContent');
        
        content.innerHTML = `
          <div style="padding: 20px;">
            <h2 style="margin-top: 0; color: #667eea;">×¤×¨×˜×™ ×”×–×× ×”</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
              <div>
                <h3 style="color: #333; margin-bottom: 10px;">××™×“×¢ ×›×œ×œ×™</h3>
                <p><strong>××¡×¤×¨ ×”×–×× ×”:</strong> ${bookingId.substring(0, 8)}...</p>
                <p><strong>×¡×˜×˜×•×¡:</strong> <span class="status-badge ${statusClass}">${booking.status || 'pending'}</span></p>
                <p><strong>×¦×™××¨:</strong> ${booking.cabin_name || 'N/A'}</p>
                <p><strong>××–×•×¨:</strong> ${booking.cabin_area || 'N/A'}</p>
                <p><strong>××—×™×¨ ×›×•×œ×œ:</strong> ${booking.total_price || 0} ILS</p>
              </div>
              
              <div>
                <h3 style="color: #333; margin-bottom: 10px;">×ª××¨×™×›×™×</h3>
                <p><strong>Check-in:</strong> ${checkIn}</p>
                <p><strong>Check-out:</strong> ${checkOut}</p>
                <p><strong>××‘×•×’×¨×™×:</strong> ${booking.adults || 0}</p>
                <p><strong>×™×œ×“×™×:</strong> ${booking.kids || 0}</p>
                <p><strong>× ×•×¦×¨:</strong> ${created}</p>
                <p><strong>×¢×•×“×›×Ÿ:</strong> ${updated}</p>
              </div>
            </div>
            
            <div style="margin-bottom: 20px;">
              <h3 style="color: #333; margin-bottom: 10px;">×¤×¨×˜×™ ×œ×§×•×—</h3>
              <p><strong>×©×:</strong> ${booking.customer_name || 'N/A'}</p>
              <p><strong>××™××™×™×œ:</strong> ${booking.customer_email || 'N/A'}</p>
              <p><strong>×˜×œ×¤×•×Ÿ:</strong> ${booking.customer_phone || 'N/A'}</p>
            </div>
            
            ${booking.event_id ? `
            <div style="margin-bottom: 20px;">
              <h3 style="color: #333; margin-bottom: 10px;">Google Calendar</h3>
              <p><strong>Event ID:</strong> <small>${booking.event_id}</small></p>
              ${booking.event_link ? `<p><a href="${booking.event_link}" target="_blank">×¤×ª×— ×‘×™×•××Ÿ</a></p>` : ''}
            </div>
            ` : ''}
            
            ${booking.payment_intent_id ? `
            <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px;">
              <h3 style="color: #856404; margin-bottom: 10px; margin-top: 0;">ğŸ’³ ×ª×©×œ×•×</h3>
              <p><strong>Payment Intent ID:</strong> <small>${booking.payment_intent_id}</small></p>
              ${booking.client_secret ? `<p><strong>Client Secret:</strong> <code style="font-size: 11px; word-break: break-all;">${booking.client_secret}</code></p>` : ''}
              <p style="color: #856404; font-size: 14px; margin-bottom: 0;">
                âš ï¸ ×ª×©×œ×•× × ×“×¨×© - ×”×©×ª××© ×‘-Client Secret ×¢× Stripe Checkout
              </p>
            </div>
            ` : ''}
            
            ${booking.transactions && booking.transactions.length > 0 ? `
            <div style="margin-bottom: 20px;">
              <h3 style="color: #333; margin-bottom: 10px;">×ª×©×œ×•××™×</h3>
              <table class="admin-table" style="width: 100%;">
                <thead>
                  <tr>
                    <th>×¡×›×•×</th>
                    <th>××˜×‘×¢</th>
                    <th>×¡×˜×˜×•×¡</th>
                    <th>×©×™×˜×ª ×ª×©×œ×•×</th>
                    <th>×ª××¨×™×š</th>
                  </tr>
                </thead>
                <tbody>
                  ${booking.transactions.map(t => `
                    <tr>
                      <td>${t.amount || 0}</td>
                      <td>${t.currency || 'ILS'}</td>
                      <td><span class="status-badge status-${t.status || 'pending'}">${t.status || 'pending'}</span></td>
                      <td>${t.payment_method || 'N/A'}</td>
                      <td><small>${t.created_at ? new Date(t.created_at).toLocaleString('he-IL') : ''}</small></td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            ` : ''}
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              ${canCancel ? `
                <button class="btn-danger" onclick="cancelBooking('${bookingId}')" style="padding: 10px 20px;">
                  ×‘×™×˜×•×œ ×”×–×× ×”
                </button>
              ` : ''}
              <button onclick="closeBookingDetailModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                ×¡×’×•×¨
              </button>
            </div>
          </div>
        `;
        
        modal.style.display = 'block';
      } catch (error) {
        alert(`×©×’×™××” ×‘×˜×¢×™× ×ª ×¤×¨×˜×™ ×”×”×–×× ×”: ${error.message}`);
        console.error('Error loading booking details:', error);
      }
    }
    
    function closeBookingDetailModal() {
      const modal = document.getElementById('bookingDetailModal');
      if (modal) modal.style.display = 'none';
    }
    
    async function cancelBooking(bookingId) {
      if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×‘×˜×œ ××ª ×”×”×–×× ×”? ×¤×¢×•×œ×” ×–×• ×ª××—×§ ××ª ×”××™×¨×•×¢ ×-Google Calendar ×•×ª×¢×“×›×Ÿ ××ª ×”×–××™× ×•×ª.')) {
        return;
      }
      
      try {
        const apiBase = typeof API_BASE !== 'undefined' ? API_BASE : ADMIN_API_BASE;
        const response = await fetch(`${apiBase}/admin/bookings/${bookingId}/cancel`, {
          method: 'POST'
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || `HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        // Close detail modal
        closeBookingDetailModal();
        
        // Reload bookings list
        loadBookings();
        
        // Reload stats
        loadStats();
        
        alert(`×”×”×–×× ×” ×‘×•×˜×œ×” ×‘×”×¦×œ×—×”!${result.calendar_deleted ? ' ×”××™×¨×•×¢ × ××—×§ ×-Google Calendar.' : ' (×”×¢×¨×”: ×œ× ×”×¦×œ×—× ×• ×œ××—×•×§ ××ª ×”××™×¨×•×¢ ×-Google Calendar)'}`);
      } catch (error) {
        alert(`×©×’×™××” ×‘×‘×™×˜×•×œ ×”×”×–×× ×”: ${error.message}`);
        console.error('Error cancelling booking:', error);
      }
    }

    function closeAdminModal() {
      document.getElementById('adminModal').style.display = 'none';
    }

    function switchAdminTab(tab) {
      document.querySelectorAll('.admin-tab-content').forEach(el => el.style.display = 'none');
      document.querySelectorAll('.admin-tab').forEach(el => el.classList.remove('active'));

      const tabContent = document.getElementById(`admin${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
      const tabButton = document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
      
      if (tabContent) tabContent.style.display = 'block';
      if (tabButton) tabButton.classList.add('active');

      if (tab === 'bookings') loadBookings();
      else if (tab === 'audit') loadAuditLog();
      else if (tab === 'stats') loadStats();
      else if (tab === 'faq') loadFaqAndFacts();
    }

    function showBookingsByStatus(status) {
      // Switch to bookings tab and filter
      switchAdminTab('bookings');
      const filterSelect = document.getElementById('bookingStatusFilter');
      if (filterSelect) {
        if (status === 'unpaid') {
          // For unpaid, we need to filter manually
          filterSelect.value = 'confirmed'; // Set to confirmed first
          loadBookings().then(() => {
            // Then filter to show only unpaid
            const container = document.getElementById('bookingsList');
            if (container) {
              const statsData = window.statsData || {};
              const unpaidIds = (statsData.unpaidBookings || []).map(b => {
                return (b.booking_id || b.id || '').toString();
              });
              
              const rows = container.querySelectorAll('tbody tr');
              rows.forEach(row => {
                const onclickAttr = row.getAttribute('onclick') || '';
                const match = onclickAttr.match(/showBookingDetails\(['"]([^'"]+)['"]\)/);
                const bookingId = match ? match[1] : '';
                const isUnpaid = unpaidIds.includes(bookingId);
                row.style.display = isUnpaid ? '' : 'none';
              });
              
              // Update message
              const visibleCount = Array.from(rows).filter(r => r.style.display !== 'none').length;
              if (visibleCount === 0 && rows.length > 0) {
                container.innerHTML = '<p>No unpaid bookings found.</p>';
              }
            }
          });
        } else if (status === 'cancelled') {
          filterSelect.value = 'cancelled';
          loadBookings();
        } else {
          filterSelect.value = status;
          loadBookings();
        }
      }
    }
    
    async function loadBookings() {
      const status = document.getElementById('bookingStatusFilter')?.value || '';
      const apiBase = typeof API_BASE !== 'undefined' ? API_BASE : ADMIN_API_BASE;
      const container = document.getElementById('bookingsList');
      
      try {
        // If filter is "hold", load from /admin/holds instead of bookings
        if (status === 'hold' || status === 'Hold') {
          const response = await fetch(`${apiBase}/admin/holds`);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const holdsData = await response.json();
          const holds = Array.isArray(holdsData.holds) ? holdsData.holds : (Array.isArray(holdsData) ? holdsData : []);
          
          if (holds.length === 0) {
            container.innerHTML = '<p>No holds found.</p>';
            return;
          }

          let html = '<table class="admin-table"><thead><tr>';
          html += '<th>Hold ID</th><th>Cabin ID</th><th>Customer</th><th>Check-in</th><th>Check-out</th>';
          html += '<th>Status</th><th>Expires At</th><th>Created</th><th>Actions</th></tr></thead><tbody>';
          
          holds.forEach(hold => {
            const expiresAt = hold.expires_at ? new Date(hold.expires_at) : null;
            const createdAt = hold.created_at ? new Date(hold.created_at) : null;
            const now = new Date();
            const isExpired = expiresAt && expiresAt < now;
            const minutesLeft = expiresAt && !isExpired ? Math.max(0, Math.floor((expiresAt - now) / 60000)) : 0;
            
            html += `<tr>
              <td><small>${(hold.hold_id || '').substring(0, 8)}...</small></td>
              <td>${hold.cabin_id || 'N/A'}</td>
              <td>${hold.customer_name || 'N/A'}<br><small>${hold.customer_id ? (hold.customer_id.length > 8 ? hold.customer_id.substring(0, 8) + '...' : hold.customer_id) : ''}</small></td>
              <td>${hold.check_in || ''}</td>
              <td>${hold.check_out || ''}</td>
              <td><span class="status-badge ${isExpired ? 'status-expired' : 'status-hold'}">${isExpired ? 'Expired' : `Hold (${minutesLeft}m left)`}</span></td>
              <td><small>${expiresAt && !isNaN(expiresAt.getTime()) ? expiresAt.toLocaleString('he-IL') : 'N/A'}</small></td>
              <td><small>${createdAt && !isNaN(createdAt.getTime()) ? createdAt.toLocaleString('he-IL') : 'N/A'}</small></td>
              <td>
                ${!isExpired ? `<button onclick="approveHold('${hold.hold_id}', '${hold.cabin_id}', '${hold.check_in}', '${hold.check_out}', '${hold.customer_name || ''}')" 
                  style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                  âœ… ××™×©×•×¨ ×•×”×–×× ×”
                </button>` : '<span style="color: #999;">Expired</span>'}
              </td>
            </tr>`;
          });
          
          html += '</tbody></table>';
          container.innerHTML = html;
          return;
        }
        
        // Otherwise, load regular bookings
        const url = `${apiBase}/admin/bookings${status ? `?status=${status}` : ''}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const bookings = await response.json();
        
        if (bookings.length === 0) {
          container.innerHTML = '<p>No bookings found.</p>';
          return;
        }

        let html = '<table class="admin-table"><thead><tr>';
        html += '<th>ID</th><th>Cabin</th><th>Customer</th><th>Check-in</th><th>Check-out</th>';
        html += '<th>Status</th><th>Price</th><th>Event ID</th><th>Created</th></tr></thead><tbody>';
        
        bookings.forEach(booking => {
          const statusClass = `status-${booking.status || 'pending'}`;
          const bookingId = booking.booking_id || booking.id || '';
          html += `<tr style="cursor: pointer;" onclick="showBookingDetails('${bookingId}')" title="×œ×—×¥ ×œ×¤×¨×˜×™×">
            <td>${bookingId.substring(0, 8)}...</td>
            <td>${booking.cabin_name || 'N/A'}</td>
            <td>${booking.customer_name || 'N/A'}<br><small>${booking.customer_email || ''}</small></td>
            <td>${booking.check_in || ''}</td>
            <td>${booking.check_out || ''}</td>
            <td><span class="status-badge ${statusClass}">${booking.status || 'pending'}</span></td>
            <td>${booking.total_price || 0} ILS</td>
            <td><small>${booking.event_id ? booking.event_id.substring(0, 20) + '...' : 'N/A'}</small></td>
            <td><small>${booking.created_at ? new Date(booking.created_at).toLocaleString('he-IL') : ''}</small></td>
          </tr>`;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
      } catch (error) {
        if (container) {
          container.innerHTML = `<p class="err">Error: ${error.message}</p>`;
          console.error('Error loading bookings/holds:', error);
        }
      }
    }

    async function approveHold(holdId, cabinId, checkIn, checkOut, customerName) {
      if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××©×¨ ××ª ×”×”×–×× ×” ×•×œ×™×¦×•×¨ booking?\n\nHold ID: ${holdId.substring(0, 8)}...\nCabin: ${cabinId}\n×ª××¨×™×›×™×: ${checkIn} â†’ ${checkOut}\n×œ×§×•×—: ${customerName || 'N/A'}`)) {
        return;
      }

      try {
        const apiBase = typeof API_BASE !== 'undefined' ? API_BASE : ADMIN_API_BASE;
        
        // Create booking from hold
        const bookingData = {
          cabin_id: cabinId,
          check_in: checkIn,
          check_out: checkOut,
          customer: customerName || '×œ×§×•×—',
          hold_id: holdId
        };

        const response = await fetch(`${apiBase}/book`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(bookingData)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || `HTTP ${response.status}`);
        }

        const result = await response.json();
        alert(`âœ… ×”×–×× ×” × ×•×¦×¨×” ×‘×”×¦×œ×—×”!\n\nBooking ID: ${result.booking_id}\nEvent ID: ${result.event_id || 'N/A'}\n\n×”××™×¨×•×¢ × ×•×¦×¨ ×‘×™×•××Ÿ Google Calendar.`);
        
        // Reload bookings to show the new booking
        loadBookings();
      } catch (error) {
        alert(`âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×”×–×× ×”:\n${error.message}`);
        console.error('Error approving hold:', error);
      }
    }

    async function loadAuditLog() {
      const table = document.getElementById('auditTableFilter')?.value || '';
      const apiBase = typeof API_BASE !== 'undefined' ? API_BASE : ADMIN_API_BASE;
      const url = `${apiBase}/admin/audit${table ? `?table_name=${table}` : ''}`;
      
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const logs = await response.json();
        
        const container = document.getElementById('auditList');
        if (logs.length === 0) {
          container.innerHTML = '<p>No audit logs found.</p>';
          return;
        }

        let html = '<table class="admin-table"><thead><tr>';
        html += '<th>ID</th><th>Table</th><th>Action</th><th>Record ID</th><th>New Values</th><th>Created</th></tr></thead><tbody>';
        
        logs.forEach(log => {
          const newValues = log.new_values ? JSON.stringify(log.new_values, null, 2).substring(0, 100) : 'N/A';
          html += `<tr>
            <td>${(log.audit_id || log.id || '').substring(0, 8)}...</td>
            <td>${log.table_name || ''}</td>
            <td><strong>${log.action || ''}</strong></td>
            <td><small>${(log.record_id || '').substring(0, 8)}...</small></td>
            <td><pre style="font-size: 11px; max-width: 300px; overflow: auto;">${newValues}</pre></td>
            <td><small>${log.created_at ? new Date(log.created_at).toLocaleString('he-IL') : ''}</small></td>
          </tr>`;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
      } catch (error) {
        const container = document.getElementById('auditList');
        if (container) {
          container.innerHTML = `<p class="err">Error: ${error.message}</p>`;
          console.error('Error loading audit log:', error);
        }
      }
    }

    // FAQ & Business Facts Management Functions
    async function loadFaqAndFacts() {
      await Promise.all([
        loadPendingFaqs(),
        loadBusinessFacts()
      ]);
    }

    async function loadPendingFaqs() {
      const apiBase = typeof API_BASE !== 'undefined' ? API_BASE : ADMIN_API_BASE;
      const container = document.getElementById('pendingFaqsList');
      
      try {
        const response = await fetch(`${apiBase}/admin/faq/pending`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        const faqs = data.faqs || [];
        
        if (faqs.length === 0) {
          container.innerHTML = '<p style="color: #666; padding: 20px; text-align: center;">××™×Ÿ FAQs ×××ª×™× ×™× ×œ××™×©×•×¨</p>';
          return;
        }

        let html = '';
        faqs.forEach(faq => {
          const suggestedAt = faq.suggested_at ? new Date(faq.suggested_at).toLocaleString('he-IL') : 'N/A';
          const questionId = `faq_question_${faq.id}`;
          const answerId = `faq_answer_${faq.id}`;
          html += `
            <div id="faq_${faq.id}" style="background: white; border: 2px solid #ff9800; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                <div style="flex: 1;">
                  <strong style="color: #ff9800;">×©××œ×”:</strong>
                  <div style="margin: 5px 0;">
                    <div id="${questionId}_display" style="padding: 8px; background: #fff3cd; border-radius: 4px; min-height: 20px;">${faq.question || 'N/A'}</div>
                    <textarea id="${questionId}_edit" style="display: none; width: 100%; padding: 8px; border: 2px solid #ff9800; border-radius: 4px; min-height: 40px; font-family: inherit;">${faq.question || ''}</textarea>
                  </div>
                  <strong style="color: #ff9800; margin-top: 10px; display: block;">×ª×©×•×‘×” ××•×¦×¢×ª:</strong>
                  <div style="margin: 5px 0;">
                    <div id="${answerId}_display" style="padding: 8px; background: #fff3cd; border-radius: 4px; min-height: 40px; white-space: pre-wrap;">${faq.suggested_answer || faq.answer || 'N/A'}</div>
                    <textarea id="${answerId}_edit" style="display: none; width: 100%; padding: 8px; border: 2px solid #ff9800; border-radius: 4px; min-height: 80px; font-family: inherit;">${faq.suggested_answer || faq.answer || ''}</textarea>
                  </div>
                  <small style="color: #666; margin-top: 10px; display: block;">×”×•×¦×¢ ×‘: ${suggestedAt}</small>
                  <div style="margin-top: 10px; display: flex; gap: 8px;">
                    <button onclick="editFaq('${faq.id}')" 
                            id="edit_btn_${faq.id}"
                            style="padding: 6px 12px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                      âœï¸ ×¢×¨×•×š
                    </button>
                    <button onclick="saveFaqEdit('${faq.id}')" 
                            id="save_btn_${faq.id}"
                            style="display: none; padding: 6px 12px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                      ğŸ’¾ ×©××•×¨
                    </button>
                    <button onclick="cancelFaqEdit('${faq.id}')" 
                            id="cancel_btn_${faq.id}"
                            style="display: none; padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                      âœ• ×‘×™×˜×•×œ
                    </button>
                  </div>
                </div>
                <div style="display: flex; gap: 8px; flex-direction: column;">
                  <button onclick="approveFaq('${faq.id}')" 
                          id="approve_btn_${faq.id}"
                          style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                    âœ… ××™×©×¨
                  </button>
                  <button onclick="rejectFaq('${faq.id}')" 
                          style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                    âŒ ×“×—×”
                  </button>
                </div>
              </div>
            </div>
          `;
        });
        
        container.innerHTML = html;
      } catch (error) {
        container.innerHTML = `<p class="err">Error: ${error.message}</p>`;
        console.error('Error loading pending FAQs:', error);
      }
    }

    function editFaq(faqId) {
      // Show edit mode
      document.getElementById(`faq_question_${faqId}_display`).style.display = 'none';
      document.getElementById(`faq_question_${faqId}_edit`).style.display = 'block';
      document.getElementById(`faq_answer_${faqId}_display`).style.display = 'none';
      document.getElementById(`faq_answer_${faqId}_edit`).style.display = 'block';
      
      // Show/hide buttons
      document.getElementById(`edit_btn_${faqId}`).style.display = 'none';
      document.getElementById(`save_btn_${faqId}`).style.display = 'inline-block';
      document.getElementById(`cancel_btn_${faqId}`).style.display = 'inline-block';
      document.getElementById(`approve_btn_${faqId}`).disabled = true;
    }

    function cancelFaqEdit(faqId) {
      // Hide edit mode
      document.getElementById(`faq_question_${faqId}_display`).style.display = 'block';
      document.getElementById(`faq_question_${faqId}_edit`).style.display = 'none';
      document.getElementById(`faq_answer_${faqId}_display`).style.display = 'block';
      document.getElementById(`faq_answer_${faqId}_edit`).style.display = 'none';
      
      // Show/hide buttons
      document.getElementById(`edit_btn_${faqId}`).style.display = 'inline-block';
      document.getElementById(`save_btn_${faqId}`).style.display = 'none';
      document.getElementById(`cancel_btn_${faqId}`).style.display = 'none';
      document.getElementById(`approve_btn_${faqId}`).disabled = false;
      
      // Reload to reset values
      loadPendingFaqs();
    }

    async function saveFaqEdit(faqId) {
      const question = document.getElementById(`faq_question_${faqId}_edit`).value.trim();
      const answer = document.getElementById(`faq_answer_${faqId}_edit`).value.trim();
      
      if (!question || !answer) {
        alert('×©××œ×” ×•×ª×©×•×‘×” ×”×Ÿ ×©×“×•×ª ×—×•×‘×”');
        return;
      }

      try {
        const apiBase = typeof API_BASE !== 'undefined' ? API_BASE : ADMIN_API_BASE;
        
        // Update FAQ directly in DB
        const response = await fetch(`${apiBase}/admin/faq/${faqId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            question: question,
            answer: answer
          })
        });

        if (!response.ok) {
          let errorDetail = 'Failed to update FAQ';
          try {
            const errorData = await response.json();
            errorDetail = errorData.detail || errorData.message || `HTTP ${response.status}`;
          } catch (e) {
            errorDetail = `HTTP ${response.status}: ${response.statusText}`;
          }
          throw new Error(errorDetail);
        }

        // Update display
        document.getElementById(`faq_question_${faqId}_display`).textContent = question;
        document.getElementById(`faq_answer_${faqId}_display`).textContent = answer;
        
        // Store edited values for approval (if pending)
        window.faqEdits = window.faqEdits || {};
        window.faqEdits[faqId] = { question, answer };
        
        cancelFaqEdit(faqId);
        alert('âœ… ×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×”!');
        
        // Reload FAQs to show updated data
        loadPendingFaqs();
        loadAllFaqs();
      } catch (error) {
        alert(`âŒ ×©×’×™××” ×‘×©××™×¨×”: ${error.message}`);
        console.error('Error saving FAQ edit:', error);
      }
    }

    async function approveFaq(faqId) {
      // Check if there are edits
      const edits = (window.faqEdits || {})[faqId];
      const question = edits ? edits.question : null;
      const answer = edits ? edits.answer : null;
      
      if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××©×¨ FAQ ×–×”?' + (edits ? '\n\n(×”×ª×©×•×‘×” ×ª×™×©××¨ ×¢× ×”×¢×¨×™×›×” ×©×œ×š)' : ''))) {
        return;
      }

      try {
        const apiBase = typeof API_BASE !== 'undefined' ? API_BASE : ADMIN_API_BASE;
        const body = {
          faq_id: faqId,
          approved: true,
          approved_by: 'host' // TODO: Get actual host ID
        };
        
        // If edited, include new question/answer
        if (edits) {
          body.question = question;
          body.answer = answer;
        }
        
        const response = await fetch(`${apiBase}/admin/faq/approve`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ detail: `HTTP ${response.status}` }));
          throw new Error(errorData.detail || errorData.message || `HTTP ${response.status}`);
        }

        const result = await response.json();

        // Clear edits
        if (window.faqEdits) {
          delete window.faqEdits[faqId];
        }

        alert('âœ… FAQ ××•×©×¨ ×‘×”×¦×œ×—×”! ×¢×›×©×™×• ×”×¡×•×›×Ÿ ×™×•×›×œ ×œ×”×©×ª××© ×‘×ª×©×•×‘×” ×–×• ×œ×©××œ×•×ª ×“×•××•×ª.');
        loadPendingFaqs();
        loadAllFaqs(); // Reload all FAQs to show updated status
      } catch (error) {
        const errorMsg = error.message || 'Unknown error';
        alert(`âŒ ×©×’×™××” ×‘××™×©×•×¨ FAQ: ${errorMsg}`);
        console.error('Error approving FAQ:', error);
      }
    }

    async function rejectFaq(faqId) {
      if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×“×—×•×ª FAQ ×–×”? (×¤×¢×•×œ×” ×–×• ×ª××—×§ ××•×ª×•)')) {
        return;
      }

      try {
        const apiBase = typeof API_BASE !== 'undefined' ? API_BASE : ADMIN_API_BASE;
        const response = await fetch(`${apiBase}/admin/faq/approve`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            faq_id: faqId,
            approved: false
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || `HTTP ${response.status}`);
        }

        alert('âœ… FAQ × ×“×—×” ×•× ××—×§');
        loadPendingFaqs();
      } catch (error) {
        alert(`âŒ ×©×’×™××” ×‘×“×—×™×™×ª FAQ: ${error.message}`);
        console.error('Error rejecting FAQ:', error);
      }
    }

    async function loadBusinessFacts() {
      const apiBase = typeof API_BASE !== 'undefined' ? API_BASE : ADMIN_API_BASE;
      const container = document.getElementById('businessFactsList');
      
      try {
        // Load categories from features catalog
        let categoriesMap = {};
        try {
          const catalogRes = await fetch('/data/features_catalog.json');
          if (catalogRes.ok) {
            const catalog = await catalogRes.json();
            catalog.categories.forEach(cat => {
              categoriesMap[cat.id] = cat.label_he || cat.id;
            });
          }
        } catch (e) {
          console.warn('Could not load features catalog:', e);
        }
        
        const response = await fetch(`${apiBase}/admin/business-facts`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        // Use detailed version if available, otherwise fallback to simple
        const factsDetailed = data.facts_detailed || {};
        const facts = data.facts || {};
        
        if (Object.keys(facts).length === 0) {
          container.innerHTML = '<p style="color: #666; padding: 20px; text-align: center;">××™×Ÿ Business Facts</p>';
          return;
        }

        let html = '<table class="admin-table"><thead><tr><th>Key</th><th>Value</th><th>Category</th><th>Actions</th></tr></thead><tbody>';
        
        Object.entries(facts).forEach(([key, value]) => {
          // Get category from detailed data or mapping
          const factDetail = factsDetailed[key];
          let category = factDetail?.category || businessFactsCategories[key] || 'general';
          let categoryLabel = categoriesMap[category] || category;
          
          html += `
            <tr>
              <td><code>${key}</code></td>
              <td>${value}</td>
              <td><small>${categoryLabel}</small></td>
              <td>
                <button onclick="editFact('${key}', '${value.replace(/'/g, "\\'")}', '${category}')" 
                        style="padding: 4px 8px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; margin-right: 4px;">
                  âœï¸ ×¢×¨×•×š
                </button>
                <button onclick="deleteBusinessFact('${key}')" 
                        style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                  ğŸ—‘ï¸ ××—×§
                </button>
              </td>
            </tr>
          `;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
      } catch (error) {
        container.innerHTML = `<p class="err">Error: ${error.message}</p>`;
        console.error('Error loading business facts:', error);
      }
    }

    async function showAddFactModal() {
      // Load categories
      let categoriesMap = {};
      try {
        const catalogRes = await fetch('/data/features_catalog.json');
        if (catalogRes.ok) {
          const catalog = await catalogRes.json();
          catalog.categories.forEach(cat => {
            categoriesMap[cat.id] = cat.label_he || cat.id;
          });
        }
      } catch (e) {
        console.warn('Could not load features catalog:', e);
      }
      
      const key = prompt('×”×–×Ÿ ××¤×ª×— (fact_key):');
      if (!key) return;
      
      const value = prompt('×”×–×Ÿ ×¢×¨×š (fact_value):');
      if (!value) return;
      
      // Show category selection
      const categoryOptions = Object.entries(categoriesMap).map(([id, label]) => `${id} - ${label}`).join('\n');
      const categoryPrompt = `×‘×—×¨ ×§×˜×’×•×¨×™×”:\n${categoryOptions}\n\n×”×–×Ÿ ID ×©×œ ×§×˜×’×•×¨×™×” (××• Enter ×œ×“×™×œ×•×’):`;
      const categoryInput = prompt(categoryPrompt);
      const category = categoryInput ? categoryInput.split(' - ')[0].trim() : null;
      
      addBusinessFact(key, value, category);
    }

    async function editFact(key, currentValue, currentCategory) {
      // Load categories
      let categoriesMap = {};
      try {
        const catalogRes = await fetch('/data/features_catalog.json');
        if (catalogRes.ok) {
          const catalog = await catalogRes.json();
          catalog.categories.forEach(cat => {
            categoriesMap[cat.id] = cat.label_he || cat.id;
          });
        }
      } catch (e) {
        console.warn('Could not load features catalog:', e);
      }
      
      const newValue = prompt(`×¢×¨×•×š ×¢×¨×š ×¢×‘×•×¨ ${key}:`, currentValue);
      if (newValue === null || newValue === currentValue) return;
      
      // Show category selection
      const categoryOptions = Object.entries(categoriesMap).map(([id, label]) => `${id} - ${label}`).join('\n');
      const categoryPrompt = `×¢×¨×•×š ×§×˜×’×•×¨×™×” ×¢×‘×•×¨ ${key}:\n${categoryOptions}\n\n×§×˜×’×•×¨×™×” × ×•×›×—×™×ª: ${currentCategory || 'N/A'}\n×”×–×Ÿ ID ×©×œ ×§×˜×’×•×¨×™×” (××• Enter ×œ×©××™×¨×ª ×”× ×•×›×—×™×ª):`;
      const categoryInput = prompt(categoryPrompt);
      const category = categoryInput ? categoryInput.split(' - ')[0].trim() : currentCategory;
      
      updateBusinessFact(key, newValue, category);
    }

    async function addBusinessFact(key, value, category) {
      try {
        const apiBase = typeof API_BASE !== 'undefined' ? API_BASE : ADMIN_API_BASE;
        const response = await fetch(`${apiBase}/admin/business-facts`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            fact_key: key,
            fact_value: value,
            category: category
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || `HTTP ${response.status}`);
        }

        alert('âœ… Business Fact × ×•×¡×£ ×‘×”×¦×œ×—×”!');
        loadBusinessFacts();
      } catch (error) {
        alert(`âŒ ×©×’×™××” ×‘×”×•×¡×¤×ª Fact: ${error.message}`);
        console.error('Error adding business fact:', error);
      }
    }

    async function updateBusinessFact(key, value, category) {
      try {
        const apiBase = typeof API_BASE !== 'undefined' ? API_BASE : ADMIN_API_BASE;
        const response = await fetch(`${apiBase}/admin/business-facts`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            fact_key: key,
            fact_value: value,
            category: category
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || `HTTP ${response.status}`);
        }

        alert('âœ… Business Fact ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!');
        loadBusinessFacts();
      } catch (error) {
        alert(`âŒ ×©×’×™××” ×‘×¢×“×›×•×Ÿ Fact: ${error.message}`);
        console.error('Error updating business fact:', error);
      }
    }

    async function loadStats() {
      try {
        const apiBase = typeof API_BASE !== 'undefined' ? API_BASE : ADMIN_API_BASE;
        const [bookingsRes, auditRes, holdsRes] = await Promise.all([
          fetch(`${apiBase}/admin/bookings`),
          fetch(`${apiBase}/admin/audit`),
          fetch(`${apiBase}/admin/holds`).catch(() => ({ok: false, json: () => ({holds: [], count: 0})}))
        ]);
        
        if (!bookingsRes.ok) throw new Error(`HTTP ${bookingsRes.status}`);
        if (!auditRes.ok) throw new Error(`HTTP ${auditRes.status}`);
        
        const bookingsData = await bookingsRes.json();
        const auditData = await auditRes.json();
        const holdsData = holdsRes.ok ? await holdsRes.json() : {holds: [], count: 0};
        
        // Ensure bookings and auditLogs are arrays
        const bookings = Array.isArray(bookingsData) ? bookingsData : [];
        const auditLogs = Array.isArray(auditData) ? auditData : [];
        const holds = Array.isArray(holdsData.holds) ? holdsData.holds : [];
        
        // Calculate unpaid bookings (confirmed but no completed transaction)
        const unpaidBookings = bookings.filter(b => {
          if (b.status !== 'confirmed') return false;
          // Check if has completed transaction
          const transactions = b.transactions || [];
          const hasCompletedTransaction = transactions.some(t => t && t.status === 'completed');
          const hasPrice = parseFloat(b.total_price || 0) > 0;
          return hasPrice && !hasCompletedTransaction;
        });
        
        const cancelledBookings = bookings.filter(b => b.status === 'cancelled');
        
        const stats = {
          totalBookings: bookings.length,
          confirmedBookings: bookings.filter(b => b.status === 'confirmed').length,
          holdBookings: holds.length, // Use actual holds count, not bookings with status='hold'
          unpaidBookings: unpaidBookings.length,
          cancelledBookings: cancelledBookings.length,
          totalRevenue: bookings.reduce((sum, b) => {
            const price = parseFloat(b.total_price);
            return sum + (isNaN(price) || !price ? 0 : price);
          }, 0),
          totalAuditLogs: auditLogs.length,
          availabilitySearches: auditLogs.filter(a => a.table_name === 'availability_search').length
        };
        
        // Store for click handlers
        window.statsData = {
          unpaidBookings: unpaidBookings,
          cancelledBookings: cancelledBookings
        };
        
        const html = `
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
            <div class="card" style="cursor: pointer;" onclick="showBookingsByStatus('all')" title="×œ×—×¥ ×œ×¨××•×ª ×›×œ ×”×”×–×× ×•×ª">
              <h3>Total Bookings</h3>
              <p style="font-size: 32px; font-weight: bold; color: #667eea;">${stats.totalBookings}</p>
            </div>
            <div class="card" style="cursor: pointer;" onclick="showBookingsByStatus('confirmed')" title="×œ×—×¥ ×œ×¨××•×ª ×”×–×× ×•×ª ×××•×©×¨×•×ª">
              <h3>Confirmed</h3>
              <p style="font-size: 32px; font-weight: bold; color: #28a745;">${stats.confirmedBookings}</p>
            </div>
            <div class="card" style="cursor: pointer;" onclick="showBookingsByStatus('hold')" title="×œ×—×¥ ×œ×¨××•×ª ×”×–×× ×•×ª ×‘×”××ª× ×”">
              <h3>On Hold</h3>
              <p style="font-size: 32px; font-weight: bold; color: #ffc107;">${stats.holdBookings}</p>
            </div>
            <div class="card" style="cursor: pointer;" onclick="showBookingsByStatus('unpaid')" title="×œ×—×¥ ×œ×¨××•×ª ×”×–×× ×•×ª ×©×œ× ×©×•×œ××•">
              <h3>Unpaid</h3>
              <p style="font-size: 32px; font-weight: bold; color: #dc3545;">${stats.unpaidBookings}</p>
            </div>
            <div class="card" style="cursor: pointer;" onclick="showBookingsByStatus('cancelled')" title="×œ×—×¥ ×œ×¨××•×ª ×”×–×× ×•×ª ×©×‘×•×˜×œ×•">
              <h3>Cancelled</h3>
              <p style="font-size: 32px; font-weight: bold; color: #6c757d;">${stats.cancelledBookings}</p>
            </div>
            <div class="card">
              <h3>Total Revenue</h3>
              <p style="font-size: 32px; font-weight: bold; color: #28a745;">${stats.totalRevenue.toFixed(2)} ILS</p>
            </div>
            <div class="card">
              <h3>Audit Logs</h3>
              <p style="font-size: 32px; font-weight: bold; color: #667eea;">${stats.totalAuditLogs}</p>
            </div>
            <div class="card">
              <h3>Availability Searches</h3>
              <p style="font-size: 32px; font-weight: bold; color: #17a2b8;">${stats.availabilitySearches}</p>
            </div>
          </div>
        `;
        
        const container = document.getElementById('statsContent');
        if (container) container.innerHTML = html;
      } catch (error) {
        const container = document.getElementById('statsContent');
        if (container) {
          container.innerHTML = `<p class="err">Error: ${error.message}</p>`;
          console.error('Error loading stats:', error);
        }
      }
    }

    // Agent Chat Variables
    let currentAgentConversationId = null;
    let agentChatHistory = [];

    // Agent Chat Functions
    function openAgentChatModal() {
      const modal = document.getElementById('agentChatModal');
      if (modal) {
        modal.style.display = 'block';
        // ×× ×™×© conversation_id, ×˜×¢×Ÿ ×”×™×¡×˜×•×¨×™×”
        if (currentAgentConversationId) {
          loadConversationHistory();
        }
      }
    }

    function closeAgentChatModal() {
      document.getElementById('agentChatModal').style.display = 'none';
    }

    async function sendAgentMessage() {
      const messageInput = document.getElementById('agentChatMessage');
      const message = messageInput.value.trim();
      
      if (!message) {
        alert('×× × ×›×ª×•×‘ ×”×•×“×¢×”');
        return;
      }

      // ×‘× ×” context
      const context = {};
      const checkIn = document.getElementById('agentContextCheckIn').value.trim();
      const checkOut = document.getElementById('agentContextCheckOut').value.trim();
      const cabinId = document.getElementById('agentContextCabinId').value.trim();
      const guests = document.getElementById('agentContextGuests').value.trim();

      if (checkIn) context.check_in = checkIn;
      if (checkOut) context.check_out = checkOut;
      if (cabinId) context.cabin_id = cabinId;
      if (guests) context.guests = parseInt(guests);

      // ×”×•×¡×£ ×”×•×“×¢×” ×œ×”×™×¡×˜×•×¨×™×” (user)
      addMessageToHistory('user', message);
      messageInput.value = '';

      // ×”×¦×’ loading
      const loadingId = addMessageToHistory('assistant', 'â³ ××¢×‘×“...', true);

      try {
        const apiBase = typeof API_BASE !== 'undefined' ? API_BASE : ADMIN_API_BASE;
        const requestBody = {
          message: message,
          channel: 'web',
          context: Object.keys(context).length > 0 ? context : null
        };

        // ×× ×™×© conversation_id, ×”×•×¡×£ ××•×ª×•
        if (currentAgentConversationId) {
          requestBody.conversation_id = currentAgentConversationId;
        }

        const response = await fetch(`${apiBase}/agent/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || `HTTP ${response.status}`);
        }

        const result = await response.json();

        // ×©××•×¨ conversation_id
        if (result.conversation_id) {
          currentAgentConversationId = result.conversation_id;
          document.getElementById('currentConversationId').textContent = result.conversation_id.substring(0, 16) + '...';
          document.getElementById('agentChatInfo').style.display = 'block';
        }

        // ×”×¡×¨ loading ×•×”×•×¡×£ ×ª×©×•×‘×”
        removeMessageFromHistory(loadingId);
        addMessageToHistory('assistant', result.answer);

        // ×”×¦×’ ×¤×¨×˜×™ ×ª×’×•×‘×”
        displayAgentResponse(result);

        // ×¨×¢× ×Ÿ ×”×™×¡×˜×•×¨×™×” ××”×©×¨×ª
        setTimeout(() => loadConversationHistory(), 500);

      } catch (error) {
        removeMessageFromHistory(loadingId);
        addMessageToHistory('assistant', `âŒ ×©×’×™××”: ${error.message}`, false, true);
        console.error('Error sending message:', error);
      }
    }

    function addMessageToHistory(role, content, isTemporary = false, isError = false) {
      const historyDiv = document.getElementById('agentChatHistory');
      const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      
      const messageDiv = document.createElement('div');
      messageDiv.id = messageId;
      messageDiv.style.cssText = `
        margin-bottom: 15px;
        padding: 12px;
        border-radius: 8px;
        ${role === 'user' ? 'background: #e3f2fd; margin-right: 20%; text-align: right;' : 'background: #f5f5f5; margin-left: 20%; text-align: left;'}
        ${isError ? 'border: 2px solid #f44336;' : ''}
        ${isTemporary ? 'opacity: 0.7; font-style: italic;' : ''}
      `;
      
      const roleLabel = role === 'user' ? 'ğŸ‘¤ ××ª×”' : 'ğŸ¤– ×¡×•×›×Ÿ';
      messageDiv.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 5px; color: ${role === 'user' ? '#1976d2' : '#4CAF50'};">
          ${roleLabel}
        </div>
        <div style="white-space: pre-wrap; word-wrap: break-word;">${content}</div>
      `;

      // ×× ××™×Ÿ ×”×•×“×¢×•×ª, ×”×¡×¨ ××ª ×”×”×•×“×¢×” ×”×¨×™×§×”
      if (historyDiv.children.length === 1 && historyDiv.children[0].textContent.includes('××™×Ÿ ×”×•×“×¢×•×ª')) {
        historyDiv.innerHTML = '';
      }

      historyDiv.appendChild(messageDiv);
      historyDiv.scrollTop = historyDiv.scrollHeight;

      return messageId;
    }

    function removeMessageFromHistory(messageId) {
      const messageDiv = document.getElementById(messageId);
      if (messageDiv) {
        messageDiv.remove();
      }
    }

    function displayAgentResponse(result) {
      const responseDiv = document.getElementById('agentChatResponse');
      const answerDiv = document.getElementById('agentResponseAnswer');
      
      // Display answer with formatting
      let answerHtml = '';
      const answer = result.answer || '××™×Ÿ ×ª×©×•×‘×”';
      
      // Convert newlines to <br> and preserve formatting, but remove image URLs from text
      let answerText = answer;
      const imageUrlPattern = /ğŸ–¼ï¸\s*(\/zimmers_pic\/[^\s\n<>"]+)/g;
      const imageUrls = [];
      let match;
      while ((match = imageUrlPattern.exec(answer)) !== null) {
        imageUrls.push(match[1]);
      }
      // Remove image URL lines from text
      answerText = answerText.replace(/ğŸ–¼ï¸\s*\/zimmers_pic\/[^\s\n<>"]+/g, '');
      answerHtml = answerText.replace(/\n/g, '<br>');
      
      // Add images if found
      if (imageUrls.length > 0) {
        answerHtml += '<div style="margin-top: 15px; display: flex; gap: 15px; flex-wrap: wrap;">';
        imageUrls.forEach(imgUrl => {
          // Convert relative path to full URL if needed
          let imgSrc = imgUrl;
          if (!imgSrc.startsWith('http')) {
            imgSrc = `http://127.0.0.1:8000${imgSrc}`;
          }
          answerHtml += `<div style="flex: 0 0 auto;">
            <img src="${imgSrc}" alt="×¦×™××¨" 
                 style="max-width: 400px; max-height: 300px; border-radius: 8px; border: 3px solid #4CAF50; box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor: pointer;" 
                 onclick="window.open('${imgSrc}', '_blank')"
                 onerror="this.style.display='none'; console.error('Failed to load image: ${imgSrc}')" />
          </div>`;
        });
        answerHtml += '</div>';
      }
      
      // If we have availability results in metadata, add images
      if (result.context && result.context.availability_results) {
        const cabins = result.context.availability_results;
        cabins.forEach(cabin => {
          if (cabin.images_urls && cabin.images_urls.length > 0) {
            cabin.images_urls.forEach(imgUrl => {
              let imgSrc = imgUrl;
              if (!imgSrc.startsWith('http')) {
                imgSrc = `http://127.0.0.1:8000${imgSrc}`;
              }
              answerHtml += `<div style="margin-top: 15px; padding: 10px; background: white; border-radius: 8px; border: 2px solid #4CAF50;">
                <img src="${imgSrc}" alt="${cabin.name}" style="max-width: 400px; max-height: 300px; border-radius: 6px; margin-bottom: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer;" onclick="window.open('${imgSrc}', '_blank')" onerror="this.style.display='none'" />
                <div><strong>${cabin.name}</strong></div>
                ${cabin.description ? `<div style="font-size: 12px; color: #666; margin-top: 4px;">${cabin.description}</div>` : ''}
              </div>`;
            });
          }
        });
      }
      
      answerDiv.innerHTML = answerHtml;
      document.getElementById('agentResponseActions').textContent = result.actions_suggested && result.actions_suggested.length > 0 
        ? result.actions_suggested.join(', ') 
        : '××™×Ÿ actions';
      document.getElementById('agentResponseConfidence').textContent = 
        (result.confidence ? (result.confidence * 100).toFixed(1) : '0') + '%';
      responseDiv.style.display = 'block';
    }

    async function loadConversationHistory() {
      if (!currentAgentConversationId) {
        return;
      }

      try {
        const apiBase = typeof API_BASE !== 'undefined' ? API_BASE : ADMIN_API_BASE;
        // × ×¡×” ×œ×§×‘×œ ××ª ×”×©×™×—×” ××”-DB (×× ×™×© endpoint)
        // ×‘×™× ×ª×™×™×, ×¨×§ × ×¦×™×’ ××ª ×”×”×™×¡×˜×•×¨×™×” ×”××§×•××™×ª
        // TODO: ×œ×”×•×¡×™×£ endpoint GET /agent/chat/{conversation_id} ×‘×¢×ª×™×“
        
        // × ×¦×™×’ ×”×•×“×¢×” ×©×”×”×™×¡×˜×•×¨×™×” × ×˜×¢× ×”
        const historyDiv = document.getElementById('agentChatHistory');
        if (historyDiv.children.length === 0 || historyDiv.children[0].textContent.includes('××™×Ÿ ×”×•×“×¢×•×ª')) {
          historyDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">××™×Ÿ ×”×•×“×¢×•×ª ×‘×©×™×—×” ×–×•. ×”×ª×—×œ ×œ×›×ª×•×‘...</div>';
        }
      } catch (error) {
        console.error('Error loading conversation history:', error);
      }
    }

    function resetAgentChat() {
      if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××¤×¡ ××ª ×”×¦\'××˜ ×•×œ×”×ª×—×™×œ ×©×™×—×” ×—×“×©×”?')) {
        // Clear conversation ID
        currentAgentConversationId = null;
        
        // Clear history
        const historyDiv = document.getElementById('agentChatHistory');
        historyDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">××™×Ÿ ×”×•×“×¢×•×ª ×¢×“×™×™×Ÿ. ×”×ª×—×œ ×œ×›×ª×•×‘...</div>';
        
        // Clear message input
        document.getElementById('agentChatMessage').value = '';
        
        // Clear context inputs
        document.getElementById('agentContextCheckIn').value = '';
        document.getElementById('agentContextCheckOut').value = '';
        document.getElementById('agentContextCabinId').value = '';
        document.getElementById('agentContextGuests').value = '';
        
        // Clear response display
        document.getElementById('agentResponseAnswer').textContent = '';
        document.getElementById('agentResponseActions').textContent = '';
        document.getElementById('agentResponseConfidence').textContent = '';
        
        // Hide conversation info
        document.getElementById('agentChatInfo').style.display = 'none';
        
        alert('×”×¦\'××˜ ××•×¤×¡. ××ª×” ×™×›×•×œ ×œ×”×ª×—×™×œ ×©×™×—×” ×—×“×©×”.');
      }
    }

    // Initialize admin button and agent chat button
    document.addEventListener('DOMContentLoaded', function() {
      const adminBtn = document.getElementById('adminBtn');
      if (adminBtn) {
        adminBtn.addEventListener('click', () => {
          const modal = document.getElementById('adminModal');
          if (modal) {
            modal.style.display = 'block';
            loadBookings();
          }
        });
      }

      const agentChatBtn = document.getElementById('agentChatBtn');
      if (agentChatBtn) {
        agentChatBtn.addEventListener('click', () => {
          openAgentChatModal();
        });
      }

      // Close modals when clicking outside
      window.onclick = function(event) {
        const adminModal = document.getElementById('adminModal');
        if (event.target == adminModal) {
          adminModal.style.display = 'none';
        }
        const agentChatModal = document.getElementById('agentChatModal');
        if (event.target == agentChatModal) {
          agentChatModal.style.display = 'none';
        }
      }
    });
  </script>

  <!-- Admin Panel Modal -->
  <div id="adminModal" class="modal">
    <div class="modal-content" style="max-width: 1200px; width: 95%;">
      <span class="close" onclick="closeAdminModal()">&times;</span>
      <h2 style="margin-top: 0; color: #667eea;">Admin Panel - Database Content</h2>
      
      <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">
        <button id="tabBookings" class="admin-tab active" onclick="switchAdminTab('bookings')">Bookings</button>
        <button id="tabAudit" class="admin-tab" onclick="switchAdminTab('audit')">Audit Log</button>
        <button id="tabStats" class="admin-tab" onclick="switchAdminTab('stats')">Statistics</button>
        <button id="tabFaq" class="admin-tab" onclick="switchAdminTab('faq')">FAQ & Facts</button>
      </div>

      <div id="adminContent">
        <div id="adminBookings" class="admin-tab-content">
          <h3>All Bookings</h3>
          <div style="margin-bottom: 10px;">
            <label>Filter by Status:</label>
            <select id="bookingStatusFilter" onchange="loadBookings()">
              <option value="">All</option>
              <option value="confirmed">Confirmed</option>
              <option value="hold">Hold</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
          <div id="bookingsList" style="max-height: 500px; overflow-y: auto;">
            <p>Loading...</p>
          </div>
        </div>

        <div id="adminAudit" class="admin-tab-content" style="display: none;">
          <h3>Audit Log (×™×•××Ÿ ×¤×¢×™×œ×•×ª)</h3>
          <p style="color: #666; margin-bottom: 12px; font-size: 14px; background: #f0f0f0; padding: 12px; border-radius: 6px;">
            <strong>××” ×–×” Audit Log?</strong><br/>
            ×™×•××Ÿ ×¤×¢×™×œ×•×ª ×©××ª×¢×“ ××ª ×›×œ ×”×¤×¢×•×œ×•×ª ×‘××¢×¨×›×ª:<br/>
            â€¢ <strong>×—×™×¤×•×©×™ ×–××™× ×•×ª</strong> (Availability Searches) - ×›×œ ×¤×¢× ×©××—×¤×©×™× ×¦×™××¨×™×<br/>
            â€¢ <strong>×™×¦×™×¨×ª ×”×–×× ×•×ª</strong> (Bookings) - ×›×œ ×”×–×× ×” ×©× ×•×¦×¨×ª<br/>
            â€¢ <strong>×¢×“×›×•× ×™× ×•××—×™×§×•×ª</strong> - ×©×™× ×•×™×™× ×‘× ×ª×•× ×™×<br/>
            ×–×” ×¢×•×–×¨ ×œ×¢×§×•×‘ ××—×¨ ×¤×¢×™×œ×•×ª ×”××©×ª××©×™× ×•×œ××ª×¨ ×‘×¢×™×•×ª.
          </p>
          <div style="margin-bottom: 10px;">
            <label>Filter by Table:</label>
            <select id="auditTableFilter" onchange="loadAuditLog()">
              <option value="">All Tables</option>
              <option value="bookings">Bookings</option>
              <option value="availability_search">Availability Searches</option>
            </select>
          </div>
          <div id="auditList" style="max-height: 500px; overflow-y: auto;">
            <p>Loading...</p>
          </div>
        </div>

        <div id="adminStats" class="admin-tab-content" style="display: none;">
          <h3>Statistics</h3>
          <div id="statsContent">
            <p>Loading...</p>
          </div>
        </div>

        <div id="adminFaq" class="admin-tab-content" style="display: none;">
          <h3>FAQ & Business Facts Management</h3>
          
          <!-- Tabs for FAQ and Facts -->
          <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">
            <button id="tabPendingFaq" class="admin-tab active" onclick="switchFaqTab('pending')">â³ Pending FAQs</button>
            <button id="tabAllFaq" class="admin-tab" onclick="switchFaqTab('all')">ğŸ“š All FAQs</button>
            <button id="tabBusinessFacts" class="admin-tab" onclick="switchFaqTab('facts')">ğŸ“‹ Business Facts</button>
          </div>

          <!-- Pending FAQs Section -->
          <div id="pendingFaqSection" style="display: block;">
            <h4 style="color: #ff9800; margin-bottom: 15px;">â³ Pending FAQs (×××ª×™× ×™× ×œ××™×©×•×¨)</h4>
            <div id="pendingFaqsList" style="max-height: 500px; overflow-y: auto;">
              <p>Loading...</p>
            </div>
          </div>

          <!-- All FAQs Section -->
          <div id="allFaqSection" style="display: none;">
            <div style="margin-bottom: 15px;">
              <button onclick="loadAllFaqs()" class="btn-primary" style="padding: 8px 16px; margin-right: 10px;">
                ğŸ”„ ×¨×¢× ×Ÿ
              </button>
            </div>
            <h4 style="color: #4CAF50; margin-bottom: 15px;">ğŸ“š All FAQs (×›×œ ×”×©××œ×•×ª ×•×”×ª×©×•×‘×•×ª)</h4>
            <div id="allFaqsList" style="max-height: 500px; overflow-y: auto;">
              <p>Loading...</p>
            </div>
          </div>

          <!-- Business Facts Section -->
          <div id="businessFactsSection" style="display: none;">
            <div style="margin-bottom: 15px;">
              <button onclick="loadBusinessFacts()" class="btn-primary" style="padding: 8px 16px; margin-right: 10px;">
                ğŸ”„ ×¨×¢× ×Ÿ
              </button>
              <button onclick="showAddFactModal()" class="btn-success" style="padding: 8px 16px;">
                â• ×”×•×¡×£ Fact ×—×“×©
              </button>
            </div>
            <h4 style="color: #2196F3; margin-bottom: 15px;">ğŸ“‹ Business Facts (×¢×•×‘×“×•×ª ×¢×¡×§×™×•×ª)</h4>
            <div id="businessFactsList" style="max-height: 500px; overflow-y: auto;">
              <p>Loading...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    .admin-tab {
      padding: 10px 20px;
      background: #f0f0f0;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    .admin-tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .admin-tab-content {
      margin-top: 20px;
    }
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }
    .admin-table th,
    .admin-table td {
      padding: 10px;
      text-align: right;
      border-bottom: 1px solid #ddd;
    }
    .admin-table th {
      background: #f8f9fa;
      font-weight: bold;
      position: sticky;
      top: 0;
    }
    .admin-table tr:hover {
      background: #f8f9fa;
    }
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
    }
    .status-confirmed { background: #d4edda; color: #155724; }
    .status-hold { background: #fff3cd; color: #856404; }
    .status-expired { background: #f8d7da; color: #721c24; }
    .status-cancelled { background: #f8d7da; color: #721c24; }
    .status-pending { background: #d1ecf1; color: #0c5460; }
    .btn-danger {
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-danger:hover {
      background: #c82333;
    }
  </style>

  <!-- Booking Detail Modal -->
  <div id="bookingDetailModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 900px; width: 95%;">
      <span class="close" onclick="closeBookingDetailModal()">&times;</span>
      <div id="bookingDetailContent">
        <p>×˜×•×¢×Ÿ...</p>
      </div>
    </div>
  </div>

  <!-- Agent Chat Modal -->
  <div id="agentChatModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 100%; width: 100%; height: 100vh; max-height: 100vh; margin: 0; border-radius: 0; overflow-y: auto;">
      <span class="close" onclick="closeAgentChatModal()">&times;</span>
      <h2 style="margin-top: 0; color: #4CAF50;">ğŸ¤– Agent Chat - ×©×™×—×” ×¢× ×”×¡×•×›×Ÿ</h2>
      
      <!-- ×”×¡×‘×¨ ×¢×œ ×”×™×›×•×œ×•×ª -->
      <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #4CAF50;">
        <h3 style="margin-top: 0; color: #2e7d32;">ğŸ“š ××™×š ×–×” ×¢×•×‘×“?</h3>
        <ul style="margin: 10px 0; padding-right: 20px; color: #333;">
          <li><strong>×©××œ×•×ª ×•×ª×©×•×‘×•×ª:</strong> ×›×ª×•×‘ ×©××œ×” ×‘×¢×‘×¨×™×ª ××• ×× ×’×œ×™×ª, ×”×¡×•×›×Ÿ ×™×–×”×” ××ª ×”×›×•×•× ×” ×•×™×¢× ×”</li>
          <li><strong>×©××™×¨×” ×‘-DB:</strong> ×›×œ ×©×™×—×” × ×©××¨×ª ×‘-<code>conversations</code> ×•×›×œ ×”×•×“×¢×” ×‘-<code>messages</code></li>
          <li><strong>×–×™×”×•×™ ×›×•×•× ×•×ª:</strong> ×”×¡×•×›×Ÿ ××–×”×” ×× ××ª×” ××—×¤×© ×–××™× ×•×ª, ××—×™×¨, ××• ×¨×•×¦×” ×œ×”×–××™×Ÿ</li>
          <li><strong>×—×™×‘×•×¨ ×œ×›×œ×™×:</strong> ×”×¡×•×›×Ÿ ×™×›×•×œ ×œ×§×¨×•× ×œ×›×œ×™× (availability, quote, hold) ×× ×™×© context (×ª××¨×™×›×™×, cabin_id)</li>
          <li><strong>Business Facts:</strong> ×”×¡×•×›×Ÿ ×¢×•× ×” ××ª×•×š ×¢×•×‘×“×•×ª ×¢×¡×§×™×•×ª (×©×¢×•×ª ×¦'×§ ××™×Ÿ/×××•×˜, ××“×™× ×™×•×ª ×‘×™×˜×•×œ, ×•×›×•')</li>
          <li><strong>FAQ ×××•×©×¨:</strong> ×”×¡×•×›×Ÿ ××—×¤×© FAQ ×××•×©×¨ ×œ×¤× ×™ ×ª×©×•×‘×”. ×ª×©×•×‘×•×ª ×—×“×©×•×ª ××¡×•×× ×•×ª ×›-"××•×¦×¢" ×œ××™×©×•×¨ Host</li>
        </ul>
        <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 6px; border: 1px solid #ffc107;">
          <strong>ğŸ’¡ ×˜×™×¤:</strong> × ×¡×” ×©××œ×•×ª ×›××• "××” ×”×–××™× ×•×ª?", "×›××” ×¢×•×œ×” ZB01?", "×× ×™ ×¨×•×¦×” ×œ×©×¨×™×™×Ÿ ×¦×™××¨"
          <br/>×›×“×™ ×©×”×¡×•×›×Ÿ ×™×§×¨× ×œ×›×œ×™×, ×”×•×¡×£ context (×ª××¨×™×›×™×, cabin_id) ×‘×ª×—×ª×™×ª ×”×˜×•×¤×¡
        </div>
      </div>

      <!-- ××™×“×¢ ×¢×œ ×”×©×™×—×” ×”× ×•×›×—×™×ª -->
      <div id="agentChatInfo" style="background: #f5f5f5; padding: 12px; border-radius: 6px; margin-bottom: 15px; display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
          <div>
            <strong>Conversation ID:</strong> <code id="currentConversationId" style="font-size: 11px; background: white; padding: 4px 8px; border-radius: 4px;"></code>
          </div>
          <div>
            <strong>Channel:</strong> <span id="currentChannel">web</span>
          </div>
          <div style="display: flex; gap: 8px;">
            <button onclick="loadConversationHistory()" style="padding: 6px 12px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
              ğŸ”„ ×¨×¢× ×Ÿ ×”×™×¡×˜×•×¨×™×”
            </button>
            <button onclick="resetAgentChat()" style="padding: 6px 12px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
              ğŸ—‘ï¸ ××™×¤×•×¡ ×¦'××˜
            </button>
          </div>
        </div>
      </div>

      <!-- ×”×™×¡×˜×•×¨×™×™×ª ×©×™×—×” -->
      <div id="agentChatHistory" style="background: white; border: 2px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; max-height: 400px; overflow-y: auto;">
        <div style="text-align: center; color: #666; padding: 20px;">
          ××™×Ÿ ×”×•×“×¢×•×ª ×¢×“×™×™×Ÿ. ×”×ª×—×œ ×œ×›×ª×•×‘...
        </div>
      </div>

      <!-- ×˜×•×¤×¡ ×›×ª×™×‘×ª ×”×•×“×¢×” -->
      <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; border: 2px solid #4CAF50;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #2e7d32;">ğŸ’¬ ×›×ª×•×‘ ×”×•×“×¢×”:</label>
        <textarea id="agentChatMessage" 
                  placeholder="×œ×“×•×’××”: ××” ×”×–××™× ×•×ª ×‘×ª××¨×™×›×™× 15-17 ×‘××¨×¥? ××•: ×›××” ×¢×•×œ×” ×¦×™××¨ ZB01?"
                  style="width: 100%; min-height: 80px; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; font-family: inherit; resize: vertical;"
                  onkeydown="if(event.key === 'Enter' && event.ctrlKey) sendAgentMessage()"></textarea>
        <div style="margin-top: 8px; font-size: 12px; color: #666;">
          ğŸ’¡ Ctrl+Enter ×œ×©×œ×™×—×” ××”×™×¨×”
        </div>

        <!-- Context (×ª××¨×™×›×™×, cabin_id) -->
        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #ddd;">
          <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #2e7d32;">ğŸ“‹ Context (××•×¤×¦×™×•× ×œ×™ - ×¢×•×–×¨ ×œ×¡×•×›×Ÿ ×œ×§×¨×•× ×œ×›×œ×™×):</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
            <div>
              <label style="font-size: 12px; color: #666;">Check-in (YYYY-MM-DD):</label>
              <input type="text" id="agentContextCheckIn" placeholder="2026-01-20" 
                     style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" />
            </div>
            <div>
              <label style="font-size: 12px; color: #666;">Check-out (YYYY-MM-DD):</label>
              <input type="text" id="agentContextCheckOut" placeholder="2026-01-22" 
                     style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" />
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div>
              <label style="font-size: 12px; color: #666;">Cabin ID (ZB01, ZB02, etc.):</label>
              <input type="text" id="agentContextCabinId" placeholder="ZB01" 
                     style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" />
            </div>
            <div>
              <label style="font-size: 12px; color: #666;">××¡×¤×¨ ××•×¨×—×™×:</label>
              <input type="number" id="agentContextGuests" placeholder="2" min="1" 
                     style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" />
            </div>
          </div>
        </div>

        <button onclick="sendAgentMessage()" 
                style="width: 100%; margin-top: 15px; padding: 12px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; box-shadow: 0 2px 6px rgba(76, 175, 80, 0.3);">
          ğŸ“¤ ×©×œ×— ×”×•×“×¢×”
        </button>
      </div>

      <!-- ×ª×¦×•×’×ª ×ª×©×•×‘×” ××¤×•×¨×˜×ª -->
      <div id="agentChatResponse" style="display: none; margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; border: 2px solid #2196F3;">
        <h3 style="margin-top: 0; color: #1976d2;">ğŸ“Š ×¤×¨×˜×™ ×”×ª×’×•×‘×”:</h3>
        <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
          <strong>×ª×©×•×‘×”:</strong>
          <div id="agentResponseAnswer" style="margin-top: 5px; padding: 10px; background: #f5f5f5; border-radius: 4px; white-space: pre-wrap;"></div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <div style="background: white; padding: 10px; border-radius: 6px;">
            <strong>Actions Suggested:</strong>
            <div id="agentResponseActions" style="margin-top: 5px; color: #2196F3;"></div>
          </div>
          <div style="background: white; padding: 10px; border-radius: 6px;">
            <strong>Confidence:</strong>
            <div id="agentResponseConfidence" style="margin-top: 5px; color: #4CAF50; font-weight: bold;"></div>
          </div>
        </div>
      </div>

      <!-- ××™×“×¢ ×¢×œ ×©××™×¨×” ×‘-DB -->
      <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border: 2px solid #ffc107;">
        <h3 style="margin-top: 0; color: #856404;">ğŸ’¾ ××™×¤×” ×–×” × ×©××¨?</h3>
        <ul style="margin: 10px 0; padding-right: 20px; color: #856404;">
          <li><strong>conversations:</strong> ×›×œ ×©×™×—×” × ×©××¨×ª ×¢× customer_id, channel, status</li>
          <li><strong>messages:</strong> ×›×œ ×”×•×“×¢×” (user/assistant) × ×©××¨×ª ×¢× role, content, metadata</li>
          <li><strong>audit_log:</strong> ×›×œ ×¤×¢×•×œ×” × ×¨×©××ª ×‘-audit log</li>
        </ul>
        <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 4px;">
          <strong>ğŸ” ×œ×‘×“×™×§×” ×‘-DB:</strong> ×¤×ª×— Admin Panel â†’ Audit Log â†’ ×—×¤×© table_name = "conversations" ××• "messages"
        </div>
      </div>

      <!-- ××™×“×¢ ×¢×œ FAQ ×•-Business Facts -->
      <div style="margin-top: 15px; padding: 15px; background: #e8f5e9; border-radius: 8px; border: 2px solid #4CAF50;">
        <h3 style="margin-top: 0; color: #2e7d32;">âœ… FAQ & Business Facts (×©×œ×‘ A4 ×”×•×©×œ×):</h3>
        <ul style="margin: 10px 0; padding-right: 20px; color: #2e7d32;">
          <li><strong>Business Facts:</strong> ×”×¡×•×›×Ÿ ×¢×•× ×” ××ª×•×š ×¢×•×‘×“×•×ª ×¢×¡×§×™×•×ª (×©×¢×•×ª ×¦'×§ ××™×Ÿ/×××•×˜, ××“×™× ×™×•×ª ×‘×™×˜×•×œ, ×—× ×™×”, ×—×™×•×ª ××—××“, ×›×©×¨×•×ª, WiFi)</li>
          <li><strong>FAQ ×××•×©×¨:</strong> ×”×¡×•×›×Ÿ ××—×¤×© FAQ ×××•×©×¨ ×œ×¤× ×™ ×ª×©×•×‘×”. ×× ×œ× × ××¦×, ×”×•× ×¢×•× ×” ×•××¡××Ÿ ×›-"××•×¦×¢"</li>
          <li><strong>× ×™×”×•×œ:</strong> ×¤×ª×— Admin Panel â†’ FAQ & Facts ×›×“×™ ×œ××©×¨/×œ×“×—×•×ª FAQs ×•×œ× ×”×œ Business Facts</li>
        </ul>
        <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 4px;">
          <strong>ğŸ’¡ ×“×•×’×××•×ª ×œ×©××œ×•×ª:</strong>
          <ul style="margin: 5px 0; padding-right: 20px; font-size: 13px;">
            <li>"××” ×©×¢×•×ª ×”×¦×§ ××™×Ÿ?" â†’ ×ª×©×•×‘×” ×-Business Facts</li>
            <li>"××” ×©×¢×•×ª ×”×¦×§ ×××•×˜?" â†’ ×ª×©×•×‘×” ×-Business Facts</li>
            <li>×©××œ×” ×›×œ×œ×™×ª â†’ Agent ×¢×•× ×” ×•××¦×™×¢ ×›-FAQ ×œ××™×©×•×¨</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

</body>
</html>